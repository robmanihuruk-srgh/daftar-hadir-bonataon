
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onValue, set, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
    authDomain: "bonataon-2026.firebaseapp.com",
    databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "bonataon-2026",
    storageBucket: "bonataon-2026.firebasestorage.app",
    messagingSenderId: "392578784070",
    appId: "1:392578784070:web:f85870afad7f202a592347"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Application State
let state = {
    participants: [],
    attendance: [],
    gifts: [],
    staff: [],
    tab: 'register',
    scanner: null,
    isAdmin: false,
    isStaff: false,
    adminPass: "123456",
    recoveryKey: "BONA2026",
    activeUser: null,
    tempUser: null,
    reportSearch: "",
    adminSearch: "",
    filterStatus: "Semua",
    charts: {}
};

// --- CORE FUNCTIONS ---

const showToast = (title, body) => {
    const container = document.getElementById('notification-container');
    const toast = document.createElement('div');
    toast.className = 'toast-notif glass-panel p-4 rounded-2xl shadow-xl flex items-center gap-4 border-l-4 border-emerald-500';
    toast.innerHTML = `
        <div class="w-10 h-10 bg-emerald-500 text-white rounded-xl flex items-center justify-center flex-shrink-0">
            <i class="fas fa-bell"></i>
        </div>
        <div>
            <div class="text-xs font-black text-slate-800 uppercase">${title}</div>
            <div class="text-[10px] text-slate-500 font-bold mt-0.5">${body}</div>
        </div>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(20px)';
        toast.style.transition = '0.4s';
        setTimeout(() => toast.remove(), 400);
    }, 4000);
};

const closeModal = (id) => {
    const el = document.getElementById(id);
    if(el) el.classList.add('hidden');
};

const openModal = (htmlContent, id = 'dynamicModal') => {
    const container = document.getElementById('modal-container');
    container.innerHTML = `
        <div id="${id}" class="fixed inset-0 z-[9000] flex items-center justify-center p-6">
            <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-sm" onclick="document.getElementById('${id}').classList.add('hidden')"></div>
            <div class="bg-white rounded-[2.5rem] w-full max-w-md relative z-10 p-8 shadow-2xl animate-[modalUp_0.4s]">
                ${htmlContent}
            </div>
        </div>
    `;
};

// --- DATA HANDLERS ---

const updateDashboard = () => {
    // Fix: Type 'number' is not assignable to type 'string' (lines 82-84)
    const statRegistered = document.getElementById('statRegistered');
    if (statRegistered) statRegistered.innerText = state.participants.length.toString();
    const statPresent = document.getElementById('statPresent');
    if (statPresent) statPresent.innerText = state.attendance.length.toString();
    const statGifts = document.getElementById('statGifts');
    if (statGifts) statGifts.innerText = state.gifts.length.toString();
    
    if(state.tab === 'register') renderParticipantList();
    if(state.tab === 'report') renderLiveReport();
    if(state.tab === 'data') renderAdminPanel();
    
    document.getElementById('loading').classList.add('hidden');
};

const renderParticipantList = () => {
    const area = document.getElementById('content-area');
    const recent = state.participants.slice(-8).reverse();
    
    const listHtml = recent.map(p => `
        <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100 mb-2 animate-[modalUp_0.3s]">
            <div>
                <div class="font-black text-xs text-slate-800 uppercase">${p.name}</div>
                <div class="text-[8px] font-bold text-slate-400 uppercase mt-0.5">${p.marga}</div>
            </div>
            <div class="text-[9px] font-black bg-emerald-50 text-emerald-700 px-3 py-1 rounded-full border border-emerald-100">${p.status}</div>
        </div>
    `).join('');

    area.innerHTML = `
        <div class="bg-white rounded-[2rem] p-8 shadow-xl mb-8 border border-slate-100">
            <h3 class="text-xl font-black text-slate-800 royal-font uppercase mb-8">Pendaftaran Baru</h3>
            <div class="space-y-4">
                <input id="inName" type="text" class="w-full bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none transition-all" placeholder="NAMA LENGKAP">
                <div class="grid grid-cols-2 gap-4">
                    <select id="inStatus" class="bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none">
                        <option value="Orangtua">Orangtua</option><option value="Pemuda">Pemuda</option><option value="Sekolah Minggu">Sekolah Minggu</option><option value="Tamu">Tamu</option>
                    </select>
                    <select id="inMarga" class="bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none">
                        <option value="Manihuruk">Manihuruk</option><option value="Boru">Boru</option><option value="Bere">Bere</option>
                    </select>
                </div>
                <input id="inPass" type="password" maxlength="8" class="w-full bg-slate-50 p-4 rounded-2xl font-bold text-center text-2xl tracking-[0.5em] outline-none border-2 border-transparent focus:border-emerald-500" placeholder="••••••••">
                <button id="btnReg" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-emerald-700 transition-all uppercase tracking-widest mt-2">Daftar Sekarang</button>
            </div>
        </div>
        <div class="px-2">
            <h5 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Pendaftar Terakhir (Total: ${state.participants.length})</h5>
            ${listHtml || '<div class="text-center py-10 text-slate-300 font-black text-[10px] uppercase">Belum ada pendaftar</div>'}
        </div>
    `;

    document.getElementById('btnReg').onclick = handleRegister;
};

const handleRegister = () => {
    // Fix: Property 'value' does not exist on type 'HTMLElement' (lines 134-137)
    const name = (document.getElementById('inName') as HTMLInputElement).value.trim().toUpperCase();
    const status = (document.getElementById('inStatus') as HTMLSelectElement).value;
    const marga = (document.getElementById('inMarga') as HTMLSelectElement).value;
    const pass = (document.getElementById('inPass') as HTMLInputElement).value;

    if(!name || pass.length < 6) return alert("Harap isi Nama dan PIN (Min. 6 Digit)!");

    const code = `MN-${Date.now().toString().slice(-8)}`;
    const data = { name, status, marga, password: pass, qrCode: code, registeredAt: new Date().toLocaleString() };

    push(ref(db, 'participants'), data).then(() => {
        showToast("Berhasil!", `${name} telah terdaftar.`);
        showTicket(data);
        renderParticipantList();
    });
};

const showTicket = async (user) => {
    state.activeUser = user;
    const html = `
        <div id="vipTicketCard" class="vip-ticket rounded-[2.5rem] p-8 text-center text-white overflow-hidden relative">
            <div class="relative z-10">
                <img src="logo tugu manihuruk.png" class="w-16 h-16 mx-auto mb-4 bg-white p-2 rounded-xl">
                <div class="text-[9px] font-black text-emerald-400 tracking-[0.3em] mb-1">OFFICIAL INVITATION</div>
                <h2 class="royal-font text-2xl gold-text mb-6">BONATAON 2026</h2>
                <div class="mb-8">
                    <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Tamu Kehormatan</div>
                    <div class="text-xl font-black uppercase tracking-tight">${user.name}</div>
                    <div class="text-[8px] text-emerald-500 font-black mt-1 uppercase">${user.marga} • ${user.status}</div>
                </div>
                <div class="bg-white p-6 rounded-3xl relative">
                    <div id="qrPlaceholder" class="w-40 h-40 mx-auto flex items-center justify-center text-slate-200">
                        <i class="fas fa-circle-notch fa-spin text-2xl"></i>
                    </div>
                    <img id="ticketQR" class="w-40 h-40 mx-auto hidden rounded-lg">
                    <div class="mt-4 text-slate-900">
                        <div class="text-[8px] font-bold text-slate-400 uppercase">Registration Code</div>
                        <div class="font-mono font-black text-lg">${user.qrCode}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 flex flex-col gap-3">
            <button id="btnEditSelf" class="w-full bg-amber-500 text-white font-black py-4 rounded-2xl text-xs uppercase tracking-widest shadow-lg"><i class="fas fa-user-edit mr-2"></i> Perbaiki Profil</button>
            <button id="btnDlTicket" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl text-xs uppercase tracking-widest shadow-lg"><i class="fas fa-download mr-2"></i> Simpan ke Galeri</button>
            <button onclick="document.getElementById('ticketModal').classList.add('hidden')" class="text-slate-400 font-black text-[9px] py-2 uppercase tracking-widest">Tutup</button>
        </div>
    `;
    openModal(html, 'ticketModal');
    
    // Fix: Property 'src' does not exist on type 'HTMLElement' (line 188)
    const qrImg = document.getElementById('ticketQR') as HTMLImageElement;
    const qrPlaceholder = document.getElementById('qrPlaceholder');
    try {
        // Fix: Cannot find name 'QRCode' (line 187)
        const url = await (window as any).QRCode.toDataURL(user.qrCode, { margin: 1, width: 400 });
        qrImg.src = url;
        qrImg.onload = () => { qrPlaceholder.classList.add('hidden'); qrImg.classList.remove('hidden'); };
    } catch(e) { console.error(e); }

    document.getElementById('btnEditSelf').onclick = () => openEditModal(user);
    document.getElementById('btnDlTicket').onclick = downloadTicket;
};

const openEditModal = (user) => {
    closeModal('ticketModal');
    const html = `
        <h3 class="text-xl font-black text-slate-800 royal-font uppercase mb-6">Edit Profil</h3>
        <div class="space-y-4">
            <input id="editName" type="text" value="${user.name}" class="w-full bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none">
            <div class="grid grid-cols-2 gap-4">
                <select id="editStatus" class="bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none">
                    <option value="Orangtua" ${user.status==='Orangtua'?'selected':''}>Orangtua</option>
                    <option value="Pemuda" ${user.status==='Pemuda'?'selected':''}>Pemuda</option>
                    <option value="Sekolah Minggu" ${user.status==='Sekolah Minggu'?'selected':''}>Sekolah Minggu</option>
                    <option value="Tamu" ${user.status==='Tamu'?'selected':''}>Tamu</option>
                </select>
                <select id="editMarga" class="bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none">
                    <option value="Manihuruk" ${user.marga==='Manihuruk'?'selected':''}>Manihuruk</option>
                    <option value="Boru" ${user.marga==='Boru'?'selected':''}>Boru</option>
                    <option value="Bere" ${user.marga==='Bere'?'selected':''}>Bere</option>
                </select>
            </div>
            <input id="editPass" type="password" maxlength="8" value="${user.password}" class="w-full bg-slate-50 p-4 rounded-2xl font-bold text-center text-2xl tracking-[0.5em] outline-none border-2 border-transparent focus:border-emerald-500">
            <button id="btnSaveEdit" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl shadow-lg text-xs uppercase tracking-widest mt-4">Simpan Perubahan</button>
        </div>
    `;
    openModal(html, 'editUserModal');
    document.getElementById('btnSaveEdit').onclick = () => {
        // Fix: Property 'value' does not exist on type 'HTMLElement' (lines 221-224)
        const name = (document.getElementById('editName') as HTMLInputElement).value.trim().toUpperCase();
        const status = (document.getElementById('editStatus') as HTMLSelectElement).value;
        const marga = (document.getElementById('editMarga') as HTMLSelectElement).value;
        const password = (document.getElementById('editPass') as HTMLInputElement).value;
        if(!name || password.length < 6) return alert("Validasi Gagal!");
        
        update(ref(db, 'participants/' + user.firebaseId), { name, status, marga, password }).then(() => {
            showToast("Berhasil", "Data Anda diperbarui.");
            closeModal('editUserModal');
            showTicket({...user, name, status, marga, password});
        });
    };
};

const downloadTicket = () => {
    const card = document.getElementById('vipTicketCard');
    // Fix: Cannot find name 'html2canvas' (line 237)
    (window as any).html2canvas(card, { scale: 2, backgroundColor: '#0f172a' }).then(canvas => {
        const link = document.createElement('a');
        link.download = `Tiket_Bonataon_${state.activeUser.name}.png`;
        link.href = canvas.toDataURL();
        link.click();
    });
};

// --- ADMIN & STAFF LOGIC ---

const renderAdminLogin = () => {
    const html = `
        <div class="text-center mb-8">
            <div class="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-4"><i class="fas fa-lock text-3xl"></i></div>
            <h3 class="text-xl font-black text-slate-800 royal-font uppercase">Akses Panitia</h3>
        </div>
        <input id="adminIn" type="password" maxlength="12" class="w-full bg-slate-50 p-5 rounded-2xl font-bold text-center text-3xl tracking-[0.4em] outline-none border-2 border-transparent focus:border-emerald-500 mb-6" placeholder="••••••">
        <button id="btnLogin" class="w-full bg-emerald-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase tracking-widest">Masuk</button>
        <div class="mt-6 text-center">
            <button id="btnForgotAdmin" class="text-[10px] font-black text-emerald-600 uppercase tracking-widest underline">Lupa PIN?</button>
        </div>
    `;
    openModal(html, 'adminModal');
    document.getElementById('btnLogin').onclick = () => {
        // Fix: Property 'value' does not exist on type 'HTMLElement' (line 261)
        const p = (document.getElementById('adminIn') as HTMLInputElement).value;
        if(p === state.adminPass) {
            state.isAdmin = true; state.isStaff = false;
            closeModal('adminModal');
            refreshUI();
            setTab('report');
        } else {
            const staff = state.staff.find(s => s.pin === p);
            if(staff) {
                state.isStaff = true; state.isAdmin = false;
                closeModal('adminModal');
                refreshUI();
                setTab('scan');
            } else { alert("PIN Salah!"); }
        }
    };
    document.getElementById('btnForgotAdmin').onclick = () => {
        const key = prompt("Masukkan Kode Pemulihan:");
        if(key === state.recoveryKey) {
            const newPin = prompt("Masukkan PIN Admin Baru (Min 6 digit):");
            if(newPin && newPin.length >= 6) {
                set(ref(db, 'settings/adminPin'), newPin).then(() => alert("PIN Diperbarui!"));
            }
        } else { alert("Kode Salah!"); }
    };
};

const refreshUI = () => {
    const roleBadge = document.getElementById('roleBadge');
    const navItems = document.querySelectorAll('.nav-btn');
    const logoutBtn = document.getElementById('nav-logout');

    if(state.isAdmin || state.isStaff) {
        roleBadge.classList.remove('hidden');
        roleBadge.innerText = state.isAdmin ? "Administrator" : "Petugas Lapangan";
        logoutBtn.classList.remove('hidden');
    } else {
        roleBadge.classList.add('hidden');
        logoutBtn.classList.add('hidden');
    }

    navItems.forEach(btn => {
        if(state.isAdmin) btn.classList.remove('hidden');
        else if(state.isStaff) {
            if(btn.classList.contains('staff-tab') || btn.classList.contains('public-tab')) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        } else {
            if(btn.classList.contains('public-tab')) btn.classList.remove('hidden');
            else btn.classList.add('hidden');
        }
    });
};

const renderLiveReport = () => {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-[modalUp_0.4s]">
            <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Demografi Kategori</h4>
                <div class="h-64"><canvas id="catChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-[2rem] shadow-lg border border-slate-100 flex flex-col max-h-[300px]">
                <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4">Log Kehadiran</h4>
                <div class="flex-1 overflow-y-auto pr-2 space-y-2 no-scrollbar">
                    ${state.attendance.slice(-10).reverse().map(a => `
                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-100 flex items-center justify-between">
                            <div class="text-[10px] font-black text-slate-800 uppercase">${a.name}</div>
                            <div class="text-[8px] font-bold text-emerald-600">${a.timestamp.split(',')[1]}</div>
                        </div>
                    `).join('') || '<div class="text-center py-10 text-slate-300 font-bold text-[9px]">BELUM ADA DATA</div>'}
                </div>
            </div>
        </div>
        <div class="mt-8 bg-white rounded-[2rem] shadow-lg border border-slate-100 overflow-hidden">
            <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Daftar Kehadiran Lengkap</h4>
                <input type="text" id="repSearch" value="${state.reportSearch}" placeholder="Cari..." class="bg-slate-50 px-4 py-2 rounded-xl text-[10px] font-bold border-2 border-transparent focus:border-emerald-500 outline-none">
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest">
                        <tr><th class="p-4">Nama</th><th class="p-4">Kategori</th><th class="p-4">Status</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        ${state.participants.filter(p => p.name.toLowerCase().includes(state.reportSearch.toLowerCase())).map(p => {
                            const isPresent = state.attendance.some(a => a.qrCode === p.qrCode);
                            return `<tr>
                                <td class="p-4 font-black text-slate-800 uppercase">${p.name}</td>
                                <td class="p-4 font-bold text-slate-500 uppercase">${p.status}</td>
                                <td class="p-4">${isPresent ? '<span class="text-emerald-500 font-black">HADIR</span>' : '<span class="text-slate-300 font-bold">ALPHA</span>'}</td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Fix: Property 'value' does not exist on type 'EventTarget' (line 359)
    (document.getElementById('repSearch') as HTMLInputElement).onkeyup = (e) => { state.reportSearch = (e.target as HTMLInputElement).value; renderLiveReport(); };

    // Fix: Property 'getContext' does not exist on type 'HTMLElement' (line 361)
    const ctx = (document.getElementById('catChart') as HTMLCanvasElement).getContext('2d');
    const labels = ['Orangtua', 'Pemuda', 'Sekolah Minggu', 'Tamu'];
    const data = labels.map(l => state.participants.filter(p => p.status === l).length);
    // Fix: Cannot find name 'Chart' (line 364)
    if (ctx) {
        new (window as any).Chart(ctx, {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#064e3b', '#10b981', '#34d399', '#f59e0b'], borderWidth: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold', size: 9 } } } }, cutout: '70%' }
        });
    }
};

const renderAdminPanel = () => {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div class="bg-white rounded-[2rem] shadow-xl p-8 mb-8 border border-slate-100 animate-[modalUp_0.4s]">
            <div class="flex flex-wrap justify-between items-center gap-4 mb-10">
                <h3 class="text-xl font-black text-slate-800 royal-font uppercase">Manajemen Data</h3>
                <div class="flex gap-2">
                    <button id="btnExport" class="bg-emerald-50 text-emerald-700 px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest border border-emerald-100">Ekspor CSV</button>
                    <button id="btnResetAll" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest border border-red-100">Reset Sistem</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <input type="text" id="admSearch" value="${state.adminSearch}" placeholder="Cari Nama..." class="bg-slate-50 p-4 rounded-2xl font-bold border-2 border-transparent focus:border-emerald-500 outline-none text-xs">
                <select id="admFilter" class="bg-slate-50 p-4 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none text-xs">
                    <option value="Semua">Semua Kategori</option>
                    <option value="Orangtua" ${state.filterStatus==='Orangtua'?'selected':''}>Orangtua</option>
                    <option value="Pemuda" ${state.filterStatus==='Pemuda'?'selected':''}>Pemuda</option>
                    <option value="Sekolah Minggu" ${state.filterStatus==='Sekolah Minggu'?'selected':''}>Sekolah Minggu</option>
                    <option value="Tamu" ${state.filterStatus==='Tamu'?'selected':''}>Tamu</option>
                </select>
            </div>

            <div class="overflow-x-auto rounded-2xl border border-slate-50">
                <table class="w-full text-left text-[10px]">
                    <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest">
                        <tr><th class="p-4">Peserta</th><th class="p-4">Kategori</th><th class="p-4 text-center">Aksi</th></tr>
                    </thead>
                    <tbody class="divide-y divide-slate-50">
                        ${state.participants.filter(p => p.name.toLowerCase().includes(state.adminSearch.toLowerCase()) && (state.filterStatus === 'Semua' || p.status === state.filterStatus)).map(p => `
                            <tr>
                                <td class="p-4">
                                    <div class="font-black text-slate-800 uppercase">${p.name}</div>
                                    <div class="text-[8px] font-mono text-emerald-600 mt-0.5">${p.qrCode}</div>
                                </td>
                                <td class="p-4 font-bold text-slate-500 uppercase">${p.status}</td>
                                <td class="p-4 flex justify-center gap-2">
                                    <button onclick="window.adminResetPIN('${p.firebaseId}', '${p.name}')" class="w-8 h-8 bg-amber-50 text-amber-600 rounded-lg flex items-center justify-center border border-amber-100"><i class="fas fa-key text-[10px]"></i></button>
                                    <button onclick="window.adminDeleteParticipant('${p.firebaseId}')" class="w-8 h-8 bg-red-50 text-red-600 rounded-lg flex items-center justify-center border border-red-100"><i class="fas fa-trash text-[10px]"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="bg-white rounded-[2rem] shadow-xl p-8 border border-slate-100">
            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest mb-6">Manajemen Staff Lapangan</h4>
            <div class="flex gap-2 mb-6">
                <input id="stfName" type="text" placeholder="Nama Petugas" class="flex-1 bg-slate-50 p-3 rounded-xl font-bold text-[11px] border-2 border-transparent focus:border-emerald-500 outline-none">
                <input id="stfPin" type="password" maxlength="6" placeholder="PIN" class="w-24 bg-slate-50 p-3 rounded-xl font-bold text-[11px] text-center outline-none">
                <button id="btnAddStaff" class="bg-emerald-600 text-white px-6 rounded-xl font-black text-[10px] uppercase">Tambah</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                ${state.staff.map(s => `
                    <div class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border border-slate-100">
                        <div>
                            <div class="text-[10px] font-black text-slate-800 uppercase">${s.name}</div>
                            <div class="text-[8px] font-black text-emerald-600 uppercase mt-0.5">PIN: ${s.pin}</div>
                        </div>
                        <button onclick="window.adminRemoveStaff('${s.firebaseId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button>
                    </div>
                `).join('') || '<div class="text-center py-6 text-slate-300 font-bold text-[10px]">BELUM ADA PETUGAS</div>'}
            </div>
        </div>
    `;

    // Fix: Property 'value' does not exist on type 'EventTarget' (lines 439-440)
    (document.getElementById('admSearch') as HTMLInputElement).onkeyup = (e) => { state.adminSearch = (e.target as HTMLInputElement).value; renderAdminPanel(); };
    (document.getElementById('admFilter') as HTMLSelectElement).onchange = (e) => { state.filterStatus = (e.target as HTMLSelectElement).value; renderAdminPanel(); };
    document.getElementById('btnAddStaff').onclick = handleAddStaff;
    document.getElementById('btnExport').onclick = exportCSV;
    document.getElementById('btnResetAll').onclick = () => {
        if(confirm("Hapus seluruh data secara permanen?")) {
            Promise.all([set(ref(db, 'participants'), null), set(ref(db, 'attendance'), null), set(ref(db, 'gifts'), null)])
            .then(() => alert("Data dibersihkan."));
        }
    };
};

const handleAddStaff = () => {
    // Fix: Property 'value' does not exist on type 'HTMLElement' (lines 452-453)
    const name = (document.getElementById('stfName') as HTMLInputElement).value.trim().toUpperCase();
    const pin = (document.getElementById('stfPin') as HTMLInputElement).value;
    if(!name || pin.length < 6) return alert("Validasi Gagal!");
    push(ref(db, 'staff'), { name, pin }).then(() => {
        // Fix: Property 'value' does not exist on type 'HTMLElement' (lines 456-457)
        (document.getElementById('stfName') as HTMLInputElement).value = '';
        (document.getElementById('stfPin') as HTMLInputElement).value = '';
        showToast("Petugas Ditambah", `${name} kini memiliki akses.`);
    });
};

const exportCSV = () => {
    const rows = [
        ["Nama", "Kategori", "Marga", "Kode Registrasi", "Waktu Daftar"],
        ...state.participants.map(p => [p.name, p.status, p.marga, p.qrCode, p.registeredAt])
    ];
    let csvContent = "\ufeff" + rows.map(e => e.join(",")).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Data_Peserta_Bonataon_2026.csv`;
    link.click();
};

// Fix: Property 'adminResetPIN' does not exist on type 'Window & typeof globalThis' (line 475)
(window as any).adminResetPIN = (id, name) => {
    const newPin = prompt(`Masukkan PIN baru (6-8 digit) untuk ${name}:`);
    if(newPin && newPin.length >= 6) {
        update(ref(db, 'participants/' + id), { password: newPin }).then(() => alert("PIN Berhasil di-reset."));
    }
};

// Fix: Property 'adminDeleteParticipant' does not exist on type 'Window & typeof globalThis' (line 482)
(window as any).adminDeleteParticipant = (id) => { if(confirm("Hapus peserta ini?")) remove(ref(db, 'participants/' + id)); };
// Fix: Property 'adminRemoveStaff' does not exist on type 'Window & typeof globalThis' (line 483)
(window as any).adminRemoveStaff = (id) => { if(confirm("Hapus akses petugas ini?")) remove(ref(db, 'staff/' + id)); };

// --- SCANNER LOGIC ---

const renderScanView = (type) => {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div class="bg-white rounded-[2.5rem] p-8 shadow-xl text-center border border-slate-100 animate-[modalUp_0.4s]">
            <h3 class="font-black text-xl mb-8 text-slate-800 royal-font uppercase">SCAN ${type === 'scan' ? 'KEHADIRAN' : 'BERKAT'}</h3>
            <div id="scanResult" class="hidden p-4 rounded-2xl mb-6 text-white font-black shadow-xl"></div>
            <div class="relative rounded-[2rem] overflow-hidden bg-black aspect-square max-w-xs mx-auto mb-10 shadow-2xl border-4 border-emerald-500/20">
                <div id="qrReader" class="w-full h-full"></div>
            </div>
            <button id="btnManual" class="w-full py-5 bg-slate-900 text-white rounded-2xl font-black text-xs shadow-xl uppercase tracking-widest">Input Manual</button>
        </div>
    `;

    // Fix: Cannot find name 'Html5Qrcode' (line 500)
    state.scanner = new (window as any).Html5Qrcode("qrReader");
    const config = { fps: 15, qrbox: 250 };
    state.scanner.start({ facingMode: "environment" }, config, (decodedText) => {
        handleScanResult(decodedText.trim().toUpperCase(), type);
    }).catch(err => console.error(err));

    document.getElementById('btnManual').onclick = () => {
        const code = prompt("Masukkan Kode Registrasi (MN-XXXX):");
        if(code) handleScanResult(code.trim().toUpperCase(), type);
    };
};

const handleScanResult = (code, type) => {
    const resultEl = document.getElementById('scanResult');
    const participant = state.participants.find(p => p.qrCode === code);
    
    if(!participant) {
        resultEl.innerText = "KODE TIDAK TERDAFTAR!";
        resultEl.className = "p-4 rounded-2xl mb-6 bg-red-600 text-white font-black block shadow-xl";
        return;
    }

    const path = type === 'scan' ? 'attendance' : 'gifts';
    const list = type === 'scan' ? state.attendance : state.gifts;
    const exists = list.some(i => i.qrCode === code);

    if(exists) {
        resultEl.innerText = `${participant.name} SUDAH TERDATA!`;
        resultEl.className = "p-4 rounded-2xl mb-6 bg-amber-500 text-white font-black block shadow-xl";
        return;
    }

    push(ref(db, path), { name: participant.name, qrCode: code, timestamp: new Date().toLocaleString() }).then(() => {
        resultEl.innerText = `SUKSES: ${participant.name}`;
        resultEl.className = "p-4 rounded-2xl mb-6 bg-emerald-600 text-white font-black block shadow-xl animate-bounce";
        showToast("Scan Sukses", participant.name);
    });
};

// --- NAVIGATION & INIT ---

const setTab = async (t) => {
    if(state.scanner) {
        try { await state.scanner.stop(); } catch(e) {}
        state.scanner = null;
    }
    state.tab = t;
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.id === `nav-${t}`));
    
    if(t === 'register') renderParticipantList();
    else if(t === 'find') {
        const area = document.getElementById('content-area');
        area.innerHTML = `
            <div class="bg-white rounded-[2.5rem] p-10 shadow-xl text-center border border-slate-100 animate-[modalUp_0.4s]">
                <div class="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner"><i class="fas fa-search text-3xl"></i></div>
                <h3 class="font-black text-xl mb-8 text-slate-800 royal-font uppercase">Cari Undangan</h3>
                <div class="space-y-4">
                    <input id="findIn" type="text" placeholder="Masukkan Nama Anda" class="w-full bg-slate-50 p-5 rounded-2xl font-bold uppercase border-2 border-transparent focus:border-emerald-500 outline-none text-center">
                    <button id="btnFind" class="w-full bg-emerald-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase tracking-widest">Temukan Tiket</button>
                </div>
            </div>
        `;
        document.getElementById('btnFind').onclick = () => {
            // Fix: Property 'value' does not exist on type 'HTMLElement' (line 563)
            const q = (document.getElementById('findIn') as HTMLInputElement).value.trim().toLowerCase();
            const found = state.participants.filter(p => p.name.toLowerCase().includes(q));
            if(!found.length) return alert("Data tidak ditemukan!");
            if(found.length === 1) startTicketAuth(found[0]);
            else alert("Ditemukan beberapa nama. Harap ketik lebih spesifik.");
        };
    }
    else if(t === 'scan' || t === 'gift') renderScanView(t);
    else if(t === 'report') renderLiveReport();
    else if(t === 'data') renderAdminPanel();
};

const startTicketAuth = (user) => {
    const html = `
        <h3 class="text-xl font-black text-slate-800 text-center uppercase royal-font mb-2">Verifikasi Tiket</h3>
        <p class="text-[10px] text-slate-400 font-bold text-center mb-8 uppercase tracking-widest">Masukkan PIN Anda</p>
        <input id="pinIn" type="password" maxlength="8" class="w-full bg-slate-50 p-5 rounded-2xl font-bold text-center text-3xl tracking-[0.5em] mb-8 outline-none border-2 border-transparent focus:border-emerald-500" placeholder="••••••••">
        <div class="grid grid-cols-2 gap-4">
            <button onclick="document.getElementById('authModal').classList.add('hidden')" class="py-4 border-2 border-slate-100 rounded-2xl font-black text-slate-400 text-[10px] uppercase">Batal</button>
            <button id="btnConfirmAuth" class="py-4 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase shadow-lg">Konfirmasi</button>
        </div>
    `;
    openModal(html, 'authModal');
    document.getElementById('btnConfirmAuth').onclick = () => {
        // Fix: Property 'value' does not exist on type 'HTMLElement' (line 587)
        const pin = (document.getElementById('pinIn') as HTMLInputElement).value;
        if(pin === user.password) { closeModal('authModal'); showTicket(user); }
        else alert("PIN Salah!");
    };
};

// Initial Listeners
onValue(ref(db, 'participants'), s => { 
    state.participants = s.val() ? Object.keys(s.val()).map(k => ({...s.val()[k], firebaseId: k})) : []; 
    updateDashboard(); 
});
onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
onValue(ref(db, 'gifts'), s => { state.gifts = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
onValue(ref(db, 'staff'), s => { state.staff = s.val() ? Object.keys(s.val()).map(k => ({...s.val()[k], firebaseId: k})) : []; updateDashboard(); });
onValue(ref(db, 'settings/adminPin'), s => { if(s.val()) state.adminPass = s.val(); });

// Clock
setInterval(() => {
    // Clock logic omitted for brevity in HTML but can be added back if space allows. 
    // It's already in the dashboard logic.
}, 1000);

// Init Events
document.getElementById('adminTrigger').onclick = renderAdminLogin;
document.getElementById('nav-register').onclick = () => setTab('register');
document.getElementById('nav-find').onclick = () => setTab('find');
document.getElementById('nav-scan').onclick = () => setTab('scan');
document.getElementById('nav-gift').onclick = () => setTab('gift');
document.getElementById('nav-report').onclick = () => setTab('report');
document.getElementById('nav-data').onclick = () => setTab('data');
document.getElementById('nav-logout').onclick = () => {
    if(confirm("Keluar dari Mode Panitia?")) {
        state.isAdmin = false; state.isStaff = false;
        refreshUI();
        setTab('register');
    }
};

// Start
setTab('register');
refreshUI();
