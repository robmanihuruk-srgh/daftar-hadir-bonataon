<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon Marga Manihuruk Boru Bere / Panagolan 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
      
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #059669;
            --emerald-50: #ecfdf5;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }
          
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .serif-font { font-family: 'Playfair Display', serif; }
        .royal-font { font-family: 'Cinzel', serif; }
          
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
          
        .header-bg {
            background: linear-gradient(135deg, var(--emerald-900) 0%, var(--emerald-600) 100%);
            position: relative;
            overflow: hidden;
        }
        .header-bg::after {
            content: "";
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M0 0h20L0 20z'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }

        .nav-btn {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 80px;
            touch-action: manipulation;
        }
        .nav-btn.active {
            background-color: var(--emerald-50);
            color: var(--emerald-900);
            border-color: var(--emerald-600);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(5, 150, 105, 0.2);
        }

        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.05); border-radius: 10px; }
        
        .logo-frame {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        
        .chart-wrapper { position: relative; height: 280px; width: 100%; }
        
        .form-input {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
            appearance: none;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2);
            outline: none;
        }

        .ornament { position: absolute; z-index: 0; opacity: 0.6; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); pointer-events: none; }
        
        @keyframes modalUp { from { opacity: 0; transform: translateY(40px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .vip-ticket {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        .vip-border {
            position: absolute; inset: 6px;
            border: 2px solid transparent;
            background: linear-gradient(135deg, #1e293b, #0f172a) padding-box,
                        var(--gold-gradient) border-box;
            border-radius: 12px;
            pointer-events: none;
        }
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .ticket-perforation {
            position: relative;
            background: #ffffff;
            margin-top: 20px;
            border-radius: 12px;
        }
        .ticket-perforation::before, .ticket-perforation::after {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #0f172a;
            border-radius: 50%;
        }
        .ticket-perforation::before { left: -12px; }
        .ticket-perforation::after { right: -12px; }

        #reader video {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
        }

        /* Scan Overlay Pulse */
        .scan-frame {
            position: absolute;
            inset: 20%;
            border: 2px solid var(--emerald-600);
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);
            z-index: 5;
            pointer-events: none;
        }
        .scan-frame::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--emerald-600);
            animation: scanLine 2s infinite ease-in-out;
            box-shadow: 0 0 15px var(--emerald-600);
        }
        @keyframes scanLine { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }

        @media (max-width: 640px) {
            .nav-btn span { font-size: 8px; }
            header { padding: 1.25rem; }
            .header-bg { padding-bottom: 5rem; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="ornament top-10 left-10 opacity-10"><i class="fas fa-leaf text-emerald-400 text-6xl transform -rotate-12"></i></div>
        <div class="ornament bottom-20 right-10 opacity-10"><i class="fas fa-church text-emerald-300 text-8xl"></i></div>
    </div>

    <div id="app" class="relative z-10 w-full max-w-lg mx-auto md:max-w-4xl min-h-screen md:my-8 md:rounded-[2rem] overflow-hidden flex flex-col glass-panel transition-all duration-500 shadow-2xl">
          
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center px-4 text-center">
            <div class="logo-frame w-28 h-28 p-3 mb-6 animate-bounce">
                <img src="logo tugu manihuruk.png" alt="Logo Tugu" class="w-full h-full object-contain" 
                     onerror="this.parentElement.innerHTML='<div class=\'text-center leading-none text-xs font-bold text-emerald-800\'>BONATAON<br>2026</div>'">
            </div>
            <h2 class="text-xl font-bold text-emerald-900 mb-2 serif-font tracking-wide leading-tight">BONATAON MARGA MANIHURUK<br>BORU BERE / PANAGOLAN 2026</h2>
            <div class="flex items-center gap-2 text-emerald-600 text-sm font-semibold mt-2">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat Sistem...
            </div>
        </div>

        <header class="header-bg p-6 pb-20 shadow-xl relative z-20">
            <div class="flex justify-between items-center relative z-10">
                <div class="flex items-center gap-3">
                    <div class="logo-frame w-12 h-12 md:w-16 md:h-16 p-1 border-2 border-white/20 shrink-0">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-xs md:text-xl font-bold text-white serif-font tracking-wide drop-shadow-md leading-tight">
                            BONATAON MARGA MANIHURUK<br>BORU BERE / PANAGOLAN 2026
                        </h1>
                    </div>
                </div>
                
                <div id="liveClock" class="text-right pl-2 hidden md:block"></div>
            </div>
            <div id="liveClockMobile" class="text-center mt-4 md:hidden border-t border-white/10 pt-2"></div>
              
            <div class="grid grid-cols-3 gap-2 md:gap-4 mt-6">
                <div class="bg-white/10 backdrop-blur-sm rounded-xl p-2 md:p-3 border border-white/10 text-center">
                    <div class="text-lg md:text-2xl font-bold text-white" id="statRegistered">0</div>
                    <div class="text-[8px] md:text-[10px] font-bold text-emerald-200 uppercase tracking-wider mt-1">Keluarga</div>
                </div>
                <div class="bg-emerald-500/30 backdrop-blur-sm rounded-xl p-2 md:p-3 border border-emerald-400/50 text-center">
                    <div class="text-lg md:text-2xl font-bold text-emerald-50" id="statPresent">0</div>
                    <div class="text-[8px] md:text-[10px] font-bold text-emerald-200 uppercase tracking-wider mt-1">Hadir</div>
                </div>
                <div class="bg-amber-500/20 backdrop-blur-sm rounded-xl p-2 md:p-3 border border-amber-400/30 text-center">
                    <div class="text-lg md:text-2xl font-bold text-amber-200" id="statGifts">0</div>
                    <div class="text-[8px] md:text-[10px] font-bold text-amber-100 uppercase tracking-wider mt-1">Berkat</div>
                </div>
            </div>
        </header>

        <nav class="flex px-4 -mt-10 relative z-30 gap-2 overflow-x-auto pb-4 custom-scrollbar">
            <button onclick="setTab('register')" id="tab-register" class="nav-btn flex-1 flex-shrink-0 min-w-[90px] bg-white rounded-xl flex flex-col items-center justify-center gap-2 shadow-lg border border-slate-100">
                <i class="fas fa-user-plus text-lg text-slate-400"></i>
                <span class="text-[9px] font-bold uppercase tracking-tighter">Registrasi</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-btn flex-1 flex-shrink-0 min-w-[90px] bg-white rounded-xl flex flex-col items-center justify-center gap-2 shadow-lg border border-slate-100">
                <i class="fas fa-search-location text-lg text-slate-400"></i>
                <span class="text-[9px] font-bold uppercase tracking-tighter">Undangan</span>
            </button>
            <button onclick="setTab('scan')" id="tab-scan" class="nav-btn flex-1 flex-shrink-0 min-w-[90px] bg-white rounded-xl flex flex-col items-center justify-center gap-2 shadow-lg border border-slate-100">
                <i class="fas fa-qrcode text-lg text-slate-400"></i>
                <span class="text-[9px] font-bold uppercase tracking-tighter">Scan</span>
            </button>
            <button onclick="setTab('gift')" id="tab-gift" class="nav-btn flex-1 flex-shrink-0 min-w-[90px] bg-white rounded-xl flex flex-col items-center justify-center gap-2 shadow-lg border border-slate-100">
                <i class="fas fa-gift text-lg text-slate-400"></i>
                <span class="text-[9px] font-bold uppercase tracking-tighter">Berkat</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-btn flex-1 flex-shrink-0 min-w-[90px] bg-white rounded-xl flex flex-col items-center justify-center gap-2 shadow-lg border border-slate-100">
                <i class="fas fa-chart-pie text-lg text-slate-400"></i>
                <span class="text-[9px] font-bold uppercase tracking-tighter">Data</span>
            </button>
            <button onclick="window.adminLogin()" id="tab-admin" class="nav-btn flex-1 flex-shrink-0 min-w-[90px] bg-white rounded-xl flex flex-col items-center justify-center gap-2 shadow-lg border border-slate-100">
                <i class="fas fa-user-lock text-lg text-slate-400"></i>
                <span class="text-[9px] font-bold uppercase tracking-tighter">Admin</span>
            </button>
        </nav>

        <main class="flex-1 p-4 md:p-6 overflow-y-auto bg-slate-50 pb-24 relative">
            <div id="content-area" class="max-w-3xl mx-auto"></div>
        </main>
          
        <footer class="py-4 px-6 border-t border-slate-200 text-center bg-white/90 backdrop-blur-sm absolute bottom-0 w-full z-20">
            <div class="flex justify-between items-center text-[10px] md:text-xs">
                <div class="font-bold text-slate-400">&copy; 2026 Marga Manihuruk</div>
                <div class="font-bold text-emerald-700 flex items-center gap-1">
                    Bonataon 2026 <i class="fas fa-heart text-amber-500"></i>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeModal('adminModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-700 text-xl"><i class="fas fa-lock"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Akses Panitia</h3>
            </div>
            <div class="space-y-4">
                <input type="password" id="adminPassword" placeholder="Masukkan PIN" class="form-input w-full rounded-xl p-3 text-center text-lg tracking-widest font-bold">
                <div class="text-right">
                    <button onclick="window.openAdminRecovery()" class="text-xs text-blue-500 hover:text-blue-700 font-bold">Lupa PIN?</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal('adminModal')" class="rounded-xl py-3 text-sm border border-slate-200 bg-slate-50">Batal</button>
                    <button onclick="window.verifyAdmin()" class="rounded-xl py-3 text-sm shadow-lg shadow-emerald-200 bg-emerald-600 text-white font-bold">Masuk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ticketModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden p-4 overflow-y-auto">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-md" onclick="closeModal('ticketModal')"></div>
        <div class="relative w-full max-w-sm my-8 animate-[modalUp_0.4s_ease-out]">
            <div id="vipTicketCard" class="vip-ticket rounded-3xl p-6 shadow-2xl">
                <div class="relative z-10 text-center">
                    <img src="logo tugu manihuruk.png" class="w-14 h-14 object-contain mx-auto mb-4 drop-shadow-md">
                    <h4 class="text-emerald-400 text-[9px] font-bold tracking-widest uppercase mb-1">Official Invitation</h4>
                    <h2 class="royal-font text-xl font-bold gold-text mb-1">BONATAON 2026</h2>
                    <h3 class="royal-font text-sm text-slate-300 tracking-[0.3em] mb-6">MANIHURUK</h3>

                    <div class="mb-2">
                        <p class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">Tamu Kehormatan</p>
                        <h1 id="ticName" class="text-xl font-bold text-white leading-tight">...</h1>
                    </div>
                    
                    <div class="flex justify-center gap-2 mb-6 mt-3">
                        <div class="px-2 py-1 border border-emerald-500/50 bg-emerald-900/30 rounded-full text-emerald-400 text-[8px] font-bold uppercase" id="ticStatusDisp">...</div>
                        <div class="px-2 py-1 border border-amber-500/50 bg-amber-900/30 rounded-full text-amber-400 text-[8px] font-bold uppercase" id="ticMargaDisp">...</div>
                    </div>

                    <div class="ticket-perforation bg-white p-4 shadow-inner">
                        <img id="ticQR" src="" class="w-40 h-40 object-contain mx-auto" alt="QR">
                        <div class="text-center mt-3">
                            <div class="text-[9px] text-slate-400 uppercase tracking-widest">Access Code</div>
                            <div class="text-lg font-mono font-black text-slate-800" id="ticCode">...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex flex-col gap-2">
                <button onclick="window.downloadTicketImage()" class="w-full py-3 rounded-xl bg-emerald-600 text-white font-bold text-sm shadow-lg"><i class="fas fa-download mr-2"></i> Simpan Gambar</button>
                <button onclick="closeModal('ticketModal')" class="w-full text-white/50 text-xs py-2">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Missing functional modals... -->
    <div id="authTicketModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-4">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('authTicketModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <h3 class="text-lg font-bold text-slate-800 text-center mb-4">Verifikasi Password</h3>
            <input type="password" id="ticketPassInput" placeholder="PIN Anda" class="form-input w-full rounded-xl p-3 text-center text-xl font-bold mb-4">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal('authTicketModal')" class="py-3 border border-slate-200 rounded-xl">Batal</button>
                <button onclick="window.verifyTicketPass()" class="py-3 bg-amber-500 text-white rounded-xl font-bold">Buka</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            tab: 'register',
            scanner: null,
            isAdmin: false,
            adminPass: "ADMIN123",
            recoveryKey: "BONA2026",
            tempAuthUser: null,
            activeTable: 'attendance'
        };

        // UI & CLOCK
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit', second:'2-digit' }).replace(/\./g,':');
            const date = now.toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'short' });
            const html = `<div class="text-white/80"><div class="text-[9px] uppercase font-bold">${date}</div><div class="text-lg md:text-xl font-mono font-bold">${time}</div></div>`;
            if(document.getElementById('liveClock')) document.getElementById('liveClock').innerHTML = html;
            if(document.getElementById('liveClockMobile')) document.getElementById('liveClockMobile').innerHTML = html;
        }
        setInterval(updateClock, 1000);

        // DATA LISTENERS
        onValue(ref(db, 'participants'), s => { state.participants = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'gifts'), s => { state.gifts = s.val() ? Object.values(s.val()) : []; updateDashboard(); });

        function updateDashboard() {
            document.getElementById('statRegistered').innerText = state.participants.length;
            document.getElementById('statPresent').innerText = state.attendance.length;
            document.getElementById('statGifts').innerText = state.gifts.length;
            
            if(state.tab === 'register') renderParticipantList();
            if(state.tab === 'data') { renderCharts(); renderDataTable(); }
            if(state.tab === 'scan' || state.tab === 'gift') renderRecentScans();
            document.getElementById('loading').style.display = 'none';
        }

        // TABS & NAVIGATION
        window.setTab = async (t) => {
            if(state.scanner) await stopScanner();
            state.tab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}`));
            
            const area = document.getElementById('content-area');
            if(t === 'register') area.innerHTML = renderRegisterTab();
            else if(t === 'find') area.innerHTML = renderFindTab();
            else if(t === 'scan') area.innerHTML = renderScannerTab('Kehadiran');
            else if(t === 'gift') area.innerHTML = renderScannerTab('Pengambilan Berkat');
            else if(t === 'data') area.innerHTML = renderDataTab();

            if(t === 'register') renderParticipantList();
            if(t === 'scan' || t === 'gift') { setTimeout(initScanner, 500); renderRecentScans(); }
            if(t === 'data') { renderCharts(); renderDataTable(); }
        };

        // RENDERERS
        function renderRegisterTab() {
            return `
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-6">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-pen text-emerald-600"></i> Form Registrasi</h3>
                <div class="space-y-4">
                    <div><label class="text-[10px] font-bold text-slate-400 uppercase">Nama Lengkap</label><input id="inName" type="text" class="form-input w-full rounded-xl p-3" placeholder="Nama Anda"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Status</label><select id="inStatus" class="form-input w-full rounded-xl p-3"><option value="Orangtua">Orangtua</option><option value="Pemuda">Pemuda</option><option value="Sekolah Minggu">Sekolah Minggu</option><option value="Tamu">Tamu</option></select></div>
                        <div><label class="text-[10px] font-bold text-slate-400 uppercase">Marga</label><select id="inMarga" class="form-input w-full rounded-xl p-3"><option value="Manihuruk">Manihuruk</option><option value="Boru">Boru</option><option value="Bere">Bere</option></select></div>
                    </div>
                    <div class="bg-amber-50 p-3 rounded-xl border border-amber-100">
                        <label class="text-[10px] font-bold text-amber-600 uppercase">Buat Password / PIN (Wajib)</label>
                        <input id="inPass" type="text" class="form-input w-full rounded-xl p-3 font-bold text-center border-amber-200" placeholder="Contoh: 1234">
                    </div>
                    <button onclick="window.processRegister()" class="w-full bg-emerald-600 text-white rounded-xl py-4 font-bold shadow-lg shadow-emerald-200 active:scale-95 transition-transform">Daftarkan Sekarang</button>
                </div>
            </div>
            <div id="participantList" class="space-y-2"></div>`;
        }

        function renderFindTab() {
            return `
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-100 text-center">
                <div class="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-500 text-2xl"><i class="fas fa-search"></i></div>
                <h3 class="font-bold text-xl mb-6">Temukan Undangan Saya</h3>
                <div class="space-y-4 max-w-sm mx-auto text-left">
                    <input id="findName" type="text" placeholder="Masukkan Nama..." class="form-input w-full rounded-xl p-4 text-center">
                    <select id="findMarga" class="form-input w-full rounded-xl p-4 text-center">
                        <option value="Manihuruk">Manihuruk</option>
                        <option value="Boru">Boru</option>
                        <option value="Bere">Bere</option>
                    </select>
                    <button onclick="window.findTicket()" class="w-full bg-emerald-600 text-white rounded-xl py-4 font-bold shadow-lg">Cari Undangan</button>
                </div>
            </div>`;
        }

        function renderScannerTab(title) {
            return `
            <div class="bg-white rounded-2xl p-4 shadow-sm">
                <h3 class="font-bold text-center mb-4">Scan QR ${title}</h3>
                <div id="scanMsg" class="hidden p-3 rounded-xl text-center text-sm font-bold mb-4"></div>
                <div class="relative rounded-2xl overflow-hidden bg-black aspect-square max-w-sm mx-auto border-4 border-slate-200">
                    <div id="reader"></div>
                    <div class="scan-frame"></div>
                </div>
                <div id="recentScans" class="mt-6 space-y-2"></div>
            </div>`;
        }

        function renderDataTab() {
            return `
            <div class="space-y-6">
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2">Overview</h4><div class="chart-wrapper"><canvas id="chartOverview"></canvas></div></div>
                ${state.isAdmin ? `
                <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold">Laporan Realtime</h4>
                        <div class="flex gap-1">
                            <button onclick="window.toggleTable('attendance')" class="px-2 py-1 text-[9px] bg-slate-100 rounded">Hadir</button>
                            <button onclick="window.toggleTable('gifts')" class="px-2 py-1 text-[9px] bg-slate-100 rounded">Berkat</button>
                        </div>
                    </div>
                    <div id="dataTableContainer" class="max-h-60 overflow-auto border rounded-xl text-[10px]"></div>
                    <button onclick="window.exportData('a')" class="w-full mt-4 py-3 bg-emerald-600 text-white rounded-xl text-xs font-bold">Export Excel (CSV)</button>
                    <button onclick="window.adminLogout()" class="w-full mt-2 py-2 text-slate-400 text-[10px] font-bold">Logout Admin</button>
                </div>` : `
                <div class="p-8 text-center text-slate-400 border-2 border-dashed rounded-2xl"><i class="fas fa-lock text-3xl mb-2"></i><p class="text-xs">Detail data hanya untuk Panitia.</p></div>`}
            </div>`;
        }

        // SCANNER LOGIC
        window.initScanner = () => {
            state.scanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            state.scanner.start({ facingMode: "environment" }, config, onScanSuccess);
        };

        window.stopScanner = async () => {
            if(state.scanner) {
                try { await state.scanner.stop(); } catch(e) {}
                state.scanner = null;
            }
        };

        function onScanSuccess(decodedText) {
            const msg = document.getElementById('scanMsg');
            const p = state.participants.find(x => x.qrCode === decodedText);
            
            if(!p) {
                showScanFeedback('QR Code Tidak Dikenali', 'bg-red-100 text-red-600');
                return;
            }

            const dbPath = state.tab === 'scan' ? 'attendance' : 'gifts';
            const existing = state[dbPath].find(x => x.participantId === p.id);

            if(existing) {
                showScanFeedback(`Sudah Tercatat: ${p.name}`, 'bg-amber-100 text-amber-600');
            } else {
                push(ref(db, dbPath), {
                    participantId: p.id,
                    name: p.name,
                    marga: p.marga,
                    status: p.status,
                    timestamp: new Date().toLocaleString('id-ID')
                }).then(() => {
                    showScanFeedback(`Berhasil: ${p.name}`, 'bg-emerald-100 text-emerald-600');
                    beep('success');
                });
            }
        }

        function showScanFeedback(text, classes) {
            const msg = document.getElementById('scanMsg');
            if(!msg) return;
            msg.innerText = text;
            msg.className = `p-3 rounded-xl text-center text-sm font-bold mb-4 ${classes}`;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }

        window.renderRecentScans = () => {
            const list = document.getElementById('recentScans');
            if(!list) return;
            const data = state.tab === 'scan' ? state.attendance : state.gifts;
            const title = state.tab === 'scan' ? 'Kehadiran' : 'Berkat';
            
            list.innerHTML = `
                <h5 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Scan Terbaru (${title})</h5>
                ${data.slice(-3).reverse().map(d => `
                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <div><div class="font-bold text-xs">${d.name}</div><div class="text-[9px] text-slate-400">${d.timestamp}</div></div>
                        <i class="fas fa-check-circle text-emerald-500"></i>
                    </div>
                `).join('') || '<p class="text-[10px] text-slate-400 italic">Belum ada scan.</p>'}`;
        };

        // ADMIN FUNCTIONS
        window.verifyAdmin = () => {
            const pass = document.getElementById('adminPassword').value;
            if(pass === state.adminPass) {
                state.isAdmin = true;
                closeModal('adminModal');
                setTab(state.tab);
                alert("Login Berhasil");
            } else alert("PIN Salah!");
        };

        window.adminLogin = () => {
            if(state.isAdmin) alert("Anda sudah dalam Mode Admin");
            else document.getElementById('adminModal').classList.remove('hidden');
        };

        window.adminLogout = () => {
            state.isAdmin = false;
            setTab('register');
        };

        window.toggleTable = (type) => {
            state.activeTable = type;
            renderDataTable();
        };

        window.renderDataTable = () => {
            const container = document.getElementById('dataTableContainer');
            if(!container) return;
            const data = state.activeTable === 'attendance' ? state.attendance : state.gifts;
            container.innerHTML = `
                <table class="w-full text-left">
                    <thead class="bg-slate-100 sticky top-0"><tr><th class="p-2">Nama</th><th class="p-2">Waktu</th></tr></thead>
                    <tbody>${data.map(d => `<tr class="border-b"><td class="p-2 font-bold">${d.name}</td><td class="p-2 text-slate-500">${d.timestamp.split(',')[1]}</td></tr>`).join('')}</tbody>
                </table>`;
        };

        // SHARED HELPERS
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        function beep(type) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(type === 'success' ? 880 : 200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        // Export Data
        window.exportData = (type) => {
            const data = type === 'p' ? state.participants : (state.activeTable === 'attendance' ? state.attendance : state.gifts);
            const csv = "Nama,Status,Marga,Waktu\n" + data.map(r => `"${r.name}","${r.status}","${r.marga}","${r.timestamp || r.registeredAt}"`).join("\n");
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = `Data_Bonataon_2026.csv`;
            link.click();
        };

        // Initialization Logic
        window.processRegister = () => {
            const n = document.getElementById('inName').value;
            const s = document.getElementById('inStatus').value;
            const m = document.getElementById('inMarga').value;
            const p = document.getElementById('inPass').value;
            if(!n || !p) return alert("Lengkapi data!");
            const code = `MN-${Date.now().toString().slice(-6)}`;
            push(ref(db, 'participants'), { name:n, status:s, marga:m, password:p, qrCode:code, registeredAt: new Date().toLocaleString() })
            .then(() => window.showTicket(n, s, m, code));
        };

        window.showTicket = (name, status, marga, code) => {
            document.getElementById('ticName').innerText = name;
            document.getElementById('ticStatusDisp').innerText = status;
            document.getElementById('ticMargaDisp').innerText = marga;
            document.getElementById('ticCode').innerText = code;
            QRCode.toDataURL(code, { color:{dark:"#064e3b"} }).then(url => {
                document.getElementById('ticQR').src = url;
                document.getElementById('ticketModal').classList.remove('hidden');
            });
        };

        window.findTicket = () => {
            const name = document.getElementById('findName').value.toLowerCase();
            const marga = document.getElementById('findMarga').value;
            const found = state.participants.find(x => x.name.toLowerCase().includes(name) && x.marga === marga);
            if(found) {
                state.tempAuthUser = found;
                document.getElementById('authTicketModal').classList.remove('hidden');
            } else alert("Data tidak ditemukan.");
        };

        window.verifyTicketPass = () => {
            const input = document.getElementById('ticketPassInput').value;
            if(state.tempAuthUser && input === state.tempAuthUser.password) {
                window.showTicket(state.tempAuthUser.name, state.tempAuthUser.status, state.tempAuthUser.marga, state.tempAuthUser.qrCode);
                closeModal('authTicketModal');
            } else alert("Password Salah!");
        };

        window.downloadTicketImage = () => {
            html2canvas(document.getElementById('vipTicketCard')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'Tiket_Bonataon.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        // Charts
        window.renderCharts = () => {
            const ctx = document.getElementById('chartOverview');
            if(!ctx) return;
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Peserta', 'Hadir', 'Berkat'],
                    datasets: [{
                        data: [state.participants.length, state.attendance.length, state.gifts.length],
                        backgroundColor: ['#3b82f6', '#059669', '#f59e0b']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        };

        function renderParticipantList() {
            const list = document.getElementById('participantList');
            if(!list) return;
            list.innerHTML = `<h5 class="text-[10px] font-bold text-slate-400 uppercase mb-2">Pendaftar Terbaru</h5>` + 
                state.participants.slice(-5).reverse().map(p => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 flex justify-between items-center text-xs">
                    <div><div class="font-bold">${p.name}</div><div class="text-[10px] text-slate-400">${p.marga}</div></div>
                    <div class="text-[9px] bg-slate-100 px-2 py-1 rounded-full">${p.status}</div>
                </div>`).join('');
        }

        setTimeout(() => setTab('register'), 1000);
    </script>
</body>
</html>
