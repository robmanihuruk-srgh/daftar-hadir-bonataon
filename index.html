<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bonataon 2026 - Tugu Raja Manihuruk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
     
    <style>
        :root {
            /* Palette Hijau Elegan & Gelap */
            --primary: #059669; /* Emerald 600 */
            --secondary: #064e3b; /* Emerald 900 */
            --accent: #d97706; /* Amber 600 (Emas) */
            --surface: #ffffff;
            --dark-bg: #0f172a; /* Slate 900 */
        }
         
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            /* Background Gelap Mewah */
            background: radial-gradient(circle at top right, #065f46 0%, #0f172a 60%, #020617 100%);
            min-height: 100vh;
            color: #1e293b;
        }

        h1, h2, h3, .serif-font {
            font-family: 'Playfair Display', serif;
        }
         
        .glass-effect {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }
         
        .gradient-header {
            /* Gradasi Hijau ke Gelap */
            background: linear-gradient(135deg, #064e3b 0%, #10b981 100%);
            position: relative;
            overflow: hidden;
        }

        /* Motif Ulos Halus (Pattern Overlay) */
        .gradient-header::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: repeating-linear-gradient(45deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 2px, transparent 2px, transparent 10px);
            opacity: 0.3;
        }
         
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(0,0,0,0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
         
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
         
        .btn-primary {
            background: linear-gradient(to right, #059669, #047857);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            padding: 14px 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }
         
        .btn-primary:hover {
            background: linear-gradient(to right, #047857, #064e3b);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(5, 150, 105, 0.4);
        }
         
        .btn-secondary {
            background: #f1f5f9;
            color: #334155;
            font-weight: 600;
            border-radius: 12px;
            padding: 14px 24px;
            transition: all 0.3s ease;
        }
         
        .btn-secondary:hover {
            background: #e2e8f0;
            color: #0f172a;
        }
         
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px;
            text-align: center;
        }
         
        .nav-tab {
            background: transparent;
            border-radius: 12px;
            padding: 12px 10px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
         
        .nav-tab.active {
            background: #ecfdf5; /* Light Emerald */
            color: #047857; /* Dark Emerald */
            border-color: #a7f3d0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
         
        .nav-tab:hover:not(.active) {
            background: #f8fafc;
            color: #334155;
        }
         
        .input-field {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            padding: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #0f172a;
        }
         
        .input-field:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); /* Emerald glow */
            outline: none;
        }
         
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 9999px;
            font-weight: 700;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
         
        .badge-primary { background: #d1fae5; color: #065f46; } /* Emerald */
        .badge-success { background: #dcfce7; color: #14532d; } /* Green */
        .badge-warning { background: #fef3c7; color: #92400e; } /* Amber */
         
        .modal { animation: modalUp 0.3s cubic-bezier(0.165, 0.84, 0.44, 1); }
        @keyframes modalUp {
            from { opacity: 0; transform: translateY(40px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
         
        /* Scanner UI Update */
        #reader { 
            border-radius: 16px;
            border: 4px solid #059669; /* Green border */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        #reader video { border-radius: 12px; transform: scaleX(-1); }
        #reader__dashboard_section_csr button {
            background: #059669;
            color: white;
            border-radius: 8px;
            padding: 8px 16px;
            border: none;
            font-weight: 600;
        }
         
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
         
        .ornament {
            position: absolute;
            z-index: 0;
            opacity: 0.6;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
        }

        .title-text {
            /* Emas Elegan */
            background: linear-gradient(to bottom, #fde68a, #d97706);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 20px rgba(0,0,0,0.2);
        }

        .logo-box {
            background: white;
            border-radius: 16px;
            padding: 4px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="antialiased selection:bg-emerald-200 selection:text-emerald-900">
    
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="ornament top-10 left-10 opacity-10">
            <i class="fas fa-leaf text-emerald-400 text-6xl transform -rotate-12"></i>
        </div>
        <div class="ornament bottom-20 right-10 opacity-10">
            <i class="fas fa-church text-emerald-300 text-8xl"></i>
        </div>
        <div class="ornament top-1/4 right-20 opacity-5">
            <i class="fas fa-music text-amber-200 text-5xl"></i>
        </div>
    </div>

    <div id="app" class="relative z-10 max-w-md mx-auto md:max-w-4xl min-h-screen md:my-8 md:rounded-[2rem] overflow-hidden flex flex-col glass-effect transition-all duration-500">
         
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center">
            <div class="logo-box mb-6 w-20 h-20 flex items-center justify-center bg-gradient-to-br from-emerald-600 to-emerald-900">
                <div class="bg-white w-[96%] h-[96%] rounded-[14px] flex items-center justify-center flex-col p-1">
                    <span class="text-[10px] font-bold text-slate-800 leading-tight text-center">TUGU<br>RAJA</span>
                    <span class="text-[9px] font-bold text-emerald-600 mt-0.5">MANIHURUK</span>
                </div>
            </div>
            <h2 class="text-2xl font-bold text-emerald-800 mb-2 serif-font">Bonataon 2026</h2>
            <div class="text-slate-500 text-sm font-medium animate-pulse">Menyiapkan sukacita...</div>
        </div>

        <header class="gradient-header p-6 pb-20 shadow-2xl relative">
            <div class="absolute -top-24 -right-24 w-64 h-64 rounded-full bg-emerald-400/20 blur-3xl"></div>
            <div class="absolute -bottom-24 -left-24 w-64 h-64 rounded-full bg-amber-400/10 blur-3xl"></div>
             
            <div class="flex justify-between items-start relative z-10">
                <div class="flex items-center gap-4">
                    <div class="logo-box w-14 h-14 flex items-center justify-center shadow-lg transform rotate-3">
                        <div class="text-center leading-none">
                            <div class="text-[10px] font-bold text-slate-900">TUGU</div>
                            <div class="text-[8px] font-bold text-emerald-600">MANIHURUK</div>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold tracking-tight title-text drop-shadow-sm">BONATAON 2026</h1>
                        <p class="text-emerald-100/90 text-xs font-medium tracking-widest uppercase flex items-center gap-1.5 mt-1">
                            <i class="fas fa-map-pin text-amber-400"></i> Punguan Raja Manihuruk
                        </p>
                    </div>
                </div>
                <div class="text-right hidden md:block">
                    <div id="liveClock" class="text-xl font-mono font-bold text-white/90">00:00</div>
                    <div id="liveDate" class="text-xs text-emerald-200/80 font-medium mt-1">...</div>
                </div>
            </div>
             
            <div class="flex gap-3 mt-8 overflow-x-auto pb-2 custom-scrollbar no-scrollbar">
                <div class="stat-card flex-1 min-w-[100px] border-emerald-400/30">
                    <div class="text-2xl font-bold text-white" id="statRegistered">0</div>
                    <div class="text-[10px] uppercase font-bold text-emerald-200 mt-1">Terdaftar</div>
                </div>
                <div class="stat-card flex-1 min-w-[100px] bg-emerald-500/20 border-emerald-400/50">
                    <div class="text-2xl font-bold text-emerald-100" id="statPresent">0</div>
                    <div class="text-[10px] uppercase font-bold text-emerald-200 mt-1">Hadir</div>
                </div>
                <div class="stat-card flex-1 min-w-[100px] border-amber-400/30">
                    <div class="text-2xl font-bold text-amber-100" id="statGifts">0</div>
                    <div class="text-[10px] uppercase font-bold text-amber-200 mt-1">Berkat</div>
                </div>
            </div>
        </header>

        <nav class="flex px-4 -mt-12 relative z-20 gap-2 overflow-x-auto pb-4 custom-scrollbar bg-transparent">
            <button onclick="setTab('register')" id="tab-register" class="nav-tab flex-1 whitespace-nowrap flex flex-col items-center gap-1 bg-white shadow-sm">
                <i class="fas fa-user-plus text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Registrasi</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-tab flex-1 whitespace-nowrap flex flex-col items-center gap-1 bg-white shadow-sm">
                <i class="fas fa-search-location text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Cari Tiket</span>
            </button>
            <button onclick="setTab('scan')" id="tab-scan" class="nav-tab flex-1 whitespace-nowrap flex flex-col items-center gap-1 bg-white shadow-sm">
                <i class="fas fa-qrcode text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Scan Masuk</span>
            </button>
            <button onclick="setTab('gift')" id="tab-gift" class="nav-tab flex-1 whitespace-nowrap flex flex-col items-center gap-1 bg-white shadow-sm">
                <i class="fas fa-gift text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Ambil Berkat</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-tab flex-1 whitespace-nowrap flex flex-col items-center gap-1 bg-white shadow-sm">
                <i class="fas fa-chart-pie text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Data</span>
            </button>
            <button onclick="window.adminLogin()" id="tab-admin" class="nav-tab flex-1 whitespace-nowrap flex flex-col items-center gap-1 bg-white shadow-sm">
                <i class="fas fa-user-lock text-lg mb-0.5"></i>
                <span class="text-[10px] font-bold uppercase tracking-wide">Admin</span>
            </button>
        </nav>

        <main class="flex-1 p-6 overflow-y-auto bg-slate-50 pb-24">
            <div id="content-area"></div>
        </main>
         
        <footer class="py-5 px-6 border-t border-slate-200 text-center text-slate-400 text-xs bg-white/80 backdrop-blur-sm">
            <div class="flex justify-between items-center">
                <div class="font-medium">
                    &copy; 2026 Tugu Raja Manihuruk
                </div>
                <div class="flex items-center gap-1.5 text-emerald-600 font-bold">
                    <span>Sukacita Bersama</span>
                    <i class="fas fa-hands-praying"></i>
                </div>
            </div>
        </footer>
    </div>

    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('adminModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 modal p-8">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-600 text-2xl">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800 serif-font">Akses Panitia</h3>
                <p class="text-slate-500 text-sm mt-1">Area khusus pengurus acara</p>
            </div>
             
            <div class="space-y-4">
                <div class="relative">
                    <input type="password" id="adminPassword" placeholder="Kode Keamanan" class="input-field w-full text-center tracking-widest pl-4 pr-4">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal('adminModal')" class="btn-secondary w-full">Batal</button>
                    <button onclick="window.verifyAdmin()" class="btn-primary w-full shadow-lg shadow-emerald-200">Masuk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="manualCheckinModal" class="fixed inset-0 z-[8000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('manualCheckinModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 modal p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3 flex items-center gap-2">
                <i class="fas fa-check-double text-emerald-500"></i> Absensi Manual
            </h3>
            <div class="relative mb-4">
                <input type="text" id="manualSearch" placeholder="Cari nama jemaat..." class="input-field w-full pl-10">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
            <div id="manualCheckinList" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 mb-4 bg-slate-50 p-2 rounded-lg"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('manualCheckinModal')" class="btn-secondary flex-1">Tutup</button>
                <button onclick="processManualCheckin()" class="btn-primary flex-1" disabled id="manualCheckinBtn">Konfirmasi</button>
            </div>
        </div>
    </div>

    <div id="manualGiftModal" class="fixed inset-0 z-[8000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('manualGiftModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 modal p-6">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3 flex items-center gap-2">
                <i class="fas fa-gift text-amber-500"></i> Serah Terima Berkat
            </h3>
            <div class="relative mb-4">
                <input type="text" id="manualGiftSearch" placeholder="Cari nama jemaat..." class="input-field w-full pl-10">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
            </div>
            <div id="manualGiftList" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 mb-4 bg-slate-50 p-2 rounded-lg"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('manualGiftModal')" class="btn-secondary flex-1">Tutup</button>
                <button onclick="processManualGift()" class="btn-primary flex-1 bg-gradient-to-r from-amber-500 to-orange-600" disabled id="manualGiftBtn">Serahkan</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 z-[8000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('confirmModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 modal p-6 border-t-4 border-emerald-500">
            <h3 class="text-xl font-bold text-slate-800 mb-1 serif-font text-center">Validasi Data</h3>
            <p class="text-center text-slate-500 text-sm mb-6">Mohon periksa kembali data sebelum dicetak</p>
            
            <div class="space-y-3 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <div>
                    <label class="text-[10px] font-bold text-emerald-600 uppercase tracking-wider">Nama Lengkap</label>
                    <div id="confName" class="font-bold text-lg text-slate-800 leading-tight"></div>
                </div>
                <div class="h-px bg-slate-200"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Status</label>
                        <div id="confStatus" class="font-semibold text-slate-700"></div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Marga</label>
                        <div id="confMarga" class="font-semibold text-slate-700"></div>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeModal('confirmModal')" class="btn-secondary flex-1">Ubah</button>
                <button onclick="processSave()" class="btn-primary flex-1 shadow-lg shadow-emerald-200">
                    <i class="fas fa-save mr-2"></i> Simpan
                </button>
            </div>
        </div>
    </div>

    <div id="ticketModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('ticketModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 modal p-0 overflow-hidden shadow-2xl">
            <div class="bg-gradient-to-r from-emerald-600 to-teal-700 p-6 text-center text-white relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <h3 class="text-xl font-bold serif-font relative z-10">Undangan Resmi</h3>
                <p class="text-emerald-100 text-xs relative z-10">Bonataon Manihuruk 2026</p>
                <button onclick="closeModal('ticketModal')" class="absolute top-4 right-4 text-white/70 hover:text-white transition-colors">
                    <i class="fas fa-times-circle text-xl"></i>
                </button>
            </div>

            <div class="p-6 text-center bg-white relative">
                <div class="absolute -top-3 left-0 w-full h-3 bg-white" style="mask-image: radial-gradient(circle, transparent 5px, black 6px); mask-size: 15px 15px; mask-repeat: repeat-x; mask-position: bottom;"></div>

                <h2 id="ticName" class="text-2xl font-black text-slate-800 leading-tight mb-2 mt-2">Nama Peserta</h2>
                <div class="flex justify-center flex-wrap gap-2 mb-6">
                    <span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-xs font-bold rounded-full border border-emerald-100">
                        <span class="ticStatusText">Status</span>
                    </span>
                    <span class="px-3 py-1 bg-slate-50 text-slate-600 text-xs font-bold rounded-full border border-slate-100">
                        <span class="ticMargaText">Marga</span>
                    </span>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 inline-block mb-4 relative group">
                    <img id="ticQR" src="" class="w-48 h-48 object-contain mix-blend-multiply" alt="QR Code">
                    <div class="text-[10px] font-mono text-slate-400 mt-2 tracking-widest" id="ticCode">CODE</div>
                    <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-700 pointer-events-none" style="transform: skewX(-20deg);"></div>
                </div>

                <p class="text-xs text-slate-400 mb-6">Tunjukkan QR Code ini di meja registrasi</p>

                <div class="space-y-2">
                    <a id="btnDownloadTicket" href="#" download class="btn-primary w-full flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Simpan Gambar
                    </a>
                    <button onclick="printTicket()" class="w-full py-3 text-sm font-bold text-slate-500 hover:text-slate-800 transition-colors flex items-center justify-center gap-2">
                        <i class="fas fa-print"></i> Cetak Langsung
                    </button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".csv" class="hidden" onchange="handleImport(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIG FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",        
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347",
            measurementId: "G-BX7BB696ET"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASS = "ADMIN123"; 

        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            tab: 'register',
            dataViewMode: 'attendance', 
            scanner: null,
            tempData: null,
            searchTerm: '',
            isAdmin: false,
            selectedManualCheckin: null,
            selectedManualGift: null
        };

        let audioCtx = null;
        function beep(type = 'success') {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type === 'success' ? 'sine' : 'square';
            osc.frequency.setValueAtTime(type === 'success' ? 880 : 200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        const getClock = () => {
            const n = new Date();
            document.getElementById('liveClock').innerText = n.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
            document.getElementById('liveDate').innerText = n.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});
        };
        setInterval(getClock, 1000); getClock();

        const fmtDate = () => new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });
        const getQR = (txt) => `https://api.qrserver.com/v1/create-qr-code/?size=600x600&margin=20&ecc=H&color=064e3b&bgcolor=ffffff&format=png&data=${encodeURIComponent(txt)}`;

        onValue(ref(db, 'participants'), s => {
            state.participants = s.val() ? Object.values(s.val()) : [];
            updateStats();
            if (state.tab === 'register') renderParticipantListOnly();
        });
         
        onValue(ref(db, 'attendance'), s => {
            state.attendance = s.val() ? Object.values(s.val()) : [];
            updateStats();
            if (state.tab === 'data' && state.dataViewMode === 'attendance') render();
            document.getElementById('loading').style.display = 'none';
        });

        onValue(ref(db, 'gifts'), s => {
            state.gifts = s.val() ? Object.values(s.val()) : [];
            updateStats();
            if (state.tab === 'data' && state.dataViewMode === 'gifts') render();
        });

        function updateStats() {
            document.getElementById('statRegistered').innerText = state.participants.length;
            document.getElementById('statPresent').innerText = state.attendance.length;
            document.getElementById('statGifts').innerText = state.gifts.length;
        }

        window.preRegister = () => {
            const name = document.getElementById('inName').value.trim();
            const st = document.getElementById('inStatus').value;
            const mg = document.getElementById('inMarga').value;
            if(!name || !st || !mg) {
                showToast('Mohon lengkapi seluruh data keluarga.', 'warning');
                return;
            }
            state.tempData = { name, st, mg };
            document.getElementById('confName').innerText = name;
            document.getElementById('confStatus').innerText = st; 
            document.getElementById('confMarga').innerText = mg; 
            showModal('confirmModal');
        };

        window.processSave = () => {
            if(!state.tempData) return;
            const { name, st, mg } = state.tempData;
            const id = Date.now().toString();
            const qr = `MN-${id.slice(-6)}`;
             
            push(ref(db, 'participants'), {
                id, name, status: st, marga: mg, qrCode: qr,
                registeredAt: fmtDate(), timestamp: Date.now()
            }).then(() => {
                closeModal('confirmModal');
                document.getElementById('inName').value = '';
                window.showTicket(name, st, mg, qr);
                showToast('Horas! Data berhasil disimpan.', 'success');
            }).catch(error => {
                 showToast('Maaf, terjadi gangguan koneksi.', 'error');
            });
        };

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `fixed top-6 right-6 z-[10000] px-6 py-4 rounded-xl shadow-2xl text-white font-medium transform translate-x-full transition-all duration-300 flex items-center gap-3 backdrop-blur-md`;
             
            let bgColor = 'bg-slate-800/90';
            let icon = 'fas fa-info-circle';
             
            if (type === 'success') {
                bgColor = 'bg-emerald-600/90';
                icon = 'fas fa-check-circle';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-500/90';
                icon = 'fas fa-exclamation-circle';
            } else if (type === 'error') {
                bgColor = 'bg-red-500/90';
                icon = 'fas fa-times-circle';
            }
             
            toast.className += ` ${bgColor}`;
            toast.innerHTML = `<i class="${icon} text-lg"></i><span>${message}</span>`;
            document.body.appendChild(toast);
             
            setTimeout(() => { toast.classList.remove('translate-x-full'); toast.classList.add('translate-x-0'); }, 10);
            setTimeout(() => {
                toast.classList.remove('translate-x-0'); toast.classList.add('translate-x-full');
                setTimeout(() => { if (document.body.contains(toast)) document.body.removeChild(toast); }, 300);
            }, 3000);
        }

        window.showModal = (id) => {
            const modal = document.getElementById(id);
            modal.classList.remove('hidden');
            setTimeout(() => { modal.style.opacity = '1'; }, 10);
        };

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            modal.style.opacity = '0';
            setTimeout(() => { 
                modal.classList.add('hidden'); 
                if (id === 'manualCheckinModal') state.selectedManualCheckin = null;
                if (id === 'manualGiftModal') state.selectedManualGift = null;
            }, 300);
        };

        window.adminLogin = () => {
            showModal('adminModal');
            setTimeout(() => { document.getElementById('adminPassword').focus(); }, 100);
        };

        window.verifyAdmin = () => {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASS) {
                state.isAdmin = true;
                beep('success');
                document.getElementById('tab-admin').innerHTML = '<i class="fas fa-crown text-lg mb-0.5 text-amber-500"></i><span class="text-[10px] font-bold text-amber-600">Panitia</span>';
                document.getElementById('tab-admin').classList.add('bg-amber-50');
                closeModal('adminModal');
                showToast('Selamat datang, Panitia.', 'success');
            } else {
                beep('fail');
                showToast('Kode akses salah.', 'error');
            }
            document.getElementById('adminPassword').value = '';
        };

        window.openManualCheckin = () => {
            if (!state.isAdmin) { showToast('Akses khusus Panitia.', 'warning'); window.adminLogin(); return; }
            showModal('manualCheckinModal');
            setTimeout(() => { renderManualCheckinList(); document.getElementById('manualSearch').focus(); }, 100);
        };

        window.openManualGift = () => {
            if (!state.isAdmin) { showToast('Akses khusus Panitia.', 'warning'); window.adminLogin(); return; }
            showModal('manualGiftModal');
            setTimeout(() => { renderManualGiftList(); document.getElementById('manualGiftSearch').focus(); }, 100);
        };

        function renderManualCheckinList() {
            const searchTerm = document.getElementById('manualSearch').value.toLowerCase();
            const listEl = document.getElementById('manualCheckinList');
            const btn = document.getElementById('manualCheckinBtn');
             
            const filtered = state.participants.filter(p => {
                const alreadyPresent = state.attendance.find(a => a.participantId === p.id);
                return !alreadyPresent && p.name.toLowerCase().includes(searchTerm);
            });
             
            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="text-center py-6 text-slate-400 text-sm italic">Data tidak ditemukan atau sudah hadir</div>`;
                btn.disabled = true;
                return;
            }
             
            listEl.innerHTML = filtered.map(p => `
                <div class="p-3 border-b border-slate-100 hover:bg-emerald-50 cursor-pointer rounded-lg transition-colors flex justify-between items-center ${state.selectedManualCheckin?.id === p.id ? 'bg-emerald-50 border-emerald-200 ring-1 ring-emerald-300' : ''}" onclick="selectManualCheckin(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                    <div>
                        <div class="font-bold text-slate-700">${p.name}</div>
                        <div class="text-xs text-slate-400">${p.marga}</div>
                    </div>
                    <div class="w-6 h-6 rounded-full border-2 border-slate-300 flex items-center justify-center ${state.selectedManualCheckin?.id === p.id ? 'border-emerald-500 bg-emerald-500 text-white' : ''}">
                        ${state.selectedManualCheckin?.id === p.id ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </div>
                </div>
            `).join('');
            btn.disabled = !state.selectedManualCheckin;
        }

        function renderManualGiftList() {
            const searchTerm = document.getElementById('manualGiftSearch').value.toLowerCase();
            const listEl = document.getElementById('manualGiftList');
            const btn = document.getElementById('manualGiftBtn');
             
            const filtered = state.participants.filter(p => {
                const alreadyClaimed = state.gifts.find(g => g.participantId === p.id);
                return !alreadyClaimed && p.name.toLowerCase().includes(searchTerm);
            });
             
            if (filtered.length === 0) {
                listEl.innerHTML = `<div class="text-center py-6 text-slate-400 text-sm italic">Semua data sudah menerima berkat</div>`;
                btn.disabled = true;
                return;
            }
             
            listEl.innerHTML = filtered.map(p => `
                <div class="p-3 border-b border-slate-100 hover:bg-amber-50 cursor-pointer rounded-lg transition-colors flex justify-between items-center ${state.selectedManualGift?.id === p.id ? 'bg-amber-50 border-amber-200 ring-1 ring-amber-300' : ''}" onclick="selectManualGift(${JSON.stringify(p).replace(/"/g, '&quot;')})">
                    <div>
                        <div class="font-bold text-slate-700">${p.name}</div>
                        <div class="text-xs text-slate-400">${p.marga}</div>
                    </div>
                    <i class="fas fa-gift ${state.selectedManualGift?.id === p.id ? 'text-amber-500' : 'text-slate-200'}"></i>
                </div>
            `).join('');
            btn.disabled = !state.selectedManualGift;
        }

        window.selectManualCheckin = (p) => {
            state.selectedManualCheckin = p;
            const btn = document.getElementById('manualCheckinBtn');
            btn.disabled = false;
            btn.innerHTML = `Konfirmasi: ${p.name}`;
            renderManualCheckinList();
        };

        window.selectManualGift = (p) => {
            state.selectedManualGift = p;
            const btn = document.getElementById('manualGiftBtn');
            btn.disabled = false;
            btn.innerHTML = `Serahkan ke: ${p.name}`;
            renderManualGiftList();
        };

        window.processManualCheckin = () => {
            if (!state.selectedManualCheckin || !state.isAdmin) return;
            window.doCheckIn(state.selectedManualCheckin);
            state.selectedManualCheckin = null;
            closeModal('manualCheckinModal');
        };

        window.processManualGift = () => {
            if (!state.selectedManualGift || !state.isAdmin) return;
            window.claimGift(state.selectedManualGift);
            state.selectedManualGift = null;
            closeModal('manualGiftModal');
        };

        window.findMyTicket = () => {
            const nameInput = document.getElementById('findName');
            const margaInput = document.getElementById('findMarga');
             
            if(!nameInput || !margaInput) return;

            const name = nameInput.value.trim().toLowerCase();
            const marga = margaInput.value;

            if(!name || !marga) {
                showToast('Mohon isi Nama dan Marga.', 'warning');
                return;
            }

            const found = state.participants.find(p => {
                const pName = p.name?.trim().toLowerCase() || "";
                const pMarga = p.marga || ""; 
                return pName.includes(name) && pMarga === marga;
            });

            if (found) {
                window.showTicket(found.name, found.status, found.marga, found.qrCode);
            } else {
                showToast('Data tidak ditemukan. Silakan daftar baru.', 'error');
            }
        };

        window.processScannedID = (pid) => {
            const p = state.participants.find(x => x.id === pid);
            if(!p) { showToast('QR Code tidak valid!', 'error'); return; }
            if (state.tab === 'gift') window.claimGift(p);
            else window.doCheckIn(p);
        };

        window.doCheckIn = (p) => {
            const exists = state.attendance.find(x => x.participantId === p.id);
            if(exists) {
                beep('fail');
                showScanResult(false, `Sudah hadir sebelumnya: ${p.name}`);
            } else {
                push(ref(db, 'attendance'), {
                    id: Date.now().toString(), participantId: p.id, name: p.name,
                    status: p.status, marga: p.marga, timestamp: fmtDate()
                }).then(() => {
                    beep('success');
                    showScanResult(true, `Selamat Datang, ${p.name}!`);
                });
            }
        };

        window.claimGift = (p) => {
            const alreadyClaimed = state.gifts.find(x => x.participantId === p.id);
            if(alreadyClaimed) {
                beep('fail');
                showScanResult(false, `Sudah mengambil berkat: ${p.name}`, 'warning');
            } else {
                push(ref(db, 'gifts'), {
                    id: Date.now().toString(), participantId: p.id, name: p.name,
                    status: p.status, marga: p.marga, timestamp: fmtDate()
                }).then(() => {
                    beep('success');
                    showScanResult(true, `Berkat diserahkan ke: ${p.name}`, 'success');
                });
            }
        };

        window.initScanner = () => {
            if(state.scanner) return;
            const config = { fps: 10, qrbox: 250, aspectRatio: 1.0 };
            state.scanner = new Html5QrcodeScanner("reader", config, false);
            state.scanner.render((decodedText) => {
                if(state.scanner) state.scanner.pause();
                const p = state.participants.find(x => x.qrCode === decodedText);
                if(p) window.processScannedID(p.id);
                else { beep('fail'); showScanResult(false, "QR tidak terdaftar"); }
                setTimeout(() => { if(state.scanner) state.scanner.resume(); }, 2000);
            });
        };

        window.stopScanner = () => {
            if(state.scanner) {
                state.scanner.clear().then(() => { state.scanner = null; }).catch(console.error);
            }
        };

        function showScanResult(success, msg, type = 'success') {
            const el = document.getElementById('scanRes');
            if(el) {
                const icon = success ? 'check-circle' : 'times-circle';
                const colorClass = success ? 'bg-emerald-100 text-emerald-800 border-emerald-200' : 'bg-red-50 text-red-800 border-red-100';
                
                el.innerHTML = `<div class="flex items-center gap-3"><i class="fas fa-${icon} text-xl"></i><span class="font-bold">${msg}</span></div>`;
                el.className = `p-4 rounded-xl border-2 mb-4 animate-bounce ${colorClass}`;
                el.classList.remove('hidden');
                setTimeout(() => { el.classList.add('hidden'); }, 2500);
            }
        }

        window.handleSearch = (el) => {
            state.searchTerm = el.value.toLowerCase();
            const container = document.getElementById('manual-list');
            if(!container) return;
            const filtered = state.participants.filter(p => p.name.toLowerCase().includes(state.searchTerm));
            
            if(filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 py-8 text-sm italic">Tidak ada data yang cocok</div>';
                return;
            }
            
            container.innerHTML = filtered.map(p => {
                const claimed = state.gifts.find(g => g.participantId === p.id);
                const present = state.attendance.find(a => a.participantId === p.id);
                const isGiftMode = state.tab === 'gift';
                
                let badge = isGiftMode 
                    ? (claimed ? '<span class="badge badge-warning">Sudah Ambil</span>' : '<span class="badge badge-primary">Belum Ambil</span>')
                    : (present ? '<span class="badge badge-success">Hadir</span>' : '<span class="badge badge-primary">Belum Hadir</span>');

                return `
                <div class="flex items-center justify-between p-4 border-b border-slate-50 hover:bg-slate-50 transition-colors">
                    <div>
                        <div class="font-bold text-slate-700">${p.name}</div>
                        <div class="flex gap-2 mt-1">
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded">${p.status}</span>
                            <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-0.5 rounded">${p.marga}</span>
                        </div>
                    </div>
                    ${badge}
                </div>`;
            }).join('');
        };

        window.switchDataView = (mode) => { state.dataViewMode = mode; render(); }

        window.setTab = (t) => {
            if((state.tab === 'scan' || state.tab === 'gift') && (t !== 'scan' && t !== 'gift')) window.stopScanner();
            state.tab = t;
            ['register','find','scan','gift','data','admin'].forEach(x => {
                const btn = document.getElementById(`tab-${x}`);
                if(x === t) {
                    btn.classList.add('active', 'border-emerald-200');
                    btn.classList.remove('border-transparent');
                } else {
                    btn.classList.remove('active', 'border-emerald-200');
                    btn.classList.add('border-transparent');
                }
            });
            render();
            if(t === 'scan' || t === 'gift') setTimeout(() => window.initScanner(), 100);
        };

        function renderParticipantListOnly() {
            const container = document.getElementById('participant-list-container');
            if (container) {
                if (state.participants.length === 0) {
                    container.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fas fa-users text-4xl text-slate-300 mb-2"></i><p class="text-sm">Belum ada keluarga yang terdaftar</p></div>`;
                    return;
                }
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h4 class="font-bold text-slate-700">Keluarga Terdaftar</h4>
                        <span class="badge badge-primary">${state.participants.length} Jiwa</span>
                    </div>
                    <div class="space-y-3 custom-scrollbar max-h-[400px] overflow-y-auto pr-1">
                        ${state.participants.slice().reverse().map(p => `
                            <div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-slate-800">${p.name}</div>
                                    <div class="text-xs text-slate-400 mt-1">${p.marga} â€¢ ${p.status}</div>
                                </div>
                                <i class="fas fa-qrcode text-emerald-200 text-xl"></i>
                            </div>`).join('')}
                    </div>`;
            }
        }

        window.render = () => {
            const root = document.getElementById('content-area');
             
            if (state.tab === 'register') {
                if (!document.getElementById('registration-form')) {
                    root.innerHTML = `
                        <div class="card p-6 mb-6 relative overflow-hidden" id="registration-form">
                            <div class="absolute top-0 right-0 p-4 opacity-5"><i class="fas fa-pen-fancy text-6xl"></i></div>
                            <h3 class="font-bold text-xl text-emerald-800 mb-1 serif-font">Registrasi Keluarga</h3>
                            <p class="text-slate-500 text-sm mb-6">Mari mengisi data untuk kelancaran acara.</p>
                             
                            <div class="space-y-4 relative z-10">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Nama Lengkap</label>
                                    <input id="inName" type="text" placeholder="Tulis nama lengkap..." class="input-field w-full">
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Status</label>
                                        <select id="inStatus" class="input-field w-full cursor-pointer bg-white">
                                            <option value="" disabled selected>Pilih...</option>
                                            <option value="Orangtua">Orangtua</option>
                                            <option value="Pemuda">Pemuda</option>
                                            <option value="Sekolah Minggu">Sekolah Minggu</option>
                                            <option value="Tamu Undangan">Tamu Undangan</option>
                                            <option value="Pengurus Tupuan">Pengurus Tupuan</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1.5 ml-1">Marga</label>
                                        <select id="inMarga" class="input-field w-full cursor-pointer bg-white">
                                            <option value="" disabled selected>Pilih...</option>
                                            <option value="Marga Manihuruk">Manihuruk</option>
                                            <option value="Boru">Boru</option>
                                            <option value="Bere / Panagolan">Bere/Panagolan</option>
                                        </select>
                                    </div>
                                </div>
                                <button onclick="preRegister()" class="btn-primary w-full mt-4 shadow-lg shadow-emerald-100 flex items-center justify-center gap-2 group">
                                    <span>Simpan Data</span> <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                </button>
                            </div>
                        </div>
                        <div id="participant-list-container"></div>
                    `;
                }
                renderParticipantListOnly();
            } else if (state.tab === 'find') {
                root.innerHTML = `
                    <div class="card p-6 mb-6 text-center relative overflow-hidden">
                        <div class="absolute -top-10 -left-10 w-32 h-32 bg-amber-100 rounded-full blur-2xl opacity-50"></div>
                        <div class="w-16 h-16 bg-gradient-to-br from-emerald-100 to-teal-100 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600 text-2xl shadow-inner">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="font-bold text-xl text-slate-800 mb-2 serif-font">Cek Undangan</h3>
                        <p class="text-slate-500 text-sm mb-6 max-w-xs mx-auto">Masukkan nama dan marga untuk menampilkan kembali tiket Anda.</p>
                         
                        <div class="space-y-3 text-left">
                            <input id="findName" type="text" placeholder="Nama Lengkap..." class="input-field w-full text-center">
                            <select id="findMarga" class="input-field w-full text-center appearance-none cursor-pointer bg-white">
                                <option value="" disabled selected>Pilih Marga Anda</option>
                                <option value="Marga Manihuruk">Marga Manihuruk</option>
                                <option value="Boru">Boru</option>
                                <option value="Bere / Panagolan">Bere / Panagolan</option>
                            </select>
                            <button onclick="findMyTicket()" class="btn-primary w-full shadow-lg shadow-emerald-100">Cari Tiket Saya</button>
                        </div>
                    </div>
                `;
            } else if (state.tab === 'scan' || state.tab === 'gift') {
                const isGift = state.tab === 'gift';
                root.innerHTML = `
                    <div class="card p-6 mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="font-bold text-lg text-slate-800">${isGift ? 'Ambil Berkat' : 'Scan Kehadiran'}</h3>
                                <p class="text-xs text-slate-400">Arahkan kamera ke QR Code</p>
                            </div>
                            <div class="w-10 h-10 rounded-full ${isGift ? 'bg-amber-100 text-amber-600' : 'bg-emerald-100 text-emerald-600'} flex items-center justify-center">
                                <i class="fas ${isGift ? 'fa-gift' : 'fa-camera'}"></i>
                            </div>
                        </div>
                        <div id="scanRes" class="hidden"></div>
                        <div class="rounded-2xl overflow-hidden shadow-inner bg-slate-900 relative">
                            <div id="reader" class="w-full"></div>
                            <div class="absolute inset-0 border-[30px] border-slate-900/50 pointer-events-none flex items-center justify-center">
                                <div class="w-64 h-64 border-2 border-white/30 rounded-lg relative">
                                    <div class="absolute top-0 left-0 w-4 h-4 border-l-2 border-t-2 border-white"></div>
                                    <div class="absolute top-0 right-0 w-4 h-4 border-r-2 border-t-2 border-white"></div>
                                    <div class="absolute bottom-0 left-0 w-4 h-4 border-l-2 border-b-2 border-white"></div>
                                    <div class="absolute bottom-0 right-0 w-4 h-4 border-r-2 border-b-2 border-white"></div>
                                </div>
                            </div>
                        </div>
                        ${state.isAdmin ? `
                        <button onclick="${isGift ? 'openManualGift()' : 'openManualCheckin()'}" class="w-full mt-4 py-3 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200 transition-colors border border-slate-200">
                            <i class="fas fa-keyboard mr-2"></i> Mode Manual (Panitia)
                        </button>` : ''}
                    </div>
                    
                    <div class="card p-0 overflow-hidden">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700 text-sm">Status Peserta</h4>
                            <div class="text-xs text-slate-400"><i class="fas fa-sync-alt mr-1"></i> Realtime</div>
                        </div>
                        <div class="p-4">
                            <div class="relative mb-4">
                                <input oninput="window.handleSearch(this)" type="text" placeholder="Cari status peserta..." class="input-field w-full pl-10 py-2 text-sm">
                                <i class="fas fa-search absolute left-3.5 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
                            </div>
                            <div id="manual-list" class="max-h-60 overflow-y-auto custom-scrollbar"></div>
                        </div>
                    </div>`;
            } else if (state.tab === 'data') {
                const isGiftView = state.dataViewMode === 'gifts';
                const data = isGiftView ? state.gifts : state.attendance;
                
                root.innerHTML = `
                    <div class="card p-6 mb-6">
                        <h3 class="font-bold text-xl text-slate-800 mb-1 serif-font">Pusat Data</h3>
                        <p class="text-slate-500 text-sm mb-6">Rekapitulasi acara Bonataon.</p>
                        
                        <div class="flex p-1 bg-slate-100 rounded-xl mb-6">
                            <button onclick="switchDataView('attendance')" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all ${!isGiftView ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-400'}">Kehadiran</button>
                            <button onclick="switchDataView('gifts')" class="flex-1 py-2 text-xs font-bold rounded-lg transition-all ${isGiftView ? 'bg-white text-amber-600 shadow-sm' : 'text-slate-400'}">Berkat</button>
                        </div>
                        
                        <div class="space-y-3">
                            <button onclick="exportData('p')" class="w-full py-3 bg-emerald-600 text-white rounded-xl text-sm font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-700 transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-file-csv"></i> Download Data Master
                            </button>
                            <div class="flex gap-3">
                                <button onclick="exportData('a')" class="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-50">Laporan Hadir</button>
                                <button onclick="exportData('g')" class="flex-1 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl text-xs font-bold hover:bg-slate-50">Laporan Berkat</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center px-2 mb-3">
                        <h4 class="font-bold text-slate-700 text-sm">Riwayat Aktivitas</h4>
                        <span class="text-xs bg-white px-2 py-1 rounded border border-slate-100 text-slate-500">${data.length} Baris</span>
                    </div>
                    
                    <div class="space-y-3 pb-8">
                        ${data.length === 0 ? `<div class="text-center py-10 opacity-50 text-sm">Belum ada data tercatat</div>` : ''}
                        ${data.slice().reverse().map(d => `
                            <div class="bg-white p-4 rounded-xl border-l-4 ${isGiftView ? 'border-amber-400' : 'border-emerald-400'} shadow-sm flex justify-between items-center">
                                <div>
                                    <div class="font-bold text-slate-800 text-sm">${d.name}</div>
                                    <div class="text-[10px] text-slate-400 mt-0.5">${d.marga} â€¢ ${d.timestamp}</div>
                                </div>
                                <i class="fas ${isGiftView ? 'fa-gift text-amber-200' : 'fa-check text-emerald-200'} text-lg"></i>
                            </div>
                        `).join('')}
                    </div>

                    ${state.isAdmin ? `<div class="text-center pt-8"><button onclick="resetData()" class="text-xs text-red-400 hover:text-red-600 font-bold border border-red-100 hover:bg-red-50 px-4 py-2 rounded-full transition-colors"><i class="fas fa-trash-alt mr-1"></i> Reset Sistem (Bahaya)</button></div>` : ''}
                `;
            }
        };

        window.showTicket = (n, st, mg, q) => {
            document.getElementById('ticName').innerText = n;
            document.querySelector('.ticStatusText').innerText = st;
            document.querySelector('.ticMargaText').innerText = mg;
            document.getElementById('ticCode').innerText = q;
            document.getElementById('ticQR').src = getQR(q);
            document.getElementById('btnDownloadTicket').href = getQR(q);
            showModal('ticketModal');
        };

        window.printTicket = () => {
            const w = window.open('', '_blank');
            w.document.write(`
                <html><head><title>Undangan - ${document.getElementById('ticName').innerText}</title>
                <style>
                    body { font-family: sans-serif; text-align: center; border: 4px solid #059669; padding: 40px; margin: 20px; border-radius: 20px; }
                    h1 { color: #064e3b; margin-bottom: 5px; }
                    .tag { background: #ecfdf5; color: #065f46; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 12px; display: inline-block; margin: 5px; }
                    img { margin: 20px 0; border: 1px solid #ddd; padding: 10px; border-radius: 10px; }
                    .footer { font-size: 10px; color: #666; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px; }
                </style></head>
                <body>
                    <h2>BONATAON MANIHURUK 2026</h2>
                    <h1>${document.getElementById('ticName').innerText}</h1>
                    <div><span class="tag">${document.querySelector('.ticStatusText').innerText}</span><span class="tag">${document.querySelector('.ticMargaText').innerText}</span></div>
                    <img src="${document.getElementById('ticQR').src}" width="250">
                    <p style="font-family:monospace;letter-spacing:2px;">${document.getElementById('ticCode').innerText}</p>
                    <div class="footer">Harap bawa undangan ini saat acara berlangsung.</div>
                    <script>window.onload = () => { window.print(); setTimeout(() => window.close(), 500); }<\/script>
                </body></html>`);
            w.document.close();
        };

        // Export/Import functions remain logically same but UI triggered via render
        window.exportData = (type) => {
            let csv = type === 'p' ? "Nama,Status,Marga,Kode,Waktu\n" : "Nama,Status,Marga,Waktu\n";
            let data = type === 'p' ? state.participants : (type === 'a' ? state.attendance : state.gifts);
            let filename = type === 'p' ? "Master_Data" : (type === 'a' ? "Absensi" : "Hadiah");
            
            data.forEach(x => {
                csv += `"${x.name}","${x.status}","${x.marga}","${x.qrCode || x.timestamp}","${x.registeredAt || x.timestamp}"\n`;
            });
            
            const blob = new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Bonataon2026_${filename}.csv`;
            link.click();
        };

        window.importData = (input) => { 
             const f = input.files[0]; if(!f) return;
             const r = new FileReader();
             r.onload = e => {
                 const lines = e.target.result.split('\n');
                 let c = 0;
                 lines.forEach((l,i) => {
                     if(i===0) return;
                     const [n, st, mg] = l.split(',').map(x => x?.replace(/"/g,'').trim());
                     if(n) {
                         const id = (Date.now() + i + Math.floor(Math.random()*1000)).toString();
                         push(ref(db, 'participants'), {
                             id, name: n, status: st || '-', marga: mg || '-',
                             qrCode: `MN-${id.slice(-6)}`, registeredAt: fmtDate(), timestamp: Date.now()
                         });
                         c++;
                     }
                 });
                 showToast(`Berhasil import ${c} data keluarga`, 'success');
                 input.value = '';
             };
             r.readAsText(f);
        };
        
        window.handleImport = (input) => window.importData(input);
        window.triggerImport = () => document.getElementById('importInput').click();

        window.resetData = () => {
            if(prompt("Ketik password admin untuk menghapus database:") === ADMIN_PASS) {
                set(ref(db, 'participants'), null);
                set(ref(db, 'attendance'), null);
                set(ref(db, 'gifts'), null);
                showToast("Sistem berhasil direset total.", 'success');
            }
        };

        setTimeout(() => { document.getElementById('loading').style.display = 'none'; setTab('register'); }, 2000);
    </script>
</body>
</html>
