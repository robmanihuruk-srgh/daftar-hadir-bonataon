<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon Marga Manihuruk Boru Bere / Panagolan 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&family=Playfair+Display:wght@700;800;900&family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
      
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #10b981;
            --emerald-50: #ecfdf5;
            --emerald-500: #34d399;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --royal-gradient: linear-gradient(135deg, #064e3b 0%, #10b981 100%);
        }
          
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.25) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .royal-font { font-family: 'Cinzel', serif; }
          
        .glass-panel {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.4);
        }
          
        .header-bg {
            background: var(--royal-gradient);
            position: relative;
            overflow: hidden;
        }

        .header-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.05;
            pointer-events: none;
        }

        .nav-btn {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 85px;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
            background: white;
            color: #64748b;
        }
        .nav-btn.active {
            background-color: white;
            color: var(--emerald-600);
            border-color: var(--emerald-500);
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.2);
        }

        .logo-frame {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .form-input {
            background-color: #f1f5f9;
            border: 2px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            outline: none;
            transform: translateY(-2px);
        }
        .form-input.valid {
            border-color: var(--emerald-500);
            background-color: #f0fdf4;
        }

        @keyframes modalUp { 
            from { opacity: 0; transform: translateY(40px) scale(0.9); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        .vip-ticket {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }
        .ticket-perforation::before, .ticket-perforation::after {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: #0f172a;
            border-radius: 50%;
            z-index: 10;
        }
        .ticket-perforation::before { left: -15px; }
        .ticket-perforation::after { right: -15px; }

        .no-scrollbar::-webkit-scrollbar { display: none; }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        #notification-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 10000;
            pointer-events: none;
        }
    </style>
</head>
<body class="antialiased">

    <div id="notification-container" class="flex flex-col gap-4"></div>

    <div id="app" class="relative z-10 w-full max-w-4xl mx-auto min-h-screen md:my-10 md:rounded-[3rem] overflow-hidden flex flex-col glass-panel shadow-2xl">
          
        <!-- Loading State -->
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center px-6 text-center">
            <img src="logo tugu manihuruk.png" alt="Logo" class="w-32 h-32 animate-bounce mb-8">
            <h2 class="text-3xl font-black text-emerald-900 mb-2 royal-font uppercase">BONATAON 2026</h2>
            <div class="flex items-center gap-3 text-emerald-600 font-bold mt-4 bg-emerald-50 px-6 py-3 rounded-full shadow-sm">
                <i class="fas fa-circle-notch fa-spin"></i> Menyiapkan Sistem...
            </div>
        </div>

        <header class="header-bg p-10 pb-16 shadow-2xl relative z-20">
            <div class="flex justify-between items-start relative z-10">
                <div class="flex items-center gap-6">
                    <div id="adminTrigger" class="logo-frame w-16 h-16 md:w-24 md:h-24 p-2 border-2 border-white/20">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-lg md:text-2xl font-black text-white royal-font tracking-wide uppercase leading-tight">
                            BONATAON MARGA MANIHURUK<br><span class="text-emerald-300">BORU BERE / PANAGOLAN 2026</span>
                        </h1>
                        <div id="roleBadge" class="hidden inline-block mt-3 px-4 py-1.5 bg-amber-400 text-amber-900 text-[10px] font-black rounded-full uppercase tracking-widest shadow-xl border border-amber-300"></div>
                    </div>
                </div>
                <div id="liveClock" class="text-right text-white hidden md:block backdrop-blur-md bg-white/10 p-3 rounded-2xl border border-white/10"></div>
            </div>
        </header>

        <nav id="mainNav" class="flex px-6 -mt-10 relative z-30 gap-3 overflow-x-auto pb-6 no-scrollbar">
            <!-- Pendaftaran, Absensi, dan Berkat Dihilangkan -->
            <button id="nav-find" class="nav-btn public-tab flex-1 min-w-[130px] shadow-2xl">
                <i class="fas fa-search text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Cek Undangan</span>
            </button>
            <button id="nav-report" class="nav-btn admin-tab hidden flex-1 min-w-[130px] shadow-2xl">
                <i class="fas fa-chart-line text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Dashboard</span>
            </button>
            <button id="nav-data" class="nav-btn admin-tab hidden flex-1 min-w-[130px] shadow-2xl">
                <i class="fas fa-shield-halved text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Admin</span>
            </button>
            <button id="nav-logout" class="hidden min-w-[130px] bg-red-50 text-red-600 border border-red-100 shadow-xl nav-btn">
                <i class="fas fa-power-off"></i><span class="text-[10px] font-black uppercase tracking-widest">Keluar</span>
            </button>
        </nav>

        <main class="flex-1 p-6 md:p-12 overflow-y-auto bg-slate-50/50 pb-28">
            <div id="content-area"></div>
        </main>
          
        <footer class="py-6 px-10 border-t border-slate-200 bg-white absolute bottom-0 w-full z-20">
            <div class="flex justify-between items-center text-[10px] md:text-xs font-black text-slate-400 uppercase tracking-widest">
                <div>© 2026 PANITIA BONATAON</div>
                <div class="text-emerald-900">MANIHURUK BERSATU</div>
            </div>
        </footer>
    </div>

    <!-- Modals Container -->
    <div id="modal-container"></div>

    <!-- LOGIKA APLIKASI (MODULE SCRIPT) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- FIREBASE INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- GLOBAL STATE ---
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            staff: [],
            tab: 'find', // Default dialihkan ke find karena pendaftaran ditiadakan
            isAdmin: false,
            isStaff: false,
            adminPass: "123456",
            recoveryKey: "BONA2026",
            activeUser: null,
            reportSearch: "",
            adminSearch: "",
            filterStatus: "Semua",
            charts: {}
        };

        // --- CORE UI UTILS ---
        const showToast = (title, body, type = 'success') => {
            const container = document.getElementById('notification-container');
            if(!container) return;
            const toast = document.createElement('div');
            const borderColor = type === 'error' ? 'border-red-500' : 'border-emerald-500';
            const iconBg = type === 'error' ? 'bg-red-500' : 'bg-emerald-500';
            const icon = type === 'error' ? 'fa-triangle-exclamation' : 'fa-bell';
            
            toast.className = `glass-panel p-5 rounded-3xl shadow-2xl border-l-4 ${borderColor} flex items-center gap-4 animate-[modalUp_0.4s]`;
            toast.innerHTML = `
                <div class="w-12 h-12 ${iconBg} text-white rounded-2xl flex items-center justify-center text-xl flex-shrink-0 shadow-lg"><i class="fas ${icon}"></i></div>
                <div>
                    <div class="text-xs font-black text-slate-800 uppercase tracking-tight">${title}</div>
                    <div class="text-[10px] text-slate-500 font-bold uppercase mt-1 opacity-70">${body}</div>
                </div>
            `;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(20px)'; toast.style.transition = '0.5s ease'; setTimeout(() => toast.remove(), 500); }, 5000);
        };

        const openModal = (html, id = 'dynamicModal') => {
            const container = document.getElementById('modal-container');
            if(!container) return;
            container.innerHTML = `
                <div id="${id}" class="fixed inset-0 z-[9000] flex items-center justify-center p-6 overflow-y-auto">
                    <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-xl" onclick="document.getElementById('${id}').classList.add('hidden')"></div>
                    <div class="bg-white rounded-[3rem] w-full max-w-md relative z-10 p-10 shadow-2xl animate-[modalUp_0.4s]">
                        ${html}
                    </div>
                </div>
            `;
        };

        const closeModal = (id) => { const el = document.getElementById(id); if (el) el.classList.add('hidden'); };

        // --- DATA BINDING ---
        const updateDashboard = () => {
            // Stats elements removed from UI, but keep the logic for future use or hidden elements
            if (state.tab === 'report') renderReport();
            if (state.tab === 'data') renderAdmin();
            
            const loader = document.getElementById('loading');
            if (loader) setTimeout(() => loader.classList.add('hidden'), 500);
        };

        // --- VALIDATION HELPERS ---
        const setupPinValidation = (inputId, hintId) => {
            const input = document.getElementById(inputId);
            const hint = document.getElementById(hintId);
            if (!input || !hint) return;

            input.oninput = (e) => {
                let val = e.target.value;
                val = val.replace(/\D/g, '');
                e.target.value = val;

                if (val.length >= 6) {
                    hint.innerText = "PIN Valid ✓";
                    hint.classList.remove('text-slate-400', 'text-red-500');
                    hint.classList.add('text-emerald-500');
                    input.classList.add('valid');
                } else if (val.length > 0) {
                    hint.innerText = `Kurang ${6 - val.length} digit lagi...`;
                    hint.classList.remove('text-emerald-500', 'text-slate-400');
                    hint.classList.add('text-red-500');
                    input.classList.remove('valid');
                } else {
                    hint.innerText = "Min. 6 Digit Angka";
                    hint.classList.remove('text-emerald-500', 'text-red-500');
                    hint.classList.add('text-slate-400');
                    input.classList.remove('valid');
                }
            };
        };

        // --- TICKET VIEW ---
        window.showTicket = async (user) => {
            state.activeUser = user;
            const html = `
                <div id="vipTicketCard" class="vip-ticket rounded-[3rem] p-10 shadow-2xl border border-white/10 relative overflow-hidden">
                    <div class="relative z-10 text-center">
                        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl overflow-hidden"><img src="logo tugu manihuruk.png" class="w-14 h-14"></div>
                        <div class="inline-block bg-white/10 backdrop-blur-md border border-white/20 text-white text-[9px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-2">OFFICIAL INVITATION</div>
                        <h2 class="royal-font text-3xl font-black gold-text uppercase leading-none mt-2">BONATAON 2026</h2>
                        <div class="my-10">
                            <p class="text-slate-500 text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Tamu Kehormatan</p>
                            <h1 class="text-2xl font-black text-white leading-tight uppercase mb-4">${user.name}</h1>
                            <div class="inline-flex gap-2 text-[9px] text-emerald-400 font-black uppercase tracking-widest bg-white/5 px-4 py-2 rounded-full border border-white/5">${user.marga} • ${user.status}</div>
                        </div>
                        <div class="ticket-perforation bg-white p-8 rounded-[2.5rem] shadow-2xl relative">
                            <div id="qrLoading" class="w-48 h-48 mx-auto flex items-center justify-center bg-slate-50 rounded-2xl"><i class="fas fa-circle-notch fa-spin text-emerald-600 text-2xl"></i></div>
                            <img id="ticQR" src="" class="w-52 h-52 object-contain mx-auto hidden rounded-xl">
                            <div class="text-center mt-6"><div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1">Registration Code</div><div class="text-xl font-mono font-black text-slate-900 bg-slate-50 py-2 rounded-xl">${user.qrCode}</div></div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex flex-col gap-4">
                    <button id="btnDlTicket" class="w-full py-5 rounded-[1.5rem] bg-slate-900 text-white font-black text-sm shadow-xl flex items-center justify-center gap-3 hover:bg-black transition-all uppercase tracking-widest"><i class="fas fa-download"></i> SIMPAN TIKET</button>
                    <button onclick="document.getElementById('ticketModal').classList.add('hidden')" class="text-slate-400 text-[10px] font-black py-2 uppercase tracking-[0.4em]">Tutup</button>
                </div>
            `;
            openModal(html, 'ticketModal');
            const qrImg = document.getElementById('ticQR'), qrLoader = document.getElementById('qrLoading');
            try { 
                const url = await QRCode.toDataURL(user.qrCode, { errorCorrectionLevel: 'H', margin: 2, width: 800, color: { dark: "#064e3b", light: "#ffffff" } }); 
                if(qrImg) qrImg.src = url; 
                if(qrImg) qrImg.onload = () => { if (qrLoader) qrLoader.classList.add('hidden'); qrImg.classList.remove('hidden'); }; 
            } catch (e) { console.error(e); }
            const dlBtn = document.getElementById('btnDlTicket');
            if(dlBtn) dlBtn.onclick = handleDownloadTicket;
        };

        const handleDownloadTicket = () => {
            const card = document.getElementById('vipTicketCard');
            if(!card) return;
            html2canvas(card, { scale: 3, backgroundColor: '#0f172a' }).then(canvas => {
                const link = document.createElement('a'); link.download = `Tiket_Bonataon_${state.activeUser.name}.png`; link.href = canvas.toDataURL(); link.click();
            });
        };

        // --- ADMIN LOGIN ---
        const renderAdminLogin = () => {
            const html = `
                <div class="text-center mb-8"><div class="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner transform rotate-12"><i class="fas fa-lock text-3xl"></i></div><h3 class="text-2xl font-black text-slate-800 tracking-tight uppercase royal-font">Akses Panitia</h3><p class="text-[10px] text-slate-400 font-black uppercase mt-2 tracking-[0.2em]">Verifikasi Keamanan</p></div>
                <input type="password" id="adminPassword" placeholder="••••••••" maxlength="12" class="form-input w-full rounded-2xl p-5 text-center text-4xl font-black mb-6 tracking-[0.5em] shadow-inner">
                <button id="btnLoginAdmin" class="w-full py-5 bg-emerald-600 text-white rounded-[1.5rem] font-black hover:bg-emerald-700 transition-all shadow-xl uppercase tracking-widest">MASUK</button>
                <div class="mt-6 text-center"><button id="btnForgotAdmin" class="text-xs font-black text-emerald-600 uppercase tracking-widest underline underline-offset-8">Lupa PIN Admin?</button></div>
            `;
            openModal(html, 'adminModal');
            const loginBtn = document.getElementById('btnLoginAdmin');
            if(loginBtn) {
                loginBtn.onclick = () => {
                    const pin = document.getElementById('adminPassword').value;
                    if (pin === state.adminPass) { state.isAdmin = true; state.isStaff = false; closeModal('adminModal'); refreshUI(); setTab('report'); } 
                    else { const staff = state.staff.find(s => s.pin === pin); if (staff) { state.isStaff = true; state.isAdmin = false; closeModal('adminModal'); refreshUI(); setTab('find'); } else { alert("PIN Salah!"); } }
                };
            }
            const forgotBtn = document.getElementById('btnForgotAdmin');
            if(forgotBtn) forgotBtn.onclick = renderAdminRecovery;
        };

        const renderAdminRecovery = () => {
            closeModal('adminModal');
            const html = `
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-amber-50 text-amber-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner"><i class="fas fa-shield-halved text-3xl"></i></div>
                    <h3 class="text-2xl font-black text-slate-800 uppercase royal-font tracking-tight">Recovery Admin</h3>
                    <p class="text-[10px] text-slate-400 font-black uppercase mt-2 tracking-widest">Gunakan Kode Pemulihan Anda</p>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">Kode Pemulihan</label>
                        <input id="recKey" type="text" placeholder="BONA2026" class="form-input w-full rounded-2xl p-4 font-black uppercase tracking-widest text-center border-slate-200">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">PIN Admin Baru</label>
                        <input id="recNewPin" type="password" inputmode="numeric" maxlength="12" placeholder="••••••••" class="form-input w-full rounded-2xl p-4 font-black text-center text-2xl tracking-[0.5em]">
                        <div id="recPinHint" class="text-[9px] font-bold mt-2 pl-2 text-slate-400 uppercase tracking-widest">Min. 6 Digit Angka</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <button onclick="closeModal('recoveryModal'); renderAdminLogin();" class="py-5 border-2 border-slate-100 rounded-2xl font-black text-slate-400 text-xs uppercase tracking-widest">Batal</button>
                        <button id="btnSubmitRecovery" class="py-5 bg-emerald-600 text-white rounded-2xl font-black shadow-xl text-xs uppercase tracking-widest">Reset PIN</button>
                    </div>
                </div>
            `;
            openModal(html, 'recoveryModal');
            setupPinValidation('recNewPin', 'recPinHint');
            
            document.getElementById('btnSubmitRecovery').onclick = () => {
                const key = document.getElementById('recKey').value.trim();
                const newPin = document.getElementById('recNewPin').value;
                if (key !== state.recoveryKey) return showToast("Recovery Gagal", "Kode Pemulihan Salah!", "error");
                if (newPin.length < 6) return showToast("Input Invalid", "PIN Baru minimal 6 digit!", "error");
                set(ref(db, 'settings/adminPin'), newPin).then(() => {
                    showToast("PIN Diperbarui", "Gunakan PIN baru untuk akses admin.");
                    closeModal('recoveryModal');
                    renderAdminLogin();
                });
            };
        };

        const refreshUI = () => {
            const roleBadge = document.getElementById('roleBadge'), logoutBtn = document.getElementById('nav-logout'), navItems = document.querySelectorAll('.nav-btn');
            if (state.isAdmin || state.isStaff) { if(roleBadge) { roleBadge.classList.remove('hidden'); roleBadge.innerText = state.isAdmin ? "Mode Administrator" : "Petugas Lapangan"; } if(logoutBtn) logoutBtn.classList.remove('hidden'); } 
            else { if(roleBadge) roleBadge.classList.add('hidden'); if(logoutBtn) logoutBtn.classList.add('hidden'); }
            navItems.forEach(btn => {
                const isAdminT = btn.classList.contains('admin-tab'), isPublicT = btn.classList.contains('public-tab');
                if (state.isAdmin) btn.classList.remove('hidden');
                else if (state.isStaff) { if (isPublicT) btn.classList.remove('hidden'); else btn.classList.add('hidden'); }
                else { if (isPublicT) btn.classList.remove('hidden'); else btn.classList.add('hidden'); }
            });
        };

        // --- REPORT ---
        const renderReport = () => {
            const area = document.getElementById('content-area');
            if(!area) return;
            area.innerHTML = `
                <div class="space-y-8 animate-[modalUp_0.5s]">
                    <div class="flex justify-between items-center px-4"><h3 class="text-2xl font-black text-slate-800 royal-font uppercase tracking-tight flex items-center gap-3"><span class="live-dot"></span> Dashboard Real-time</h3></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100"><h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Demografi Peserta</h4><div class="relative aspect-square"><canvas id="catChart"></canvas></div></div>
                        <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 flex flex-col justify-center items-center text-center p-12">
                            <div class="text-4xl font-black text-emerald-600 mb-2">${state.participants.length}</div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Total Peserta Terdaftar</div>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden">
                        <div class="flex flex-wrap justify-between items-center gap-5 mb-8"><h4 class="text-sm font-black text-slate-800 uppercase tracking-widest flex items-center gap-3"><i class="fas fa-list-check text-emerald-600"></i> Daftar Undangan Terbit</h4><div class="relative w-full md:w-64"><input type="text" id="repSearch" value="${state.reportSearch}" placeholder="CARI PESERTA..." class="form-input w-full rounded-2xl py-3 px-10 text-[10px] font-black uppercase shadow-sm"><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-left text-[10px]"><thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest border-b border-slate-100"><tr><th class="p-4">Peserta</th><th class="p-4">Kategori</th><th class="p-4">Marga</th><th class="p-4">Status Absensi</th></tr></thead><tbody class="divide-y divide-slate-50">${state.participants.filter(p => p.name.toLowerCase().includes(state.reportSearch.toLowerCase())).map(p => { const log = state.attendance.find(a => a.qrCode === p.qrCode); return `<tr><td class="p-4"><div class="font-black text-slate-800 text-[11px] uppercase">${p.name}</div></td><td class="p-4 font-bold text-slate-500 uppercase">${p.status}</td><td class="p-4 font-bold text-slate-500 uppercase">${p.marga}</td><td class="p-4">${log ? '<span class="text-emerald-600 font-black">TERABSENSI</span>' : '<span class="text-slate-300 font-black">BELUM HADIR</span>'}</td></tr>`; }).join('')}</tbody></table></div>
                    </div>
                </div>
            `;
            const searchIn = document.getElementById('repSearch');
            if(searchIn) searchIn.onkeyup = (e) => { state.reportSearch = e.target.value; renderReport(); };
            
            const chartCanvas = document.getElementById('catChart');
            if(chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                const labels = ['Orangtua', 'Pemuda', 'Sekolah Minggu', 'Tamu'], data = labels.map(l => state.participants.filter(p => p.status === l).length);
                if (state.charts.catChart) state.charts.catChart.destroy();
                state.charts.catChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data, backgroundColor: ['#064e3b', '#10b981', '#34d399', '#f59e0b'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { font: { weight: '800', size: 10 }, padding: 20 } } }, cutout: '70%' } });
            }
        };

        // --- ADMIN PANEL ---
        const renderAdmin = () => {
            const area = document.getElementById('content-area');
            if(!area) return;
            area.innerHTML = `
                <div class="space-y-8 animate-[modalUp_0.5s]">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-slate-100">
                        <div class="flex flex-wrap justify-between items-center gap-5 mb-10">
                            <h3 class="text-xl font-black text-slate-800 flex items-center gap-3 tracking-tight uppercase royal-font"><i class="fas fa-crown text-emerald-600"></i> Admin Panel</h3>
                            <div class="flex flex-wrap gap-3">
                                <button id="btnExpAll" class="bg-amber-100 px-5 py-3 rounded-2xl text-amber-900 text-[10px] font-black uppercase tracking-widest shadow-md flex items-center gap-2 border border-amber-200">
                                    <i class="fas fa-file-export"></i> EKSPOR DATABASE
                                </button>
                                <button id="btnResetAll" class="bg-red-50 px-5 py-3 rounded-2xl text-red-700 text-[10px] font-black uppercase tracking-widest shadow-sm">RESET SISTEM</button>
                            </div>
                        </div>
                        
                        <div class="border-t border-slate-100 pt-12">
                            <div class="flex items-center gap-3 mb-8"><div class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-users-gear"></i></div><h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Manajemen Staff</h4></div>
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-8">
                                <div class="md:col-span-5"><input id="stfName" type="text" placeholder="NAMA LENGKAP" class="form-input w-full rounded-2xl p-4 text-[11px] font-black uppercase shadow-inner"></div>
                                <div class="md:col-span-3"><input id="stfPin" type="password" maxlength="6" placeholder="PIN (6 DIGIT)" class="form-input w-full rounded-2xl p-4 text-[11px] font-black text-center shadow-inner"></div>
                                <div class="md:col-span-4"><button id="btnAddStaff" class="w-full h-full bg-slate-900 text-white rounded-2xl font-black text-[11px] uppercase tracking-widest hover:bg-black transition-all shadow-xl py-4 md:py-0">TAMBAH</button></div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${state.staff.map(s => `<div class="bg-slate-50 p-5 rounded-[1.5rem] border border-slate-100 flex justify-between items-center shadow-sm"><div><div class="font-black text-slate-800 text-[11px] uppercase tracking-wide">${s.name}</div><div class="text-[9px] text-emerald-600 font-black uppercase mt-1 bg-emerald-50 px-2 py-0.5 rounded-full inline-block border border-emerald-100">PIN: ${s.pin}</div></div><button onclick="window.adminRemoveStaff('${s.firebaseId}')" class="text-red-400 hover:text-red-600 w-10 h-10 flex items-center justify-center bg-white rounded-xl shadow-inner border border-slate-100"><i class="fas fa-trash-can text-xs"></i></button></div>`).join('') || '<div class="col-span-full text-center py-10 text-slate-300 font-black text-[10px] uppercase">Belum Ada Petugas</div>'}</div>
                        </div>
                    </div>
                </div>
            `;
            
            const staffAdd = document.getElementById('btnAddStaff');
            const expAllBtn = document.getElementById('btnExpAll');
            const resetBtn = document.getElementById('btnResetAll');
            
            if(staffAdd) staffAdd.onclick = handleAddStaff;
            if(expAllBtn) expAllBtn.onclick = () => {
                if(!state.participants.length) return alert("Tidak ada data untuk diekspor.");
                exportToCSV(state.participants, "Database_Lengkap_Bonataon_2026");
                showToast("Ekspor Berhasil", "Database peserta sedang diunduh.");
            };
            if(resetBtn) resetBtn.onclick = () => { if (confirm("Ketik 'RESET' untuk menghapus SEMUA data?")) { const v = prompt("Ketik RESET:"); if (v === 'RESET') { Promise.all([set(ref(db, 'participants'), null), set(ref(db, 'attendance'), null), set(ref(db, 'gifts'), null)]).then(() => alert("Data telah dibersihkan!")); } } };
        };

        const handleAddStaff = () => {
            const nameEl = document.getElementById('stfName'), pinEl = document.getElementById('stfPin');
            const n = nameEl.value.trim().toUpperCase(), p = pinEl.value;
            if (!n || p.length < 6) return alert("Nama harus diisi dan PIN minimal 6 digit!");
            push(ref(db, 'staff'), { name: n, pin: p }).then(() => { 
                showToast("Staff Ditambahkan", n); 
                nameEl.value = ''; pinEl.value = ''; 
            });
        };

        const exportToCSV = (data, name) => {
            if(!data.length) return;
            const cleanData = data.map(({ firebaseId, password, ...rest }) => rest);
            const headers = Object.keys(cleanData[0] || {}), rows = cleanData.map(o => headers.map(h => `"${o[h]}"`).join(","));
            const content = "\ufeff" + headers.join(",") + "\n" + rows.join("\n"), blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `${name}.csv`; link.click();
        };

        window.adminRemoveStaff = (id) => { if (confirm("Hapus Staff ini?")) remove(ref(db, 'staff/' + id)); };

        // --- NAVIGATION ---
        const setTab = async (t) => {
            state.tab = t;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.toggle('active', btn.id === `nav-${t}`));
            const area = document.getElementById('content-area');
            if(!area) return;

            if (t === 'find') {
                area.innerHTML = `
                    <div class="bg-white rounded-[2.5rem] p-10 md:p-16 shadow-2xl text-center border border-slate-100 animate-[modalUp_0.4s]">
                        <div class="w-24 h-24 bg-emerald-50 rounded-[2rem] flex items-center justify-center mx-auto mb-10 text-emerald-600 text-4xl shadow-inner"><i class="fas fa-magnifying-glass"></i></div>
                        <h3 class="font-black text-2xl mb-10 text-slate-800 uppercase royal-font tracking-tight">Cari Undangan Digital</h3>
                        <div class="space-y-6"><input id="findIn" type="text" placeholder="Masukkan Nama Sesuai Database" class="form-input w-full rounded-2xl p-6 text-center font-black uppercase text-lg shadow-inner"><button id="btnFind" class="w-full bg-emerald-700 text-white rounded-[1.5rem] py-6 font-black hover:bg-emerald-800 transition-all shadow-2xl uppercase tracking-[0.2em]">LIHAT TIKET</button></div>
                    </div>
                `;
                document.getElementById('btnFind').onclick = () => {
                    const q = document.getElementById('findIn').value.trim().toLowerCase();
                    const found = state.participants.filter(p => p.name.toLowerCase().includes(q));
                    if (!found.length) return alert("Nama tidak terdaftar di database panitia.");
                    if (found.length === 1) handleTicketAuth(found[0]); else alert("Ketik Nama Lebih Lengkap!");
                };
            }
            else if (t === 'report') renderReport();
            else if (t === 'data') renderAdmin();
        };

        const handleTicketAuth = (user) => {
            const html = `<h3 class="text-2xl font-black text-slate-800 text-center uppercase royal-font mb-4 tracking-tight">Verifikasi PIN</h3><p class="text-[10px] text-slate-400 font-black text-center mb-8 uppercase tracking-widest">Masukkan PIN untuk <span class="text-emerald-600">${user.name}</span></p><input type="password" id="pinAuth" inputmode="numeric" maxlength="8" class="form-input w-full rounded-2xl p-6 text-center text-4xl font-black mb-8 tracking-[0.5em] shadow-inner" placeholder="••••••••"><div class="grid grid-cols-2 gap-4"><button onclick="document.getElementById('authModal').classList.add('hidden')" class="py-5 border-2 border-slate-100 rounded-2xl font-black text-slate-400 uppercase tracking-widest text-xs">Batal</button><button id="btnVerify" class="py-5 bg-emerald-600 text-white rounded-2xl font-black shadow-xl uppercase tracking-widest text-xs">VERIFIKASI</button></div>`;
            openModal(html, 'authModal');
            document.getElementById('btnVerify').onclick = () => { 
                const pin = document.getElementById('pinAuth').value; 
                if (pin === user.password) { closeModal('authModal'); window.showTicket(user); } else alert("PIN yang Anda masukkan salah!"); 
            };
        };

        // --- DATA LISTENERS ---
        onValue(ref(db, 'participants'), s => { state.participants = s.val() ? Object.keys(s.val()).map(k => ({...s.val()[k], firebaseId: k})) : []; updateDashboard(); });
        onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; });
        onValue(ref(db, 'staff'), s => { state.staff = s.val() ? Object.keys(s.val()).map(k => ({...s.val()[k], firebaseId: k})) : []; updateDashboard(); });
        onValue(ref(db, 'settings/adminPin'), s => { if (s.val()) state.adminPass = s.val(); });

        setInterval(() => { const el = document.getElementById('liveClock'); if (!el) return; const now = new Date(); el.innerHTML = `<div class="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">${now.toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</div><div class="text-2xl font-black">${now.toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</div>`; }, 1000);

        document.getElementById('adminTrigger').onclick = renderAdminLogin;
        document.getElementById('nav-find').onclick = () => setTab('find');
        document.getElementById('nav-report').onclick = () => setTab('report');
        document.getElementById('nav-data').onclick = () => setTab('data');
        document.getElementById('nav-logout').onclick = () => { if (confirm("Keluar dari sistem?")) { state.isAdmin = false; state.isStaff = false; refreshUI(); setTab('find'); } };

        setTab('find'); refreshUI();
        window.closeModal = closeModal;
    </script>
</body>
</html>
