<!DOCTYPE html>

<html lang="id">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Absensi Event BONATAON 2025 - Manihuruk</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

    

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    

    <style>

        body { font-family: 'Inter', sans-serif; }

        

        /* CSS Scanner */

        #reader { 

            width: 100%; 

            background: #000; 

            border-radius: 12px;

            border: none;

        }

        #reader video { 

            object-fit: cover; 

            border-radius: 12px;

            transform: scaleX(-1); 

        }

        #reader__dashboard_section_csr span, 

        #reader__dashboard_section_swaplink { display: none !important; }

        #reader__filescan_input_label { display: none; } 

        #reader__dashboard_section_csr button {

            background-color: #16a34a; color: white; padding: 8px 16px;

            border-radius: 8px; border: none; font-weight: bold; margin-top: 10px;

        }



        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        .animate-pulse-soft { animation: pulse-soft 2s infinite; }

        img.qr-code { image-rendering: pixelated; }

    </style>

</head>

<body class="min-h-screen bg-gray-50 text-gray-800 font-sans">



    <div class="fixed inset-0 pointer-events-none opacity-5 overflow-hidden z-0 select-none">

        <div class="absolute top-10 left-10 text-9xl">üéÑ</div>

        <div class="absolute bottom-10 right-10 text-9xl">üéÖ</div>

    </div>



    <div id="app" class="relative z-10 max-w-md mx-auto md:max-w-4xl min-h-screen bg-white shadow-2xl md:my-8 md:rounded-3xl overflow-hidden flex flex-col">

        

        <div id="loading" class="absolute inset-0 z-50 bg-white flex flex-col justify-center items-center">

            <div class="text-5xl mb-4 animate-bounce">‚ùÑÔ∏è</div>

            <div class="font-bold text-gray-500">Memuat Sistem Manihuruk...</div>

        </div>



        <header class="bg-gradient-to-r from-red-800 to-red-600 text-white p-6 pb-14 shadow-lg">

            <div class="flex justify-between items-start">

                <div>

                    <h1 class="text-3xl font-extrabold tracking-tight">BONATAON 2025</h1>

                    <p class="text-red-100 text-xs font-medium tracking-wider uppercase opacity-90">Manihuruk</p>

                </div>

                <div class="text-right">

                    <div id="liveClock" class="text-xl font-mono font-bold">00:00</div>

                    <div id="liveDate" class="text-[10px] text-red-200 uppercase font-semibold">...</div>

                </div>

            </div>

            

            <div class="flex gap-2 mt-6 overflow-x-auto pb-2">

                <div class="bg-black/20 backdrop-blur-md rounded-xl p-3 min-w-[90px] border border-white/10">

                    <div class="text-2xl font-bold" id="statRegistered">0</div>

                    <div class="text-[9px] uppercase font-bold text-red-100">Jemaat</div>

                </div>

                <div class="bg-black/20 backdrop-blur-md rounded-xl p-3 min-w-[90px] border border-white/10">

                    <div class="text-2xl font-bold text-green-300" id="statPresent">0</div>

                    <div class="text-[9px] uppercase font-bold text-red-100">Hadir</div>

                </div>

                <div class="bg-yellow-500/30 backdrop-blur-md rounded-xl p-3 min-w-[90px] border border-white/10">

                    <div class="text-2xl font-bold text-yellow-300" id="statGifts">0</div>

                    <div class="text-[9px] uppercase font-bold text-red-100">Hadiah</div>

                </div>

            </div>

        </header>



        <nav class="flex px-4 -mt-10 relative z-20 gap-2 overflow-x-auto pb-2 no-scrollbar">

            <button onclick="setTab('register')" id="tab-register" class="flex-1 py-3 px-4 rounded-xl shadow-lg text-xs font-bold transition-all transform hover:-translate-y-1 bg-white text-gray-400 whitespace-nowrap">üìù Daftar</button>

            <button onclick="setTab('scan')" id="tab-scan" class="flex-1 py-3 px-4 rounded-xl shadow-lg text-xs font-bold transition-all transform hover:-translate-y-1 bg-white text-gray-400 whitespace-nowrap">üì∑ Absen</button>

            <button onclick="setTab('gift')" id="tab-gift" class="flex-1 py-3 px-4 rounded-xl shadow-lg text-xs font-bold transition-all transform hover:-translate-y-1 bg-white text-gray-400 whitespace-nowrap">üéÅ Hadiah</button>

            <button onclick="setTab('data')" id="tab-data" class="flex-1 py-3 px-4 rounded-xl shadow-lg text-xs font-bold transition-all transform hover:-translate-y-1 bg-white text-gray-400 whitespace-nowrap">üìä Data</button>

        </nav>



        <main class="flex-1 p-6 overflow-y-auto bg-gray-50 pb-24">

            <div id="content-area"></div>

        </main>

    </div>



    <div id="confirmModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 hidden backdrop-blur-sm transition-opacity opacity-0">

        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform">

            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Konfirmasi Data</h3>

            <div class="space-y-3 mb-6">

                <div><div class="text-xs text-gray-400 font-bold uppercase">Nama</div><div id="confName" class="font-bold text-lg text-gray-800"></div></div>

                <div class="flex gap-4">

                    <div class="flex-1"><div class="text-xs text-gray-400 font-bold uppercase">Kategori</div><div id="confClass" class="font-bold text-purple-600"></div></div>

                    <div class="flex-1"><div class="text-xs text-gray-400 font-bold uppercase">Marga</div><div id="confSector" class="font-bold text-blue-600"></div></div>

                </div>

            </div>

            <div class="flex gap-3">

                <button onclick="closeModal('confirmModal')" class="flex-1 py-3 rounded-lg font-bold text-gray-600 bg-gray-100 hover:bg-gray-200">Ubah</button>

                <button onclick="processSave()" class="flex-1 py-3 rounded-lg font-bold text-white bg-green-600 hover:bg-green-700 shadow-lg">Simpan</button>

            </div>

        </div>

    </div>



    <div id="ticketModal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/90 hidden backdrop-blur-sm transition-opacity opacity-0">

        <div class="bg-white w-full max-w-sm rounded-2xl p-6 text-center transform scale-95 transition-transform relative">

            <button onclick="closeModal('ticketModal')" class="absolute top-4 right-4 text-2xl text-gray-400 hover:text-red-500">√ó</button>

            <div class="text-red-600 font-bold tracking-widest text-xs mb-1 uppercase">Tiket BONATAON</div>

            <h2 id="ticName" class="text-2xl font-black text-gray-800 leading-tight mb-2">Nama</h2>

            <div class="flex justify-center gap-2 mb-4">

                <span id="ticClass" class="px-2 py-1 bg-purple-100 text-purple-700 text-xs font-bold rounded">Kategori</span>

                <span id="ticSector" class="px-2 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded">Marga</span>

            </div>

            <div class="bg-white border-4 border-gray-200 p-4 rounded-xl shadow-inner mb-4 inline-block">

                <img id="ticQR" src="" class="w-48 h-48 object-contain qr-code">

            </div>

            <p class="text-xs text-gray-400 font-medium">Gunakan QR ini untuk Absensi & Pengambilan Hadiah</p>

            <button onclick="closeModal('ticketModal')" class="mt-4 w-full py-3 bg-gray-100 font-bold text-gray-600 rounded-xl hover:bg-gray-200">Tutup</button>

        </div>

    </div>



    <!-- Modal Login Admin -->
    <div id="adminLoginModal" class="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 hidden backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl transform scale-95 transition-transform">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Login Admin</h3>
            <p class="text-sm text-gray-600 mb-4">Masukkan password admin untuk akses manual check-in</p>
            <input type="password" id="adminPassword" placeholder="Password Admin" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold focus:border-red-500 outline-none mb-4">
            <div class="flex gap-3">
                <button onclick="closeModal('adminLoginModal')" class="flex-1 py-3 rounded-lg font-bold text-gray-600 bg-gray-100 hover:bg-gray-200">Batal</button>
                <button onclick="adminLogin()" class="flex-1 py-3 rounded-lg font-bold text-white bg-red-600 hover:bg-red-700 shadow-lg">Login</button>
            </div>
        </div>
    </div>



    <input type="file" id="importInput" accept=".csv" class="hidden" onchange="handleImport(this)">



    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

        import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";



        const firebaseConfig = {

            apiKey: "AIzaSyBzka8Ps_nf-8zDA2tMDmqEMw6zMoy3aeM",

            authDomain: "eventnatal2025.firebaseapp.com",

            databaseURL: "https://eventnatal2025-default-rtdb.asia-southeast1.firebasedatabase.app/", 

            projectId: "eventnatal2025",

            storageBucket: "eventnatal2025.firebasestorage.app",

            messagingSenderId: "961570070334",

            appId: "1:961570070334:web:888638e9de275e27b2566f",

            measurementId: "G-QX5GJPEDCF"

        };



        const app = initializeApp(firebaseConfig);

        const db = getDatabase(app);

        const ADMIN_PASS = "ADMIN123";



        let state = {

            participants: [],

            attendance: [],

            gifts: [],

            tab: 'register',

            scanner: null,

            tempData: null,

            searchTerm: '',

            isAdminLoggedIn: false

        };



        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function beep(type = 'success') {

            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();

            const gain = audioCtx.createGain();

            osc.type = type === 'success' ? 'sine' : 'square';

            osc.frequency.setValueAtTime(type === 'success' ? 880 : 300, audioCtx.currentTime);

            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);

            osc.connect(gain); gain.connect(audioCtx.destination);

            osc.start(); osc.stop(audioCtx.currentTime + 0.15);

        }



        const getClock = () => {

            const n = new Date();

            document.getElementById('liveClock').innerText = n.toLocaleTimeString('id-ID', {hour12: false});

            document.getElementById('liveDate').innerText = n.toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'});

        };

        setInterval(getClock, 1000); getClock();



        const fmtDate = () => new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });

        const getQR = (txt) => `https://api.qrserver.com/v1/create-qr-code/?size=500x500&margin=20&ecc=L&color=000000&bgcolor=ffffff&data=${encodeURIComponent(txt)}`;



        // --- LISTENERS ---

        onValue(ref(db, 'participants'), s => {

            state.participants = s.val() ? Object.values(s.val()) : [];

            updateStats();

            if (state.tab !== 'register') {

                render();

            } else {

                renderParticipantListOnly();

            }

        });

        

        onValue(ref(db, 'attendance'), s => {

            state.attendance = s.val() ? Object.values(s.val()) : [];

            updateStats();

            if (state.tab === 'data') render();

            document.getElementById('loading').style.display = 'none';

        });



        onValue(ref(db, 'gifts'), s => {

            state.gifts = s.val() ? Object.values(s.val()) : [];

            updateStats();

            if (state.tab === 'data' || state.tab === 'gift') render();

        });



        function updateStats() {

            document.getElementById('statRegistered').innerText = state.participants.length;

            document.getElementById('statPresent').innerText = state.attendance.length;

            document.getElementById('statGifts').innerText = state.gifts.length;

        }



        // --- CORE LOGIC ---

        window.preRegister = () => {

            const name = document.getElementById('inName').value.trim();

            const cls = document.getElementById('inClass').value;

            const sec = document.getElementById('inSector').value;

            if(!name || !cls || !sec) return alert("Mohon lengkapi semua data!");

            state.tempData = { name, cls, sec };

            document.getElementById('confName').innerText = name;

            document.getElementById('confClass').innerText = cls;

            document.getElementById('confSector').innerText = sec;

            const m = document.getElementById('confirmModal');

            m.classList.remove('hidden');

            setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.replace('scale-95','scale-100'); }, 10);

        };



        window.processSave = () => {

            if(!state.tempData) return;

            const { name, cls, sec } = state.tempData;

            const id = Date.now().toString();

            const qr = `BONATAON-${id.slice(-6)}`;

            push(ref(db, 'participants'), {

                id, name, classGrade: cls, sector: sec, qrCode: qr,

                registeredAt: fmtDate(), timestamp: Date.now()

            });

            window.closeModal('confirmModal');

            document.getElementById('inName').value = '';

            

            document.getElementById('ticName').innerText = name;

            document.getElementById('ticClass').innerText = cls;

            document.getElementById('ticSector').innerText = sec;

            document.getElementById('ticQR').src = getQR(qr);

            const t = document.getElementById('ticketModal');

            t.classList.remove('hidden');

            setTimeout(() => { t.classList.remove('opacity-0'); t.children[0].classList.replace('scale-95','scale-100'); }, 10);

        };



        // --- LOGIKA SCAN (ABSEN & HADIAH) ---

        window.processScannedID = (pid) => {

            const p = state.participants.find(x => x.id === pid);

            if(!p) return;



            if (state.tab === 'gift') {

                window.claimGift(p);

            } else {

                window.doCheckIn(p);

            }

        };



        window.doCheckIn = (p) => {

            const exists = state.attendance.find(x => x.participantId === p.id);

            if(exists) {

                beep('fail');

                showScanResult(false, `‚ö†Ô∏è ${p.name} Sudah Absen!`);

            } else {

                beep('success');

                push(ref(db, 'attendance'), {

                    id: Date.now().toString(), participantId: p.id, name: p.name,

                    classGrade: p.classGrade, sector: p.sector, timestamp: fmtDate()

                });

                showScanResult(true, `‚úÖ ${p.name} Hadir!`);

            }

        };



        // Modul Hadiah

        window.claimGift = (p) => {

            const alreadyClaimed = state.gifts.find(x => x.participantId === p.id);

            if(alreadyClaimed) {

                beep('fail');

                showScanResult(false, `‚ö†Ô∏è ${p.name} Sudah Ambil Hadiah!`, 'bg-yellow-500');

            } else {

                beep('success');

                push(ref(db, 'gifts'), {

                    id: Date.now().toString(), participantId: p.id, name: p.name,

                    classGrade: p.classGrade, sector: p.sector, timestamp: fmtDate()

                });

                showScanResult(true, `üéÅ ${p.name} Dapat Hadiah!`, 'bg-purple-600');

            }

        };



        // --- SCANNER SYSTEM ---

        window.initScanner = () => {

            if(state.scanner) return;

            const config = { fps: 10, qrbox: 450, aspectRatio: 1.0, disableFlip: false };

            state.scanner = new Html5QrcodeScanner("reader", config, false);

            

            state.scanner.render((decodedText) => {

                if(state.scanner) state.scanner.pause();

                const p = state.participants.find(x => x.qrCode === decodedText);

                

                if(p) window.processScannedID(p.id);

                else { beep('fail'); showScanResult(false, "‚ùå QR Tidak Dikenal"); }

                

                setTimeout(() => { if(state.scanner) state.scanner.resume(); }, 2500);

            }, (error) => {});

        };



        window.stopScanner = () => {

            if(state.scanner) {

                state.scanner.clear().catch(e => console.error(e));

                state.scanner = null;

            }

        };



        function showScanResult(success, msg, customColor) {

            const el = document.getElementById('scanRes');

            if(el) {

                el.innerHTML = msg;

                const color = customColor ? customColor : (success ? 'bg-green-500' : 'bg-red-500');

                el.className = `p-4 rounded-xl font-bold text-center text-white shadow-lg animate-pulse mb-4 ${color}`;

                el.classList.remove('hidden');

                setTimeout(() => { el.classList.add('hidden'); }, 2000);

            }

        }



        // --- HELPERS ---

        window.handleSearch = (el) => {

            state.searchTerm = el.value.toLowerCase();

            const container = document.getElementById('manual-list');

            if(!container) return;

            const filtered = state.participants.filter(p => p.name.toLowerCase().includes(state.searchTerm));

            

            if(filtered.length === 0) {

                container.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">Nama tidak ditemukan</div>';

                return;

            }

            container.innerHTML = generateListHTML(filtered, state.tab === 'gift');

        };



        function generateListHTML(list, isGiftMode) {

            return list.map(p => {

                let statusBadge = '';

                let actionBtn = '';

                const hasGift = state.gifts.find(g => g.participantId === p.id);
                const hasAttended = state.attendance.find(a => a.participantId === p.id);



                if (isGiftMode) {

                    const claimed = state.gifts.find(g => g.participantId === p.id);

                    if (claimed) statusBadge = `<span class="text-purple-600 font-bold text-xs bg-purple-100 px-3 py-1 rounded-lg">üéÅ DIAMBIL</span>`;

                    else actionBtn = `<button onclick="adminManualAction('${p.id}')" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-purple-700">AMBIL</button>`;

                } else {

                    const present = state.attendance.find(a => a.participantId === p.id);

                    if (present) {
                        if (hasGift) {
                            statusBadge = `<span class="text-yellow-600 font-bold text-xs bg-yellow-100 px-3 py-1 rounded-lg">üéÅ Ambil</span>`;
                        } else {
                            statusBadge = `<span class="text-green-600 font-bold text-xs bg-green-50 px-3 py-1 rounded-lg">HADIR</span>`;
                        }
                    } else actionBtn = `<button onclick="adminManualAction('${p.id}')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-xs font-bold hover:bg-blue-700">CHECK-IN</button>`;

                }



                return `

                <div class="flex items-center justify-between p-3 border-b border-gray-100 hover:bg-gray-50 ${hasGift ? 'border-l-4 border-l-yellow-500' : hasAttended ? 'border-l-4 border-l-green-500' : ''}">

                    <div>

                        <div class="font-bold text-gray-800 text-sm">${p.name}</div>

                        <div class="flex gap-2 mt-1">

                            <span class="text-[10px] bg-gray-100 text-gray-700 px-2 py-0.5 rounded font-bold">${p.classGrade}</span>

                            <span class="text-[10px] bg-gray-100 text-gray-700 px-2 py-0.5 rounded font-bold">${p.sector}</span>

                        </div>

                    </div>

                    ${statusBadge || actionBtn}

                </div>`;

            }).join('');

        }



        // Fungsi untuk admin manual action (check-in atau ambil hadiah)
        window.adminManualAction = (pid) => {
            if (!state.isAdminLoggedIn) {
                showScanResult(false, "‚ö†Ô∏è Hanya admin yang bisa melakukan ini!");
                return;
            }

            const p = state.participants.find(x => x.id === pid);
            if(!p) return;

            if (state.tab === 'gift') {
                window.claimGift(p);
            } else {
                window.doCheckIn(p);
            }
            
            // Update UI secara langsung
            setTimeout(() => {
                if (state.searchTerm) {
                    window.handleSearch(document.getElementById('adminSearchInput'));
                }
            }, 500);
        };



        function renderParticipantListOnly() {

            const listContainer = document.getElementById('participant-list-container');

            if (listContainer) {

                listContainer.innerHTML = state.participants.slice().reverse().map(p => {

                    const active = state.attendance.find(a => a.participantId === p.id);
                    const hasGift = state.gifts.find(g => g.participantId === p.id);

                    return `

                    <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 ${hasGift ? 'border-yellow-500 bg-yellow-50' : active ? 'border-green-500 bg-green-50' : 'border-gray-200'}">

                        <div>

                            <div class="font-bold text-gray-800">${p.name}</div>

                            <div class="flex gap-2 mt-1">

                                <span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold">${p.classGrade}</span>

                                <span class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">${p.sector}</span>

                            </div>

                        </div>

                        <div class="flex gap-1">
                            ${active ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded font-bold">HADIR</span>' : ''}
                            ${hasGift ? '<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded font-bold">üéÅ Ambil</span>' : ''}
                        </div>

                    </div>`;

                }).join('');

            }

        }



        window.showTicket = (n, c, s, q) => {

            document.getElementById('ticName').innerText = n;

            document.getElementById('ticClass').innerText = c;

            document.getElementById('ticSector').innerText = s;

            document.getElementById('ticQR').src = getQR(q);

            const t = document.getElementById('ticketModal');

            t.classList.remove('hidden');

            setTimeout(() => t.children[0].classList.replace('scale-95','scale-100'), 10);

        };



        // --- ADMIN LOGIN SYSTEM ---
        window.showAdminLogin = () => {
            const m = document.getElementById('adminLoginModal');
            document.getElementById('adminPassword').value = '';
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.replace('scale-95','scale-100'); }, 10);
        };

        window.adminLogin = () => {
            const password = document.getElementById('adminPassword').value;
            if(password === ADMIN_PASS) {
                state.isAdminLoggedIn = true;
                closeModal('adminLoginModal');
                beep('success');
                showScanResult(true, "‚úÖ Login Admin Berhasil!", 'bg-blue-500');
                render();
            } else {
                alert("Password salah!");
            }
        };

        window.adminLogout = () => {
            state.isAdminLoggedIn = false;
            state.searchTerm = '';
            beep('fail');
            showScanResult(false, "‚ùå Logout Admin", 'bg-gray-500');
            render();
        };



        // --- EXPORT/IMPORT/RESET ---

        window.exportData = (type) => {
            try {
                let csv = "\uFEFF"; // BOM untuk Excel
                const headers = type === 'p' ? "Nama,Kategori,Marga,QR\n" : 
                              type === 'g' ? "Nama,Kategori,Marga,Waktu\n" : 
                              "Nama,Kategori,Marga,Waktu\n";
                csv += headers;
                
                const data = type === 'p' ? state.participants : 
                           (type === 'g' ? state.gifts : state.attendance);
                
                data.forEach(x => {
                    const name = x.name || '';
                    const classGrade = x.classGrade || '';
                    const sector = x.sector || '';
                    const value = type === 'p' ? (x.qrCode || '') : (x.timestamp || '');
                    
                    // Escape quotes and wrap in quotes
                    const escapedName = name.replace(/"/g, '""');
                    const escapedClass = classGrade.replace(/"/g, '""');
                    const escapedSector = sector.replace(/"/g, '""');
                    const escapedValue = value.replace(/"/g, '""');
                    
                    csv += `"${escapedName}","${escapedClass}","${escapedSector}","${escapedValue}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const fileName = `Data_BONATAON_${type}_${new Date().toISOString().slice(0,10)}.csv`;
                
                // For IE
                if (window.navigator && window.navigator.msSaveBlob) {
                    window.navigator.msSaveBlob(blob, fileName);
                } else {
                    const link = document.createElement("a");
                    if (link.download !== undefined) {
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", fileName);
                        link.style.visibility = 'hidden';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    } else {
                        alert("Browser Anda tidak mendukung download file.");
                    }
                }
            } catch (error) {
                console.error("Export error:", error);
                alert("Terjadi kesalahan saat mengekspor data: " + error.message);
            }
        };



        window.handleImport = (input) => {

            const f = input.files[0]; if(!f) return;

            const r = new FileReader();

            r.onload = e => {

                const lines = e.target.result.split('\n');

                let c = 0;

                lines.forEach((l,i) => {

                    if(i===0) return;

                    const [n, cl, sc] = l.split(',').map(x => x?.replace(/"/g,'').trim());

                    if(n) {

                        const id = (Date.now()+i).toString();

                        push(ref(db, 'participants'), {

                            id, name: n, classGrade: cl||'Orang Tua', sector: sc||'Marga Manihuruk',

                            qrCode: `BONATAON-${id.slice(-6)}`, registeredAt: fmtDate(), timestamp: Date.now()

                        });

                        c++;

                    }

                });

                alert(`Import ${c} data sukses!`); input.value = '';

            };

            r.readAsText(f);

        };

        window.triggerImport = () => document.getElementById('importInput').click();



        window.resetData = () => {

            if(prompt("Password Admin:") === ADMIN_PASS && confirm("Hapus SEMUA data?")) {

                set(ref(db, 'participants'), null);

                set(ref(db, 'attendance'), null);

                set(ref(db, 'gifts'), null);

                alert("Database Reset.");

            }

        };



        window.closeModal = (id) => {

            const m = document.getElementById(id);

            m.classList.add('opacity-0');

            m.children[0].classList.replace('scale-100','scale-95');

            setTimeout(() => m.classList.add('hidden'), 300);

        };



        // --- RENDER SYSTEM ---

        window.setTab = (t) => {

            if((state.tab === 'scan' || state.tab === 'gift') && (t !== 'scan' && t !== 'gift')) window.stopScanner();

            state.tab = t;

            

            ['register','scan','gift','data'].forEach(x => {

                const btn = document.getElementById(`tab-${x}`);

                if(x === t) {

                    btn.classList.remove('bg-white','text-gray-400');

                    btn.classList.add('bg-red-600','text-white','shadow-xl','-translate-y-1');

                } else {

                    btn.classList.add('bg-white','text-gray-400');

                    btn.classList.remove('bg-red-600','text-white','shadow-xl','-translate-y-1');

                }

            });

            render();

            if(t === 'scan' || t === 'gift') setTimeout(() => window.initScanner(), 100);

        };



        window.render = () => {

            const root = document.getElementById('content-area');

            

            if (state.tab === 'register') {

                if (!document.getElementById('registration-form')) {

                    root.innerHTML = `

                        <div id="registration-form" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 mb-6">

                            <h3 class="font-bold text-gray-700 mb-4">Input Peserta Baru</h3>

                            <input id="inName" type="text" placeholder="Nama Lengkap..." class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold focus:border-red-500 outline-none mb-3">

                            <div class="flex gap-3 mb-4">

                                <select id="inClass" class="flex-1 p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-gray-600 outline-none">

                                    <option value="" disabled selected>Pilih Kategori</option>

                                    <option value="Orang Tua">Orang Tua</option>

                                    <option value="Sekolah Minggu">Sekolah Minggu</option>

                                    <option value="Tamu Undangan">Tamu Undangan</option>

                                </select>

                                <select id="inSector" class="flex-1 p-3 bg-gray-50 border-2 border-gray-100 rounded-xl font-bold text-gray-600 outline-none">

                                    <option value="" disabled selected>Pilih Marga</option>

                                    <option value="Marga Manihuruk">Marga Manihuruk</option>

                                    <option value="Boru / Panagolan">Boru / Panagolan</option>

                                </select>

                            </div>

                            <button onclick="preRegister()" class="w-full py-4 bg-red-600 text-white font-extrabold rounded-xl shadow-lg hover:bg-red-700 active:scale-95 transition-transform">LANJUT KONFIRMASI</button>

                        </div>

                        <div id="participant-list-container" class="space-y-3"></div>

                    `;

                }

                renderParticipantListOnly();

            } else if (state.tab === 'scan' || state.tab === 'gift') {

                const isGift = state.tab === 'gift';

                const color = isGift ? 'bg-purple-600' : 'bg-green-600';

                const label = isGift ? 'Scanner Hadiah' : 'Scanner Absensi';

                const hint = isGift ? 'Scan QR untuk ambil hadiah' : 'Scan QR untuk kehadiran';



                root.innerHTML = `

                    <div class="bg-white p-4 rounded-2xl shadow-sm text-center mb-6">

                        <div class="flex items-center justify-center gap-2 mb-2">

                            <span class="text-2xl">${isGift ? 'üéÅ' : 'üì∑'}</span>

                            <h3 class="font-bold text-gray-700">${label}</h3>

                        </div>

                        <div id="scanRes" class="hidden"></div>

                        <div id="reader" class="mb-4"></div>

                        <p class="text-[10px] text-gray-400">${hint}</p>

                    </div>

                    <div class="bg-white p-4 rounded-2xl shadow-sm">

                        <div class="text-sm font-bold text-gray-400 mb-2 uppercase">Manual ${isGift ? 'Ambil Hadiah' : 'Check-In'} 
                            ${state.isAdminLoggedIn ? 
                                '<span class="text-green-600 text-xs ml-2">(Admin Mode)</span>' : 
                                ''}
                        </div>
                        
                        ${state.isAdminLoggedIn ? 
                            `
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs text-gray-500">Anda login sebagai admin</span>
                                    <button onclick="adminLogout()" class="text-xs bg-red-100 text-red-600 px-3 py-1 rounded-lg font-bold hover:bg-red-200">Logout</button>
                                </div>
                                <input id="adminSearchInput" oninput="window.handleSearch(this)" type="text" placeholder="Cari nama..." class="w-full p-3 bg-gray-50 border rounded-xl text-sm focus:outline-none focus:border-blue-500 transition-colors">
                            </div>
                            <div id="manual-list" class="max-h-48 overflow-y-auto"></div>
                            ` : 
                            `
                            <div class="text-center p-4 border-2 border-dashed border-gray-200 rounded-xl">
                                <div class="text-gray-400 mb-3">‚õî</div>
                                <p class="text-sm text-gray-600 mb-3">Manual check-in hanya untuk admin</p>
                                <button onclick="showAdminLogin()" class="w-full py-3 bg-gray-800 text-white font-bold rounded-xl hover:bg-gray-900">Login sebagai Admin</button>
                            </div>
                            `}
                    </div>

                `;

            } else if (state.tab === 'data') {

                root.innerHTML = `

                    <div class="bg-white p-4 rounded-2xl shadow-sm mb-4">

                        <div class="grid grid-cols-3 gap-2 mb-2">

                            <button onclick="exportData('p')" class="py-2 bg-green-50 text-green-700 rounded-lg text-[10px] font-bold border border-green-200">Exp. Jemaat</button>

                            <button onclick="exportData('a')" class="py-2 bg-blue-50 text-blue-700 rounded-lg text-[10px] font-bold border border-blue-200">Exp. Absensi</button>

                            <button onclick="exportData('g')" class="py-2 bg-purple-50 text-purple-700 rounded-lg text-[10px] font-bold border border-purple-200">Exp. Hadiah</button>

                        </div>

                        <button onclick="triggerImport()" class="w-full py-3 bg-gray-50 text-gray-600 rounded-xl text-xs font-bold border border-gray-200">Import CSV (Nama,Kategori,Marga)</button>

                    </div>

                    <h3 class="font-bold text-gray-600 text-sm mb-2 px-1">Riwayat Kehadiran</h3>

                    <div class="space-y-2">

                        ${state.attendance.slice().reverse().map(a => `

                            <div class="bg-white p-3 rounded-xl shadow-sm flex items-center justify-between border border-gray-100">

                                <div>

                                    <div class="font-bold text-gray-800">${a.name}</div>

                                    <div class="text-[10px] text-gray-400">${a.timestamp}</div>

                                </div>

                                <span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Hadir</span>

                            </div>

                        `).join('')}

                    </div>

                    <div class="mt-8 text-center"><button onclick="resetData()" class="text-xs text-red-300 font-bold border border-red-100 px-3 py-1 rounded hover:bg-red-50 hover:text-red-500">Reset System</button></div>

                `;

            }

        };



        // Init

        setTab('register');

    </script>

</body>

</html>
