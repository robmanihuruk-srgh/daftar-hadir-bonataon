<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon Marga Manihuruk Boru Bere / Panagolan 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
      
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #059669;
            --emerald-50: #ecfdf5;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }
          
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .serif-font { font-family: 'Playfair Display', serif; }
        .royal-font { font-family: 'Cinzel', serif; }
          
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
          
        .header-bg {
            background: linear-gradient(135deg, var(--emerald-900) 0%, var(--emerald-600) 100%);
            position: relative;
            overflow: hidden;
        }

        .nav-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .nav-btn.active {
            background-color: var(--emerald-50);
            color: var(--emerald-900);
            border-color: var(--emerald-600);
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(5, 150, 105, 0.25);
        }

        .logo-frame {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        
        .form-input {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.15);
            outline: none;
        }

        @keyframes modalUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .vip-ticket {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .ticket-perforation {
            position: relative;
            background: #ffffff;
            margin-top: 24px;
            border-radius: 16px;
        }
        .ticket-perforation::before, .ticket-perforation::after {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #0f172a;
            border-radius: 50%;
        }
        .ticket-perforation::before { left: -12px; }
        .ticket-perforation::after { right: -12px; }

        .scan-frame {
            position: absolute;
            inset: 15%;
            border: 2px solid var(--emerald-600);
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.6);
            z-index: 5;
            pointer-events: none;
            border-radius: 1rem;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover { transition: transform 0.2s; }
        .btn-hover:active { transform: scale(0.95); }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="relative z-10 w-full max-w-lg mx-auto md:max-w-4xl min-h-screen md:my-10 md:rounded-[2.5rem] overflow-hidden flex flex-col glass-panel shadow-2xl">
          
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center px-6 text-center">
            <div class="logo-frame w-32 h-32 p-4 mb-8 animate-bounce">
                <img src="logo tugu manihuruk.png" alt="Logo" onerror="this.src='https://via.placeholder.com/150?text=LOGO'">
            </div>
            <h2 class="text-2xl font-bold text-emerald-900 mb-2 serif-font">BONATAON MANIHURUK 2026</h2>
            <div class="flex items-center gap-3 text-emerald-600 font-semibold mt-4">
                <i class="fas fa-circle-notch fa-spin"></i> Sinkronisasi Sistem...
            </div>
        </div>

        <header class="header-bg p-8 pb-20 shadow-2xl relative z-20">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-4">
                    <!-- Admin login trigger hidden in logo -->
                    <div onclick="window.showAdminLogin()" class="logo-frame w-14 h-14 md:w-20 md:h-20 p-1.5 border-2 border-white/30">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-sm md:text-xl font-extrabold text-white serif-font tracking-wide leading-tight">
                            BONATAON MARGA MANIHURUK<br>BORU BERE / PANAGOLAN 2026
                        </h1>
                    </div>
                </div>
                <div id="liveClock" class="text-right text-white hidden md:block"></div>
            </div>
              
            <div class="grid grid-cols-3 gap-3 mt-8">
                <div class="bg-white/15 backdrop-blur-md rounded-2xl p-3 border border-white/20 text-center">
                    <div class="text-xl md:text-2xl font-black text-white" id="statRegistered">0</div>
                    <div class="text-[9px] font-bold text-emerald-200 uppercase tracking-widest mt-1">Peserta</div>
                </div>
                <div class="bg-emerald-500/40 backdrop-blur-md rounded-2xl p-3 border border-emerald-400/50 text-center">
                    <div class="text-xl md:text-2xl font-black text-emerald-50" id="statPresent">0</div>
                    <div class="text-[9px] font-bold text-emerald-200 uppercase tracking-widest mt-1">Hadir</div>
                </div>
                <div class="bg-amber-500/30 backdrop-blur-md rounded-2xl p-3 border border-amber-400/40 text-center">
                    <div class="text-xl md:text-2xl font-black text-amber-200" id="statGifts">0</div>
                    <div class="text-[9px] font-bold text-amber-100 uppercase tracking-widest mt-1">Berkat</div>
                </div>
            </div>
        </header>

        <nav id="mainNav" class="flex px-6 -mt-10 relative z-30 gap-2 overflow-x-auto pb-4 custom-scrollbar">
            <button onclick="setTab('register')" id="tab-register" class="nav-btn flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover">
                <i class="fas fa-user-plus"></i><span class="text-[10px] font-bold uppercase">Daftar</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-btn flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover">
                <i class="fas fa-search"></i><span class="text-[10px] font-bold uppercase">Undangan</span>
            </button>
            <!-- Admin-only tabs hidden by default -->
            <button onclick="setTab('scan')" id="tab-scan" class="nav-btn flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover hidden admin-tab">
                <i class="fas fa-qrcode"></i><span class="text-[10px] font-bold uppercase">Absensi</span>
            </button>
            <button onclick="setTab('gift')" id="tab-gift" class="nav-btn flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover hidden admin-tab">
                <i class="fas fa-gift"></i><span class="text-[10px] font-bold uppercase">Berkat</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-btn flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover hidden admin-tab">
                <i class="fas fa-database"></i><span class="text-[10px] font-bold uppercase">Admin</span>
            </button>
        </nav>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto bg-slate-50 pb-24">
            <div id="content-area" class="max-w-4xl mx-auto"></div>
        </main>
          
        <footer class="py-4 px-8 border-t border-slate-200 bg-white/95 absolute bottom-0 w-full z-20">
            <div class="flex justify-between items-center text-[10px] md:text-xs">
                <div class="font-bold text-slate-400 uppercase">© 2026 Panitia Bonataon</div>
                <div class="font-bold text-emerald-800 uppercase flex items-center gap-1">
                    Marga Manihuruk <i class="fas fa-heart text-amber-500 animate-pulse"></i>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Search Results -->
    <div id="searchResultsModal" class="fixed inset-0 z-[9100] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('searchResultsModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <h3 class="text-xl font-black text-slate-800 mb-4" id="searchResultsTitle">Hasil Pencarian</h3>
            <p class="text-xs text-slate-400 mb-4">Pilih nama yang sesuai:</p>
            <div id="searchResultsList" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar p-1"></div>
            <button onclick="closeModal('searchResultsModal')" class="w-full mt-6 py-4 border-2 rounded-2xl font-bold text-slate-400">Tutup</button>
        </div>
    </div>

    <!-- Modal PIN Peserta -->
    <div id="authTicketModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('authTicketModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <h3 class="text-xl font-black text-slate-800 text-center mb-4" id="authTitle">Verifikasi PIN</h3>
            <p class="text-xs text-slate-400 text-center mb-6" id="authDesc">Masukkan PIN 4 digit untuk <span id="authUserName" class="font-bold text-emerald-600"></span></p>
            <input type="password" id="ticketPassInput" placeholder="••••" maxlength="4" class="form-input w-full rounded-2xl p-4 text-center text-3xl font-black mb-6 tracking-[0.5em]">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('authTicketModal')" class="py-4 border-2 rounded-2xl font-bold text-slate-400 btn-hover">Batal</button>
                <button onclick="window.verifyTicketPass()" class="py-4 bg-emerald-600 text-white rounded-2xl font-black shadow-lg btn-hover">KONFIRMASI</button>
            </div>
        </div>
    </div>

    <!-- Modal Edit User -->
    <div id="editUserModal" class="fixed inset-0 z-[9500] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('editUserModal')"></div>
        <div class="card max-w-md w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <h3 class="text-xl font-black text-slate-800 mb-6 flex items-center gap-2"><i class="fas fa-user-edit text-emerald-600"></i> Edit Profil</h3>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Nama Lengkap</label>
                    <input id="editName" type="text" class="form-input w-full rounded-xl p-3 font-bold">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Kategori</label>
                        <select id="editStatus" class="form-input w-full rounded-xl p-3 font-bold">
                            <option value="Orangtua">Orangtua</option>
                            <option value="Pemuda">Pemuda</option>
                            <option value="Sekolah Minggu">Sekolah Minggu</option>
                            <option value="Tamu">Tamu</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Marga</label>
                        <select id="editMarga" class="form-input w-full rounded-xl p-3 font-bold">
                            <option value="Manihuruk">Manihuruk</option>
                            <option value="Boru">Boru</option>
                            <option value="Bere">Bere</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">PIN Keamanan Baru (4 Digit)</label>
                    <input id="editPass" type="password" maxlength="4" class="form-input w-full rounded-xl p-3 font-black text-center text-xl tracking-widest">
                </div>
                <div class="pt-4 grid grid-cols-2 gap-3">
                    <button onclick="closeModal('editUserModal')" class="py-3 border-2 rounded-xl font-bold text-slate-400 btn-hover">Batal</button>
                    <button onclick="window.saveUserEdit()" class="py-3 bg-emerald-600 text-white rounded-xl font-black btn-hover">SIMPAN PERUBAHAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Tiket -->
    <div id="ticketModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden p-4 overflow-y-auto">
        <div class="absolute inset-0 bg-slate-950/95 backdrop-blur-xl" onclick="closeModal('ticketModal')"></div>
        <div class="relative w-full max-w-sm my-10 animate-[modalUp_0.4s]">
            <div id="vipTicketCard" class="vip-ticket rounded-[2.5rem] p-8 shadow-2xl">
                <div class="relative z-10 text-center">
                    <img src="logo tugu manihuruk.png" class="w-16 h-16 mx-auto mb-4">
                    <h4 class="text-emerald-400 text-[10px] font-black tracking-[0.3em] uppercase mb-1">Official Invitation</h4>
                    <h2 class="royal-font text-2xl font-black gold-text">BONATAON 2026</h2>
                    
                    <div class="my-6">
                        <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">Tamu Kehormatan</p>
                        <h1 id="ticName" class="text-xl font-extrabold text-white leading-tight">...</h1>
                        <div id="ticMeta" class="text-[9px] text-emerald-400 font-bold mt-2 uppercase tracking-widest leading-relaxed"></div>
                    </div>

                    <div class="ticket-perforation bg-white p-6">
                        <div id="qrLoading" class="w-48 h-48 mx-auto flex items-center justify-center bg-slate-50 rounded-lg">
                            <i class="fas fa-circle-notch fa-spin text-emerald-600 text-xl"></i>
                        </div>
                        <img id="ticQR" src="" class="w-48 h-48 object-contain mx-auto hidden">
                        <div class="text-center mt-4">
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Registration Code</div>
                            <div class="text-lg font-mono font-black text-slate-900" id="ticCode">...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col gap-3">
                <button onclick="window.openSelfEdit()" class="w-full py-4 rounded-2xl bg-amber-500 text-white font-black text-sm shadow-lg flex items-center justify-center gap-2 btn-hover">
                    <i class="fas fa-edit"></i> EDIT PROFIL / GANTI PIN
                </button>
                <button onclick="window.downloadTicketImage()" class="w-full py-4 rounded-2xl bg-white text-emerald-900 font-black text-sm shadow-lg flex items-center justify-center gap-2 btn-hover">
                    <i class="fas fa-download"></i> SIMPAN KE GALERI
                </button>
                <button onclick="closeModal('ticketModal')" class="text-white/40 text-xs font-bold py-2 uppercase btn-hover">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Modal Admin Login -->
    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('adminPassword').value = ''; closeModal('adminModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <h3 class="text-xl font-black text-slate-800 text-center mb-6">Akses Panitia</h3>
            <input type="password" id="adminPassword" placeholder="PIN ADMIN" class="form-input w-full rounded-2xl p-4 text-center text-2xl font-black mb-6">
            <button onclick="window.verifyAdmin()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black btn-hover">MASUK</button>
        </div>
    </div>

    <!-- Modal Admin Settings -->
    <div id="adminSettingsModal" class="fixed inset-0 z-[9600] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('adminSettingsModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <h3 class="text-xl font-black text-slate-800 mb-2">Ganti PIN Admin</h3>
            <p class="text-xs text-slate-400 mb-6 leading-relaxed">Masukkan PIN lama atau Kode Pemulihan untuk menyetel PIN baru.</p>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">Verifikasi Identitas</label>
                    <input type="password" id="verifyAdminInput" placeholder="PIN Lama / Kode Pemulihan" class="form-input w-full rounded-xl p-4 text-center text-lg font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1 block">PIN Baru (4 Digit)</label>
                    <input type="password" id="newAdminPin" maxlength="4" placeholder="••••" class="form-input w-full rounded-xl p-4 text-center text-2xl font-black tracking-[0.5em]">
                </div>
                <div class="pt-4 grid grid-cols-2 gap-3">
                    <button onclick="closeModal('adminSettingsModal')" class="py-4 border-2 rounded-xl font-bold text-slate-400 btn-hover">Batal</button>
                    <button onclick="window.updateAdminPin()" class="py-4 bg-emerald-600 text-white rounded-xl font-black btn-hover">SIMPAN PIN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="confirmDeleteModal" class="fixed inset-0 z-[9700] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('confirmDeleteModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s] text-center">
            <div class="w-20 h-20 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl animate-pulse">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-xl font-black text-slate-800 mb-2">Konfirmasi Hapus</h3>
            <p class="text-xs text-slate-500 mb-8 leading-relaxed">
                Apakah Anda yakin ingin menghapus <span id="deleteTargetName" class="font-bold text-red-600"></span> secara permanen?<br>Tindakan ini tidak dapat dibatalkan.
            </p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('confirmDeleteModal')" class="py-4 border-2 rounded-2xl font-bold text-slate-400 btn-hover">Batal</button>
                <button onclick="window.confirmPermanentDelete()" class="py-4 bg-red-600 text-white rounded-2xl font-black shadow-lg shadow-red-200 btn-hover">YA, HAPUS</button>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Reset PIN -->
    <div id="confirmResetModal" class="fixed inset-0 z-[9700] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('confirmResetModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s] text-center">
            <div class="w-20 h-20 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl">
                <i class="fas fa-key"></i>
            </div>
            <h3 class="text-xl font-black text-slate-800 mb-2">Reset PIN Peserta</h3>
            <p class="text-xs text-slate-500 mb-8 leading-relaxed">
                PIN untuk <span id="resetTargetName" class="font-bold text-amber-600"></span> akan diatur ulang ke <span class="font-bold text-emerald-600">0000</span>.
            </p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('confirmResetModal')" class="py-4 border-2 rounded-2xl font-bold text-slate-400 btn-hover">Batal</button>
                <button onclick="window.confirmPermanentReset()" class="py-4 bg-amber-500 text-white rounded-2xl font-black shadow-lg shadow-amber-200 btn-hover">YA, RESET</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            tab: 'register',
            scanner: null,
            isAdmin: false,
            adminPass: "1234",
            recoveryKey: "BONA2026",
            activeUser: null,
            tempUser: null,
            filterStatus: "Semua",
            adminSearchQuery: "",
            manualContext: null,
            deleteTargetId: null,
            resetTargetId: null,
            authContext: 'view' // 'view' or 'edit'
        };

        // LOAD ADMIN PIN FROM FIREBASE
        onValue(ref(db, 'settings/adminPin'), s => {
            if(s.val()) state.adminPass = s.val();
        });

        // UI & CLOCK
        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
            const date = now.toLocaleDateString('id-ID', { day:'numeric', month:'short' });
            const html = `<div class="text-xs font-bold opacity-70">${date}</div><div class="text-xl font-black">${time}</div>`;
            if(document.getElementById('liveClock')) document.getElementById('liveClock').innerHTML = html;
        }
        setInterval(updateClock, 1000); updateClock();

        // LISTENERS
        onValue(ref(db, 'participants'), s => { 
            const data = s.val();
            state.participants = data ? Object.keys(data).map(k => ({...data[k], firebaseId: k})) : []; 
            updateDashboard(); 
        });
        onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'gifts'), s => { state.gifts = s.val() ? Object.values(s.val()) : []; updateDashboard(); });

        function updateDashboard() {
            document.getElementById('statRegistered').innerText = state.participants.length;
            document.getElementById('statPresent').innerText = state.attendance.length;
            document.getElementById('statGifts').innerText = state.gifts.length;
            
            if(state.tab === 'register') renderParticipantList();
            if(state.tab === 'data') renderDataTable();
            
            setTimeout(() => document.getElementById('loading')?.classList.add('hidden'), 500);
        }

        // Toggle Restricted UI visibility
        function refreshUIVisibility() {
            const adminTabs = document.querySelectorAll('.admin-tab');
            adminTabs.forEach(tab => {
                if (state.isAdmin) {
                    tab.classList.remove('hidden');
                } else {
                    tab.classList.add('hidden');
                }
            });
        }

        window.showAdminLogin = () => {
            if (state.isAdmin) return;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModal').classList.remove('hidden');
        };

        window.setTab = async (t) => {
            if(state.scanner) { try { await state.scanner.stop(); } catch(e){} state.scanner = null; }
            state.tab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}`));
            
            const area = document.getElementById('content-area');
            if(t === 'register') {
                area.innerHTML = `
                <div class="bg-white rounded-3xl p-6 shadow-xl mb-8">
                    <h3 class="text-lg font-black text-slate-800 mb-6">Pendaftaran Peserta</h3>
                    <div class="space-y-4">
                        <input id="inName" type="text" class="form-input w-full rounded-xl p-4 font-bold" placeholder="Nama Lengkap Sesuai KTP">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="inStatus" class="form-input w-full rounded-xl p-4 font-bold">
                                <option value="Orangtua">Orangtua</option><option value="Pemuda">Pemuda</option><option value="Sekolah Minggu">Sekolah Minggu</option><option value="Tamu">Tamu</option>
                            </select>
                            <select id="inMarga" class="form-input w-full rounded-xl p-4 font-bold">
                                <option value="Manihuruk">Manihuruk</option><option value="Boru">Boru</option><option value="Bere">Bere</option>
                            </select>
                        </div>
                        <input id="inPass" type="password" maxlength="4" class="form-input w-full rounded-xl p-4 font-black text-center text-xl" placeholder="Buat PIN (4 Digit)">
                        <button onclick="window.processRegister()" class="w-full bg-emerald-600 text-white rounded-xl py-4 font-black shadow-lg btn-hover">DAFTARKAN</button>
                    </div>
                </div>
                <div id="participantList" class="space-y-3"></div>`;
                renderParticipantList();
            } else if(t === 'find') {
                area.innerHTML = `
                <div class="bg-white rounded-3xl p-8 shadow-xl text-center">
                    <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600 text-2xl"><i class="fas fa-ticket-alt"></i></div>
                    <h3 class="font-black text-xl mb-6">Buka Undangan</h3>
                    <div class="space-y-4">
                        <input id="findName" type="text" placeholder="Masukkan Nama Lengkap" class="form-input w-full rounded-xl p-4 text-center font-bold">
                        <button onclick="window.findTicket()" class="w-full bg-emerald-700 text-white rounded-xl py-4 font-black btn-hover">CARI DATA</button>
                    </div>
                </div>`;
            } else if(t === 'scan' || t === 'gift') {
                const isScan = t === 'scan';
                area.innerHTML = `
                <div class="bg-white rounded-3xl p-6 shadow-xl text-center">
                    <h3 class="font-black mb-6">Scan QR ${isScan ? 'Kehadiran' : 'Berkat'}</h3>
                    <div id="scanMsg" class="hidden p-3 rounded-xl mb-4 text-white font-bold"></div>
                    <div class="relative rounded-2xl overflow-hidden bg-black aspect-square max-w-sm mx-auto mb-6">
                        <div id="reader"></div>
                        <div class="scan-frame"></div>
                    </div>
                    <div class="pt-4 border-t border-slate-100">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-4">Fallback Admin</p>
                        <button id="${isScan ? 'manualCheckinBtn' : 'manualGiftBtn'}" 
                                ${state.isAdmin ? '' : 'disabled'} 
                                style="opacity: ${state.isAdmin ? '1' : '0.5'}"
                                onclick="window.openManualInput('${t}')"
                                class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-sm shadow-xl flex items-center justify-center gap-3 btn-hover transition-all">
                            <i class="fas fa-keyboard"></i> INPUT MANUAL (PANITIA)
                        </button>
                    </div>
                </div>`;
                setTimeout(initScanner, 300);
            } else if(t === 'data') {
                if(!state.isAdmin) {
                    area.innerHTML = `<div class="p-20 text-center text-slate-300 font-bold">Akses Terbatas</div>`;
                    window.showAdminLogin();
                } else {
                    renderAdminPanel();
                }
            }
        };

        // REGISTER
        window.processRegister = () => {
            const name = document.getElementById('inName').value.trim();
            const pass = document.getElementById('inPass').value;
            if(!name || pass.length < 4) return alert("Lengkapi data dan PIN 4 digit!");
            
            const code = `MN-${Date.now().toString().slice(-6)}`;
            const data = {
                name, 
                status: document.getElementById('inStatus').value,
                marga: document.getElementById('inMarga').value,
                password: pass,
                qrCode: code,
                registeredAt: new Date().toLocaleString()
            };
            
            push(ref(db, 'participants'), data).then(() => {
                alert("Pendaftaran Berhasil!");
                window.showTicket(data);
                document.getElementById('inName').value = '';
                document.getElementById('inPass').value = '';
            });
        };

        // SHOW TICKET & QR
        window.showTicket = async (user) => {
            state.activeUser = user;
            document.getElementById('ticName').innerText = user.name;
            document.getElementById('ticCode').innerText = user.qrCode;
            document.getElementById('ticMeta').innerText = `${user.marga} • ${user.status}`;
            
            const qrImg = document.getElementById('ticQR');
            const qrLoader = document.getElementById('qrLoading');
            
            qrImg.classList.add('hidden');
            qrLoader.classList.remove('hidden');
            document.getElementById('ticketModal').classList.remove('hidden');

            try {
                const qrOptions = { errorCorrectionLevel: 'H', margin: 2, width: 600, color: { dark: "#064e3b" } };
                if (typeof QRCode !== 'undefined') {
                    const url = await QRCode.toDataURL(user.qrCode, qrOptions);
                    qrImg.src = url;
                    qrImg.onload = () => { qrLoader.classList.add('hidden'); qrImg.classList.remove('hidden'); };
                } else { throw new Error(); }
            } catch (e) {
                qrLoader.innerHTML = `<span class="text-[10px] text-red-500 font-bold">QR ERROR</span>`;
            }
        };

        // FIND TICKET
        window.findTicket = () => {
            const query = document.getElementById('findName').value.toLowerCase().trim();
            if(!query) return alert("Masukkan nama!");
            
            const matches = state.participants.filter(x => x.name.toLowerCase().includes(query));
            
            if(matches.length === 0) {
                alert("Data tidak ditemukan!");
            } else if(matches.length === 1) {
                window.startAuth(matches[0]);
            } else {
                state.manualContext = 'find';
                window.showSearchMatches(matches);
            }
        };

        window.showSearchMatches = (matches) => {
            const list = document.getElementById('searchResultsList');
            const title = document.getElementById('searchResultsTitle');
            title.innerText = state.manualContext === 'find' ? 'Hasil Pencarian' : 'Pilih Peserta (Manual)';
            
            list.innerHTML = matches.map(m => `
                <div onclick="window.selectForContext('${m.firebaseId}')" class="p-4 bg-slate-50 hover:bg-emerald-50 border border-slate-100 rounded-xl cursor-pointer transition-colors flex justify-between items-center">
                    <div>
                        <div class="font-black text-slate-800 text-sm">${m.name}</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase">${m.marga} - ${m.status}</div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300"></i>
                </div>
            `).join('');
            document.getElementById('searchResultsModal').classList.remove('hidden');
        };

        window.selectForContext = (id) => {
            const user = state.participants.find(p => p.firebaseId === id);
            closeModal('searchResultsModal');
            
            if (state.manualContext === 'scan' || state.manualContext === 'gift') {
                processAttendance(user, state.manualContext === 'scan' ? 'attendance' : 'gifts');
            } else {
                window.startAuth(user);
            }
        };

        window.startAuth = (user, context = 'view') => {
            state.tempUser = user;
            state.authContext = context;
            
            const title = document.getElementById('authTitle');
            const desc = document.getElementById('authDesc');
            
            if (context === 'edit') {
                title.innerText = "Verifikasi Edit Profil";
                desc.innerHTML = `Masukkan PIN 4 digit untuk mengedit data <span class="font-bold text-emerald-600">${user.name}</span>`;
            } else {
                title.innerText = "Verifikasi PIN";
                desc.innerHTML = `Masukkan PIN 4 digit untuk <span class="font-bold text-emerald-600">${user.name}</span>`;
            }
            
            document.getElementById('ticketPassInput').value = '';
            document.getElementById('authTicketModal').classList.remove('hidden');
        };

        window.verifyTicketPass = () => {
            const pin = document.getElementById('ticketPassInput').value;
            if(state.tempUser && pin === state.tempUser.password) {
                if (state.authContext === 'edit') {
                    state.activeUser = state.tempUser;
                    closeModal('authTicketModal');
                    window.openSelfEdit(true); 
                } else {
                    window.showTicket(state.tempUser);
                    closeModal('authTicketModal');
                }
            } else alert("PIN Salah!");
        };

        // EDIT FACILITY
        window.openSelfEdit = (verified = false) => {
            if(!state.activeUser) return;
            if (!state.isAdmin && !verified) {
                window.startAuth(state.activeUser, 'edit');
                return;
            }
            document.getElementById('editName').value = state.activeUser.name;
            document.getElementById('editStatus').value = state.activeUser.status;
            document.getElementById('editMarga').value = state.activeUser.marga;
            document.getElementById('editPass').value = state.activeUser.password;
            document.getElementById('editUserModal').classList.remove('hidden');
        };

        window.saveUserEdit = () => {
            const id = state.activeUser.firebaseId;
            const updates = {
                name: document.getElementById('editName').value.trim(),
                status: document.getElementById('editStatus').value,
                marga: document.getElementById('editMarga').value,
                password: document.getElementById('editPass').value.trim(),
                lastUpdatedAt: new Date().toLocaleString()
            };
            if(!updates.name || updates.password.length < 4) return alert("Nama dan PIN 4 digit wajib diisi!");
            update(ref(db, 'participants/' + id), updates).then(() => {
                alert("Profil berhasil diperbarui!");
                closeModal('editUserModal');
                if (state.activeUser && state.activeUser.firebaseId === id) {
                    state.activeUser = {...state.activeUser, ...updates};
                    if (document.getElementById('ticName')) document.getElementById('ticName').innerText = updates.name;
                    if (document.getElementById('ticMeta')) document.getElementById('ticMeta').innerText = `${updates.marga} • ${updates.status}`;
                }
                if(state.tab === 'register') renderParticipantList();
            });
        };

        // ADMIN FEATURES
        window.verifyAdmin = () => {
            const p = document.getElementById('adminPassword').value;
            if(p === state.adminPass) {
                state.isAdmin = true;
                closeModal('adminModal');
                refreshUIVisibility();
                setTab('data');
            } else alert("PIN Salah!");
        };

        function renderAdminPanel() {
            const area = document.getElementById('content-area');
            area.innerHTML = `
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-lg space-y-4 border border-slate-100">
                    <div class="flex flex-wrap justify-between items-center gap-3">
                        <h3 class="font-black text-slate-800 flex items-center gap-2 tracking-tight">
                            <i class="fas fa-user-shield text-emerald-600"></i> Kelola Peserta
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="window.exportToCSV()" class="bg-emerald-50 px-4 py-2.5 rounded-xl text-emerald-700 text-[10px] font-black hover:bg-emerald-100 transition-colors flex items-center gap-2">
                                <i class="fas fa-file-export"></i> EKSPORT CSV
                            </button>
                            <button onclick="window.openAdminSettings()" class="bg-slate-50 px-4 py-2.5 rounded-xl text-slate-700 text-[10px] font-black hover:bg-slate-100 transition-colors flex items-center gap-2">
                                <i class="fas fa-key"></i> PIN ADMIN
                            </button>
                            <button onclick="window.adminLogout()" class="bg-red-50 p-2.5 rounded-xl text-red-600 text-sm hover:bg-red-100 transition-colors"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" onkeyup="window.handleAdminSearch(this.value)" placeholder="Cari Nama / Kode..." class="form-input w-full rounded-xl pl-11 p-3 text-sm">
                        </div>
                        <select onchange="window.updateTableFilter(this.value)" class="form-input rounded-xl px-3 py-3 text-sm font-bold bg-slate-50 border-slate-200">
                            <option value="Semua">Semua Kategori</option>
                            <option value="Orangtua">Orangtua</option>
                            <option value="Pemuda">Pemuda</option>
                            <option value="Sekolah Minggu">Sekolah Minggu</option>
                            <option value="Tamu">Tamu</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                    <div id="adminTableContainer" class="overflow-x-auto custom-scrollbar"></div>
                </div>
            </div>`;
            renderDataTable();
        }

        window.exportToCSV = () => {
            if (!state.participants || state.participants.length === 0) return alert("Tidak ada data untuk dieksport.");
            const headers = ["Nama", "Kategori", "Marga", "Kode QR", "PIN"];
            const rows = state.participants.map(p => [`"${p.name}"`, `"${p.status}"`, `"${p.marga}"`, `"${p.qrCode}"`, `"${p.password}"`]);
            let csvContent = "\ufeff" + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Peserta_Bonataon_2026_${new Date().toISOString().slice(0,10)}.csv`);
            link.click();
        };

        window.handleAdminSearch = (val) => { state.adminSearchQuery = val.toLowerCase(); renderDataTable(); };
        window.updateTableFilter = (val) => { state.filterStatus = val; renderDataTable(); };

        window.renderDataTable = () => {
            const container = document.getElementById('adminTableContainer');
            if(!container) return;
            let filtered = state.participants;
            if(state.filterStatus !== "Semua") filtered = filtered.filter(p => p.status === state.filterStatus);
            if(state.adminSearchQuery) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(state.adminSearchQuery) || p.qrCode.toLowerCase().includes(state.adminSearchQuery));
            }
            container.innerHTML = `
            <table class="w-full text-left text-xs">
                <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest border-b border-slate-100">
                    <tr><th class="p-4">Identitas</th><th class="p-4">Kategori</th><th class="p-4">Akses</th><th class="p-4 text-center">Aksi</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    ${filtered.length > 0 ? filtered.map(p => `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="p-4">
                            <div class="font-black text-slate-800 text-sm">${p.name}</div>
                            <div class="text-[9px] font-mono text-slate-400 mt-1">${p.qrCode}</div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-slate-600">${p.status}</div>
                            <div class="text-[8px] text-slate-400 uppercase font-black">${p.marga}</div>
                        </td>
                        <td class="p-4 font-mono font-black text-emerald-600 text-[10px] tracking-widest">${p.password}</td>
                        <td class="p-4">
                            <div class="flex justify-center gap-2">
                                <button onclick="window.adminEditUser('${p.firebaseId}')" class="w-8 h-8 flex items-center justify-center bg-emerald-50 text-emerald-600 rounded-lg hover:bg-emerald-100 transition-colors"><i class="fas fa-edit"></i></button>
                                <button onclick="window.adminResetPin('${p.firebaseId}')" class="w-8 h-8 flex items-center justify-center bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 transition-colors"><i class="fas fa-key"></i></button>
                                <button onclick="window.adminDeleteUser('${p.firebaseId}')" class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded-lg hover:bg-red-100 transition-colors"><i class="fas fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`).join('') : `<tr><td colspan="4" class="p-20 text-center text-slate-400 font-bold">Tidak ada data ditemukan</td></tr>`}
                </tbody>
            </table>`;
        };

        window.adminEditUser = (id) => {
            const user = state.participants.find(p => p.firebaseId === id);
            state.activeUser = user;
            window.openSelfEdit(true); 
        };

        window.adminResetPin = (id) => {
            const user = state.participants.find(p => p.firebaseId === id);
            state.resetTargetId = id;
            document.getElementById('resetTargetName').innerText = user.name;
            document.getElementById('confirmResetModal').classList.remove('hidden');
        };

        window.confirmPermanentReset = () => {
            if(!state.resetTargetId) return;
            update(ref(db, 'participants/' + state.resetTargetId), { password: '0000', lastUpdatedAt: new Date().toLocaleString() }).then(() => {
                alert("PIN Berhasil direset ke 0000");
                closeModal('confirmResetModal');
                state.resetTargetId = null;
            });
        };

        window.adminDeleteUser = (id) => {
            const user = state.participants.find(p => p.firebaseId === id);
            state.deleteTargetId = id;
            document.getElementById('deleteTargetName').innerText = user.name;
            document.getElementById('confirmDeleteModal').classList.remove('hidden');
        };

        window.confirmPermanentDelete = () => {
            if (!state.deleteTargetId) return;
            remove(ref(db, 'participants/' + state.deleteTargetId)).then(() => {
                alert("Data Berhasil Dihapus.");
                closeModal('confirmDeleteModal');
                state.deleteTargetId = null;
            });
        };

        window.updateAdminPin = () => {
            const v = document.getElementById('verifyAdminInput').value;
            const n = document.getElementById('newAdminPin').value;
            if(v !== state.adminPass && v !== state.recoveryKey) return alert("PIN Lama Salah!");
            if(n.length < 4) return alert("Minimal 4 digit!");
            set(ref(db, 'settings/adminPin'), n).then(() => {
                state.adminPass = n;
                alert("PIN Admin diperbarui!");
                closeModal('adminSettingsModal');
            });
        };

        window.adminLogout = () => { 
            state.isAdmin = false; 
            refreshUIVisibility();
            setTab('register'); 
        };

        // SCANNER LOGIC
        window.initScanner = () => {
            state.scanner = new Html5Qrcode("reader");
            state.scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, onScanSuccess).catch(err => {
                showFeedback('Gagal Akses Kamera', 'bg-red-600');
            });
        };

        function onScanSuccess(text) {
            const p = state.participants.find(x => x.qrCode === text);
            if(!p) return showFeedback('QR TIDAK VALID', 'bg-red-600');
            processAttendance(p, state.tab === 'scan' ? 'attendance' : 'gifts');
        }

        function processAttendance(p, path) {
            const list = state[path === 'attendance' ? 'attendance' : 'gifts'];
            const already = list.some(l => l.qrCode === p.qrCode && (new Date() - new Date(l.timestamp)) < 300000);
            if(already) return showFeedback('SUDAH TERCATAT', 'bg-amber-500');
            push(ref(db, path), { name: p.name, qrCode: p.qrCode, timestamp: new Date().toLocaleString() }).then(() => {
                showFeedback(`BERHASIL: ${p.name}`, 'bg-emerald-600');
                beep();
            });
        }

        window.openManualInput = (type) => {
            if (!state.isAdmin) return alert("Akses Terbatas Panitia!");
            const q = prompt("Nama atau Kode QR:");
            if (!q) return;
            const matches = state.participants.filter(x => x.name.toLowerCase().includes(q.toLowerCase()) || x.qrCode.toLowerCase().includes(q.toLowerCase()));
            if (matches.length === 0) return alert("Data tidak ditemukan!");
            state.manualContext = type;
            window.showSearchMatches(matches);
        };

        function showFeedback(txt, cls) {
            const el = document.getElementById('scanMsg');
            if(!el) return;
            el.innerText = txt; el.className = `p-3 rounded-xl mb-4 text-white font-bold shadow-lg ${cls}`;
            el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3000);
        }

        // HELPERS
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        function beep() {
            try {
                const a = new (window.AudioContext || window.webkitAudioContext)();
                const o = a.createOscillator();
                o.connect(a.destination); o.frequency.value = 880; o.start(); o.stop(a.currentTime + 0.1);
            } catch (e) {}
        }

        window.downloadTicketImage = () => {
            const target = document.getElementById('vipTicketCard');
            html2canvas(target, { scale: 2, backgroundColor: '#0f172a' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Tiket_Bonataon_${state.activeUser.name.replace(/\s+/g, '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        function renderParticipantList() {
            const list = document.getElementById('participantList');
            if(!list) return;
            list.innerHTML = `<h5 class="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">Pendaftar Terbaru</h5>` + 
                state.participants.slice(-3).reverse().map(p => `
                <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50">
                    <div class="font-bold text-sm text-slate-800">${p.name}</div>
                    <div class="text-[8px] font-black bg-emerald-50 text-emerald-700 px-2 py-1 rounded-full uppercase">${p.status}</div>
                </div>`).join('');
        }

        setTab('register');
    </script>
</body>
</html>
