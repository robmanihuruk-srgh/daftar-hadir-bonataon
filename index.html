<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon Marga Manihuruk Boru Bere / Panagolan 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&family=Playfair+Display:wght@700;800;900&family=Cinzel:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
      
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #10b981;
            --emerald-500: #34d399;
            --emerald-50: #ecfdf5;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
            --slate-800: #1e293b;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --royal-gradient: linear-gradient(135deg, #064e3b 0%, #10b981 100%);
        }
          
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.25) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
            letter-spacing: -0.01em;
        }

        .serif-font { font-family: 'Playfair Display', serif; }
        .royal-font { font-family: 'Cinzel', serif; }
          
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.4);
        }
          
        .header-bg {
            background: var(--royal-gradient);
            position: relative;
            overflow: hidden;
        }

        .header-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            opacity: 0.05;
            pointer-events: none;
        }

        .nav-btn {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            min-height: 85px;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            border: 1px solid rgba(226, 232, 240, 0.8);
        }
        .nav-btn.active {
            background-color: white;
            color: var(--emerald-600);
            border-color: var(--emerald-500);
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(16, 185, 129, 0.2);
        }
        .nav-btn i { font-size: 1.25rem; }

        .logo-frame {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .logo-frame:hover { transform: rotate(5deg) scale(1.05); }
        
        .form-input {
            background-color: #f1f5f9;
            border: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.1);
            outline: none;
            transform: translateY(-2px);
        }

        .btn-modern {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .btn-modern::after {
            content: '';
            position: absolute;
            top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .btn-modern:hover::after { left: 100%; }

        @keyframes modalUp { 
            from { opacity: 0; transform: translateY(40px) scale(0.9); filter: blur(10px); } 
            to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); } 
        }
        
        .vip-ticket {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }
        .ticket-perforation::before, .ticket-perforation::after {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: #0f172a;
            border-radius: 50%;
            z-index: 10;
        }
        .ticket-perforation::before { left: -15px; }
        .ticket-perforation::after { right: -15px; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover:active { transform: scale(0.92); }

        .badge-luxury {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 10px;
            font-weight: 800;
            padding: 4px 12px;
            border-radius: 99px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: #ef4444;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 0 rgba(239, 68, 68, 0.4);
            animation: pulse-red 2s infinite;
        }

        #reader {
            width: 100% !important;
            height: 100% !important;
        }
        
        #reader video {
            object-fit: cover !important;
        }

        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="relative z-10 w-full max-w-lg mx-auto md:max-w-4xl min-h-screen md:my-10 md:rounded-[3rem] overflow-hidden flex flex-col glass-panel">
          
        <!-- Loading State -->
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center px-6 text-center">
            <div class="logo-frame w-36 h-36 p-5 mb-8 animate-bounce">
                <img src="logo tugu manihuruk.png" alt="Logo" onerror="this.src='https://via.placeholder.com/150?text=LOGO'">
            </div>
            <h2 class="text-3xl font-black text-emerald-900 mb-2 royal-font uppercase tracking-tight">BONATAON 2026</h2>
            <div class="flex items-center gap-3 text-emerald-600 font-bold mt-4 bg-emerald-50 px-6 py-3 rounded-full shadow-sm">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat Aplikasi...
            </div>
        </div>

        <header class="header-bg p-10 pb-24 shadow-2xl relative z-20">
            <div class="flex justify-between items-start relative z-10">
                <div class="flex items-center gap-5">
                    <div onclick="window.showAdminLogin()" class="logo-frame w-16 h-16 md:w-24 md:h-24 p-2 border-2 border-white/20">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-lg md:text-2xl font-black text-white royal-font tracking-wide leading-tight uppercase drop-shadow-lg">
                            BONATAON MARGA MANIHURUK<br><span class="text-emerald-300">BORU BERE / PANAGOLAN 2026</span>
                        </h1>
                        <div id="roleBadge" class="hidden inline-block mt-3 px-4 py-1.5 bg-amber-400 text-amber-900 text-[10px] font-black rounded-full uppercase tracking-widest shadow-xl border border-amber-300"></div>
                    </div>
                </div>
                <div id="liveClock" class="text-right text-white hidden md:block backdrop-blur-md bg-white/10 p-3 rounded-2xl border border-white/10"></div>
            </div>
              
            <div class="grid grid-cols-3 gap-4 mt-10 relative z-10">
                <div class="bg-white/10 backdrop-blur-xl rounded-[2rem] p-4 border border-white/20 text-center shadow-lg">
                    <div class="text-2xl md:text-4xl font-black text-white" id="statRegistered">0</div>
                    <div class="text-[10px] font-extrabold text-emerald-200 uppercase tracking-widest mt-1">Peserta</div>
                </div>
                <div class="bg-emerald-500/20 backdrop-blur-xl rounded-[2rem] p-4 border border-emerald-400/30 text-center shadow-lg">
                    <div class="text-2xl md:text-4xl font-black text-white" id="statPresent">0</div>
                    <div class="text-[10px] font-extrabold text-emerald-200 uppercase tracking-widest mt-1">Hadir</div>
                </div>
                <div class="bg-amber-500/20 backdrop-blur-xl rounded-[2rem] p-4 border border-amber-400/30 text-center shadow-lg">
                    <div class="text-2xl md:text-4xl font-black text-white" id="statGifts">0</div>
                    <div class="text-[10px] font-extrabold text-amber-100 uppercase tracking-widest mt-1">Berkat</div>
                </div>
            </div>
        </header>

        <nav id="mainNav" class="flex px-6 -mt-12 relative z-30 gap-3 overflow-x-auto pb-6 custom-scrollbar no-scrollbar">
            <button onclick="setTab('register')" id="tab-register" class="nav-btn public-tab flex-1 min-w-[110px] bg-white shadow-2xl btn-hover btn-modern">
                <i class="fas fa-user-plus text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Daftar</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-btn public-tab flex-1 min-w-[110px] bg-white shadow-2xl btn-hover btn-modern">
                <i class="fas fa-search text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Undangan</span>
            </button>
            <button onclick="setTab('scan')" id="tab-scan" class="nav-btn admin-tab staff-tab flex-1 min-w-[110px] bg-white shadow-2xl btn-hover btn-modern hidden">
                <i class="fas fa-qrcode text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Absensi</span>
            </button>
            <button onclick="setTab('gift')" id="tab-gift" class="nav-btn admin-tab staff-tab flex-1 min-w-[110px] bg-white shadow-2xl btn-hover btn-modern hidden">
                <i class="fas fa-gift text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Berkat</span>
            </button>
            <button onclick="setTab('report')" id="tab-report" class="nav-btn admin-tab flex-1 min-w-[110px] bg-white shadow-2xl btn-hover btn-modern hidden">
                <i class="fas fa-chart-line text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Report</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-btn admin-tab flex-1 min-w-[110px] bg-white shadow-2xl btn-hover btn-modern hidden">
                <i class="fas fa-shield-halved text-emerald-600"></i><span class="text-[10px] font-black uppercase tracking-widest">Admin</span>
            </button>
            <button onclick="window.adminLogout()" id="tab-logout" class="nav-btn hidden flex-1 min-w-[110px] bg-red-50 text-red-600 border-red-100 shadow-xl btn-hover">
                <i class="fas fa-power-off"></i><span class="text-[10px] font-black uppercase tracking-widest">Keluar</span>
            </button>
        </nav>

        <main class="flex-1 p-6 md:p-12 overflow-y-auto bg-slate-50/50 pb-28">
            <div id="content-area" class="max-w-4xl mx-auto"></div>
        </main>
          
        <footer class="py-6 px-10 border-t border-slate-200 bg-white/95 absolute bottom-0 w-full z-20 shadow-[0_-10px_30px_rgba(0,0,0,0.05)]">
            <div class="flex justify-between items-center text-[10px] md:text-xs">
                <div class="font-black text-slate-400 uppercase tracking-widest">© 2026 PANITIA BONATAON</div>
                <div class="font-black text-emerald-900 uppercase flex items-center gap-2 tracking-widest">
                    Manihuruk <span class="w-1.5 h-1.5 rounded-full bg-amber-500 animate-pulse"></span> Bersatu
                </div>
            </div>
        </footer>
    </div>

    <!-- MODALS -->

    <!-- Modal Edit User -->
    <div id="editUserModal" class="fixed inset-0 z-[9500] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-xl" onclick="closeModal('editUserModal')"></div>
        <div class="card max-w-md w-full relative z-10 p-10 bg-white rounded-[3rem] shadow-2xl animate-[modalUp_0.4s]">
            <h3 class="text-2xl font-black text-slate-800 mb-8 flex items-center gap-3 royal-font tracking-tight uppercase"><i class="fas fa-user-pen text-emerald-600"></i> Perbarui Profil</h3>
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">Nama Lengkap</label>
                    <input id="editName" type="text" class="form-input w-full rounded-2xl p-4 font-black uppercase">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">Kategori</label>
                        <select id="editStatus" class="form-input w-full rounded-2xl p-4 font-black">
                            <option value="Orangtua">Orangtua</option>
                            <option value="Pemuda">Pemuda</option>
                            <option value="Sekolah Minggu">Sekolah Minggu</option>
                            <option value="Tamu">Tamu</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">Marga</label>
                        <select id="editMarga" class="form-input w-full rounded-2xl p-4 font-black">
                            <option value="Manihuruk">Manihuruk</option>
                            <option value="Boru">Boru</option>
                            <option value="Bere">Bere</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">PIN Keamanan (4 Digit)</label>
                    <input id="editPass" type="password" maxlength="4" class="form-input w-full rounded-2xl p-4 font-black text-center text-3xl tracking-[0.5em]">
                </div>
                <div class="pt-6 grid grid-cols-2 gap-4">
                    <button onclick="closeModal('editUserModal')" class="py-4 border-2 border-slate-100 rounded-2xl font-black text-slate-400 uppercase tracking-widest text-xs btn-hover">Batal</button>
                    <button onclick="window.saveSelfEdit()" class="py-4 bg-emerald-600 text-white rounded-2xl font-black shadow-xl btn-hover uppercase tracking-widest text-xs">SIMPAN PERUBAAN</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Konfirmasi Reset Data -->
    <div id="confirmResetDataModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-red-950/80 backdrop-blur-xl" onclick="closeModal('confirmResetDataModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-10 bg-white rounded-[3rem] shadow-2xl animate-[modalUp_0.4s]">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-red-50 text-red-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner animate-pulse">
                    <i class="fas fa-triangle-exclamation text-3xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 tracking-tight uppercase">Hapus Semua?</h3>
                <p class="text-xs text-slate-500 font-bold mt-3 leading-relaxed">Operasi ini akan menghapus seluruh data pendaftaran, absensi, dan berkat secara permanen.</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="resetConfirmText" placeholder="Ketik 'RESET' untuk konfirmasi" class="form-input w-full rounded-2xl p-4 text-center font-black uppercase tracking-widest text-red-600 border-red-100">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal('confirmResetDataModal')" class="py-4 border-2 border-slate-100 rounded-2xl font-black text-slate-400 uppercase tracking-widest text-xs btn-hover">Batal</button>
                    <button onclick="window.executeResetData()" class="py-4 bg-red-600 text-white rounded-2xl font-black shadow-lg uppercase tracking-widest text-xs btn-hover">YA, HAPUS</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Admin Login -->
    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-xl" onclick="closeModal('adminModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-10 bg-white rounded-[3rem] shadow-2xl animate-[modalUp_0.4s]">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-emerald-50 text-emerald-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner transform rotate-12">
                    <i class="fas fa-lock text-3xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 tracking-tight uppercase royal-font">Akses Panitia</h3>
                <p class="text-[10px] text-slate-400 font-black uppercase mt-2 tracking-[0.2em]">Verifikasi Keamanan</p>
            </div>
            <input type="password" id="adminPassword" placeholder="••••" maxlength="8" class="form-input w-full rounded-2xl p-5 text-center text-4xl font-black mb-6 tracking-[0.5em] shadow-inner">
            <button onclick="window.verifyAdmin()" class="w-full py-5 bg-emerald-600 text-white rounded-[1.5rem] font-black btn-hover btn-modern shadow-xl uppercase tracking-widest">MASUK SEKARANG</button>
            
            <!-- Link Lupa PIN -->
            <div class="mt-6 text-center">
                <button onclick="window.openResetFacility()" class="text-xs font-black text-emerald-600 hover:text-emerald-800 uppercase tracking-widest underline underline-offset-8 transition-colors">Lupa PIN Admin?</button>
            </div>
        </div>
    </div>

    <!-- Modal Reset Admin PIN -->
    <div id="resetAdminModal" class="fixed inset-0 z-[9100] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-xl" onclick="closeModal('resetAdminModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-10 bg-white rounded-[3rem] shadow-2xl animate-[modalUp_0.4s]">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-amber-50 text-amber-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="fas fa-key-skeleton text-3xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 tracking-tight uppercase">Pemulihan Akses</h3>
                <p class="text-[10px] text-slate-400 font-black uppercase mt-2 tracking-[0.2em]">Masukkan Kode Pemulihan</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="recoveryKeyInput" placeholder="KODE PEMULIHAN" class="form-input w-full rounded-2xl p-4 text-center font-black uppercase tracking-widest text-emerald-700">
                <div class="pt-4">
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block pl-2">Setel PIN Admin Baru</label>
                    <input type="password" id="newAdminPinReset" placeholder="••••" maxlength="8" class="form-input w-full rounded-2xl p-4 text-center text-3xl font-black tracking-[0.5em]">
                </div>
                <button onclick="window.handleResetAdminPin()" class="w-full py-5 bg-emerald-600 text-white rounded-2xl font-black shadow-xl uppercase tracking-widest text-xs btn-hover btn-modern">Simpan PIN Baru</button>
            </div>
        </div>
    </div>

    <!-- Modal Auth PIN -->
    <div id="authTicketModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/90 backdrop-blur-xl" onclick="closeModal('authTicketModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-10 bg-white rounded-[3rem] shadow-2xl animate-[modalUp_0.4s]">
            <h3 class="text-2xl font-black text-slate-800 text-center mb-4 uppercase royal-font tracking-tight" id="authTitle">Verifikasi</h3>
            <p class="text-[10px] text-slate-400 font-black text-center mb-8 uppercase tracking-widest" id="authDesc">MASUKKAN PIN UNTUK <span id="authUserName" class="text-emerald-600 font-black"></span></p>
            <input type="password" id="ticketPassInput" placeholder="••••" maxlength="4" class="form-input w-full rounded-2xl p-5 text-center text-4xl font-black mb-8 tracking-[0.5em] shadow-inner">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('authTicketModal')" class="py-5 border-2 border-slate-100 rounded-2xl font-black text-slate-400 uppercase tracking-widest text-xs btn-hover">Batal</button>
                <button onclick="window.verifyTicketPass()" class="py-5 bg-emerald-600 text-white rounded-2xl font-black shadow-xl btn-hover uppercase tracking-widest text-xs">KONFIRMASI</button>
            </div>
        </div>
    </div>

    <!-- Modal Tiket Digital -->
    <div id="ticketModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden p-4 overflow-y-auto">
        <div class="absolute inset-0 bg-slate-950/98 backdrop-blur-3xl" onclick="closeModal('ticketModal')"></div>
        <div class="relative w-full max-w-sm my-10 animate-[modalUp_0.5s]">
            <div id="vipTicketCard" class="vip-ticket rounded-[3rem] p-10 shadow-2xl border border-white/10">
                <div class="relative z-10 text-center">
                    <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl overflow-hidden">
                        <img src="logo tugu manihuruk.png" class="w-14 h-14">
                    </div>
                    <div class="badge-luxury mb-2">OFFICIAL INVITATION</div>
                    <h2 class="royal-font text-3xl font-black gold-text uppercase leading-none mt-2">BONATAON 2026</h2>
                    <div class="my-10">
                        <p class="text-slate-500 text-[10px] font-black uppercase mb-2 tracking-[0.3em]">Tamu Kehormatan</p>
                        <h1 id="ticName" class="text-2xl font-black text-white leading-tight uppercase mb-4">...</h1>
                        <div id="ticMeta" class="inline-flex gap-2 text-[9px] text-emerald-400 font-black uppercase tracking-widest bg-white/5 px-4 py-2 rounded-full border border-white/5"></div>
                    </div>
                    <div class="ticket-perforation bg-white p-8 rounded-[2.5rem] shadow-2xl relative">
                        <div id="qrLoading" class="w-48 h-48 mx-auto flex items-center justify-center bg-slate-50 rounded-2xl">
                            <i class="fas fa-circle-notch fa-spin text-emerald-600 text-2xl"></i>
                        </div>
                        <img id="ticQR" src="" class="w-52 h-52 object-contain mx-auto hidden rounded-xl">
                        <div class="text-center mt-6">
                            <div class="text-[9px] text-slate-400 font-black uppercase tracking-widest mb-1">Registration Code</div>
                            <div class="text-xl font-mono font-black text-slate-900 bg-slate-50 py-2 rounded-xl" id="ticCode">...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-8 flex flex-col gap-4">
                <button onclick="window.openSelfEdit()" class="w-full py-5 rounded-[1.5rem] bg-amber-500 text-white font-black text-sm shadow-xl flex items-center justify-center gap-3 btn-hover btn-modern uppercase tracking-widest">
                    <i class="fas fa-user-edit"></i> PERBAIKI NAMA / PIN
                </button>
                <button onclick="window.downloadTicketImage()" class="w-full py-5 rounded-[1.5rem] bg-white text-emerald-900 font-black text-sm shadow-xl flex items-center justify-center gap-3 btn-hover btn-modern uppercase tracking-widest">
                    <i class="fas fa-download"></i> SIMPAN TIKET KE GALERI
                </button>
                <button onclick="closeModal('ticketModal')" class="text-white/40 text-[10px] font-black py-2 uppercase tracking-[0.4em] btn-hover">Tutup Jendela</button>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            staff: [],
            tab: 'register',
            scanner: null,
            isAdmin: false,
            isStaff: false,
            adminPass: "1234",
            recoveryKey: "BONA2026",
            activeUser: null,
            tempUser: null,
            filterStatus: "Semua",
            adminSearchQuery: "",
            reportSearchQuery: "",
            isProcessingScan: false,
            charts: {}
        };

        // Realtime Listeners
        onValue(ref(db, 'settings/adminPin'), s => { if(s.val()) state.adminPass = s.val(); });
        onValue(ref(db, 'staff'), s => { 
            const data = s.val();
            state.staff = data ? Object.keys(data).map(k => ({...data[k], firebaseId: k})) : [];
            if(state.tab === 'data') {
                renderStaffList();
            }
        });
        onValue(ref(db, 'participants'), s => { 
            const data = s.val();
            state.participants = data ? Object.keys(data).map(k => ({...data[k], firebaseId: k})) : []; 
            updateDashboard(); 
        });
        onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'gifts'), s => { state.gifts = s.val() ? Object.values(s.val()) : []; updateDashboard(); });

        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' });
            const date = now.toLocaleDateString('id-ID', { day:'numeric', month:'short' });
            if(document.getElementById('liveClock')) document.getElementById('liveClock').innerHTML = `<div class="text-[10px] font-black opacity-60 uppercase tracking-widest mb-1">${date}</div><div class="text-2xl font-black">${time}</div>`;
        }
        setInterval(updateClock, 1000); updateClock();

        function updateDashboard() {
            if(document.getElementById('statRegistered')) document.getElementById('statRegistered').innerText = state.participants.length;
            if(document.getElementById('statPresent')) document.getElementById('statPresent').innerText = state.attendance.length;
            if(document.getElementById('statGifts')) document.getElementById('statGifts').innerText = state.gifts.length;
            
            if(state.tab === 'register') renderParticipantList();
            if(state.tab === 'data') {
                renderDataTable();
                renderStaffList();
            }
            if(state.tab === 'report') {
                renderLiveReport();
                renderReportTable();
            }
            
            setTimeout(() => document.getElementById('loading')?.classList.add('hidden'), 500);
        }

        // --- AUTH & ROLES ---
        window.showAdminLogin = () => {
            if (state.isAdmin || state.isStaff) return;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModal').classList.remove('hidden');
        };

        window.verifyAdmin = () => {
            const p = document.getElementById('adminPassword').value;
            if(p === state.adminPass) {
                state.isAdmin = true;
                state.isStaff = false;
                closeModal('adminModal');
                refreshUIVisibility();
                setTab('report');
                return;
            }
            const staffMatch = state.staff.find(s => s.pin === p);
            if(staffMatch) {
                state.isStaff = true;
                state.isAdmin = false;
                closeModal('adminModal');
                refreshUIVisibility();
                setTab('scan');
                return;
            }
            alert("PIN Salah!");
        };

        window.adminLogout = () => {
            if(confirm("Keluar dari Mode Panitia?")) {
                state.isAdmin = false;
                state.isStaff = false;
                refreshUIVisibility();
                setTab('register');
            }
        };

        // --- LUPA PIN ADMIN FACILITY ---
        window.openResetFacility = () => {
            closeModal('adminModal');
            document.getElementById('recoveryKeyInput').value = '';
            document.getElementById('newAdminPinReset').value = '';
            document.getElementById('resetAdminModal').classList.remove('hidden');
        };

        window.handleResetAdminPin = () => {
            const recoveryInput = document.getElementById('recoveryKeyInput').value.trim().toUpperCase();
            const newPin = document.getElementById('newAdminPinReset').value.trim();
            
            if (recoveryInput !== state.recoveryKey) {
                return alert("Kode Pemulihan Salah!");
            }
            
            if (newPin.length < 4) {
                return alert("PIN Baru minimal 4 digit!");
            }
            
            set(ref(db, 'settings/adminPin'), newPin).then(() => {
                alert("PIN Admin Berhasil Diperbarui!");
                state.adminPass = newPin;
                closeModal('resetAdminModal');
                window.showAdminLogin();
            }).catch(e => {
                alert("Gagal memperbarui PIN di server.");
            });
        };

        function refreshUIVisibility() {
            const navButtons = document.querySelectorAll('.nav-btn');
            const logoutBtn = document.getElementById('tab-logout');
            const roleBadge = document.getElementById('roleBadge');
            navButtons.forEach(btn => {
                const isStaffTab = btn.classList.contains('staff-tab');
                const isAdminTab = btn.classList.contains('admin-tab');
                const isPublicTab = btn.classList.contains('public-tab');
                
                if (state.isAdmin) {
                    btn.classList.remove('hidden');
                } else if (state.isStaff) {
                    if (isStaffTab || isPublicTab) btn.classList.remove('hidden');
                    else btn.classList.add('hidden');
                } else {
                    if (isPublicTab) btn.classList.remove('hidden');
                    else btn.classList.add('hidden');
                }
            });
            if (state.isAdmin || state.isStaff) {
                logoutBtn.classList.remove('hidden');
                roleBadge.classList.remove('hidden');
                roleBadge.innerText = state.isAdmin ? "Mode Administrator" : "Petugas Lapangan";
            } else {
                logoutBtn.classList.add('hidden');
                roleBadge.classList.add('hidden');
            }
        }

        // --- CORE TAB LOGIC ---
        window.setTab = async (t) => {
            if(state.scanner) { 
                try { 
                    await state.scanner.stop(); 
                } catch(e) {
                    console.log("Scanner stop error ignored:", e);
                } 
                state.scanner = null; 
            }
            state.tab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}`));
            const area = document.getElementById('content-area');
            
            if(t === 'register') {
                area.innerHTML = `
                <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl mb-10 border border-slate-100 animate-[modalUp_0.5s]">
                    <h3 class="text-xl font-black text-slate-800 mb-8 flex items-center gap-3 uppercase royal-font tracking-tight"><i class="fas fa-id-card text-emerald-600"></i> Form Pendaftaran</h3>
                    <div class="space-y-5">
                        <input id="inName" type="text" class="form-input w-full rounded-2xl p-5 font-black uppercase" placeholder="NAMA LENGKAP">
                        <div class="grid grid-cols-2 gap-5">
                            <select id="inStatus" class="form-input w-full rounded-2xl p-5 font-black uppercase">
                                <option value="Orangtua">Orangtua</option><option value="Pemuda">Pemuda</option><option value="Sekolah Minggu">Sekolah Minggu</option><option value="Tamu">Tamu</option>
                            </select>
                            <select id="inMarga" class="form-input w-full rounded-2xl p-5 font-black uppercase">
                                <option value="Manihuruk">Manihuruk</option><option value="Boru">Boru</option><option value="Bere">Bere</option>
                            </select>
                        </div>
                        <input id="inPass" type="password" maxlength="4" class="form-input w-full rounded-2xl p-5 font-black text-center text-2xl tracking-[0.5em]" placeholder="PIN 4 DIGIT">
                        <button onclick="window.processRegister()" class="w-full bg-emerald-600 text-white rounded-[1.5rem] py-5 font-black shadow-xl btn-hover btn-modern uppercase tracking-[0.2em] mt-4">DAFTARKAN SAYA</button>
                    </div>
                </div>
                <div id="participantList" class="space-y-4"></div>`;
                renderParticipantList();
            } else if(t === 'find') {
                area.innerHTML = `
                <div class="bg-white rounded-[2.5rem] p-10 shadow-2xl text-center border border-slate-100 animate-[modalUp_0.5s]">
                    <div class="w-24 h-24 bg-emerald-50 rounded-[2rem] flex items-center justify-center mx-auto mb-8 text-emerald-600 text-4xl shadow-inner"><i class="fas fa-magnifying-glass"></i></div>
                    <h3 class="font-black text-2xl mb-8 text-slate-800 uppercase royal-font tracking-tight">Temukan Undangan</h3>
                    <div class="space-y-6">
                        <input id="findName" type="text" placeholder="Masukkan Nama Anda" class="form-input w-full rounded-2xl p-5 text-center font-black uppercase tracking-wider">
                        <button onclick="window.findTicket()" class="w-full bg-emerald-700 text-white rounded-[1.5rem] py-5 font-black btn-hover btn-modern shadow-2xl uppercase tracking-[0.2em]">CARI TIKET</button>
                    </div>
                </div>`;
            } else if(t === 'scan' || t === 'gift') {
                area.innerHTML = `
                <div class="bg-white rounded-[2.5rem] p-8 shadow-2xl text-center border border-slate-100 animate-[modalUp_0.5s]">
                    <h3 class="font-black mb-8 text-slate-800 tracking-tight uppercase royal-font text-xl">SCAN ${t === 'scan' ? 'KEHADIRAN' : 'BERKAT'}</h3>
                    <div id="scanMsg" class="hidden p-4 rounded-2xl mb-6 text-white font-black shadow-xl"></div>
                    <div class="relative rounded-3xl overflow-hidden bg-black aspect-square max-w-sm mx-auto mb-10 shadow-inner">
                        <div id="reader"></div>
                        <div class="scan-frame"></div>
                    </div>
                    <button onclick="window.openManualInput('${t}')" class="w-full py-5 bg-slate-900 text-white rounded-[1.5rem] font-black text-xs shadow-2xl flex items-center justify-center gap-4 btn-hover uppercase tracking-widest">INPUT MANUAL</button>
                </div>`;
                setTimeout(initScanner, 300);
            } else if(t === 'report') {
                renderLiveReport();
            } else if(t === 'data') {
                renderAdminPanel();
            }
        };

        // --- REGISTRATION & EDITMandiri ---
        window.processRegister = () => {
            const name = document.getElementById('inName').value.trim();
            const pass = document.getElementById('inPass').value;
            if(!name || pass.length < 4) return alert("Harap lengkapi Nama & PIN!");
            const code = `MN-${Date.now().toString().slice(-6)}`;
            const data = { name: name.toUpperCase(), status: document.getElementById('inStatus').value, marga: document.getElementById('inMarga').value, password: pass, qrCode: code, registeredAt: new Date().toLocaleString() };
            push(ref(db, 'participants'), data).then(() => { alert("Pendaftaran Berhasil!"); window.showTicket(data); });
        };

        window.openSelfEdit = () => {
            if(!state.activeUser) return;
            document.getElementById('editName').value = state.activeUser.name;
            document.getElementById('editStatus').value = state.activeUser.status;
            document.getElementById('editMarga').value = state.activeUser.marga;
            document.getElementById('editPass').value = state.activeUser.password;
            closeModal('ticketModal');
            document.getElementById('editUserModal').classList.remove('hidden');
        };

        window.saveSelfEdit = () => {
            const name = document.getElementById('editName').value.trim().toUpperCase();
            const status = document.getElementById('editStatus').value;
            const marga = document.getElementById('editMarga').value;
            const pass = document.getElementById('editPass').value;
            if(!name || pass.length < 4) return alert("Nama & PIN tidak boleh kosong!");

            const userRef = ref(db, 'participants/' + state.activeUser.firebaseId);
            update(userRef, { name, status, marga, password: pass }).then(() => {
                alert("Profil Berhasil Diperbarui!");
                const updatedUser = { ...state.activeUser, name, status, marga, password: pass };
                state.activeUser = updatedUser;
                closeModal('editUserModal');
                window.showTicket(updatedUser);
            });
        };

        // --- LIVE REPORT ---
        function renderLiveReport() {
            const area = document.getElementById('content-area');
            const attendanceList = [...state.attendance].reverse().slice(0, 10);
            
            area.innerHTML = `
            <div class="space-y-8 animate-[modalUp_0.5s]">
                <div class="flex justify-between items-center px-4">
                    <h3 class="text-2xl font-black text-slate-800 royal-font uppercase tracking-tight flex items-center gap-3">
                        <span class="live-dot"></span> Live Event Monitoring
                    </h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100">
                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Demografi Pendaftar</h4>
                        <div class="relative aspect-square">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-xl border border-slate-100 flex flex-col max-h-[400px]">
                        <h4 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-6">Aktivitas Terkini</h4>
                        <div class="flex-1 overflow-y-auto custom-scrollbar space-y-3">
                            ${attendanceList.length ? attendanceList.map(a => `
                                <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center gap-4 animate-[modalUp_0.3s]">
                                    <div class="w-10 h-10 rounded-full bg-emerald-500 text-white flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-check text-xs"></i>
                                    </div>
                                    <div>
                                        <div class="font-black text-slate-800 text-xs uppercase">${a.name}</div>
                                        <div class="text-[9px] text-slate-400 font-bold uppercase mt-1">${a.timestamp}</div>
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center py-10 text-slate-300 font-black text-[10px] uppercase">Belum ada kehadiran</div>'}
                        </div>
                    </div>
                </div>

                <div class="bg-emerald-600 rounded-[2.5rem] p-8 shadow-2xl relative overflow-hidden">
                    <div class="relative z-10 grid grid-cols-2 md:grid-cols-4 gap-6 text-white text-center">
                        <div>
                            <div class="text-xs font-black opacity-60 uppercase tracking-widest mb-2">Manihuruk</div>
                            <div class="text-3xl font-black">${state.participants.filter(p => p.marga === 'Manihuruk').length}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black opacity-60 uppercase tracking-widest mb-2">Boru</div>
                            <div class="text-3xl font-black">${state.participants.filter(p => p.marga === 'Boru').length}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black opacity-60 uppercase tracking-widest mb-2">Bere</div>
                            <div class="text-3xl font-black">${state.participants.filter(p => p.marga === 'Bere').length}</div>
                        </div>
                        <div>
                            <div class="text-xs font-black opacity-60 uppercase tracking-widest mb-2">Total Marga</div>
                            <div class="text-3xl font-black">${state.participants.length}</div>
                        </div>
                    </div>
                    <div class="absolute inset-0 bg-white/5 pointer-events-none"></div>
                </div>

                <!-- Report Detail Table Section -->
                <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-slate-100 overflow-hidden">
                    <div class="flex flex-wrap justify-between items-center gap-5 mb-8">
                        <h4 class="text-sm font-black text-slate-800 uppercase tracking-widest flex items-center gap-3">
                            <i class="fas fa-list-check text-emerald-600"></i> Detail Kehadiran Peserta
                        </h4>
                        <div class="relative w-full md:w-64">
                            <input type="text" onkeyup="window.handleReportSearch(this.value)" placeholder="CARI PESERTA..." class="form-input w-full rounded-2xl py-3 px-10 text-[10px] font-black uppercase shadow-sm">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                        </div>
                    </div>
                    <div id="reportTableContainer" class="overflow-x-auto custom-scrollbar"></div>
                </div>
            </div>`;

            const ctx = document.getElementById('categoryChart').getContext('2d');
            const catData = ['Orangtua', 'Pemuda', 'Sekolah Minggu', 'Tamu'].map(c => state.participants.filter(p => p.status === c).length);
            
            if(state.charts.category) state.charts.category.destroy();
            state.charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Orangtua', 'Pemuda', 'Sekolah Minggu', 'Tamu'],
                    datasets: [{
                        data: catData,
                        backgroundColor: ['#064e3b', '#10b981', '#34d399', '#f59e0b'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { family: 'Plus Jakarta Sans', weight: '800', size: 10 }, padding: 20 } }
                    },
                    cutout: '70%'
                }
            });
            renderReportTable();
        }

        window.renderReportTable = () => {
            const container = document.getElementById('reportTableContainer');
            if(!container) return;
            
            let filtered = state.participants;
            if(state.reportSearchQuery) {
                filtered = filtered.filter(p => p.name.toLowerCase().includes(state.reportSearchQuery));
            }

            container.innerHTML = `
            <table class="w-full text-left text-[10px]">
                <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest border-b border-slate-100">
                    <tr><th class="p-4">Nama Peserta</th><th class="p-4">Kategori</th><th class="p-4">Status</th><th class="p-4">Waktu Hadir</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    ${filtered.map(p => {
                        const attendData = state.attendance.find(a => a.qrCode === p.qrCode);
                        const isPresent = !!attendData;
                        return `
                        <tr>
                            <td class="p-4">
                                <div class="font-black text-slate-800 text-xs uppercase">${p.name}</div>
                                <div class="text-[8px] font-bold text-slate-400 uppercase mt-1">${p.marga}</div>
                            </td>
                            <td class="p-4"><span class="font-bold text-slate-500 uppercase">${p.status}</span></td>
                            <td class="p-4">
                                ${isPresent 
                                    ? `<span class="bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full font-black text-[9px] uppercase tracking-wider flex items-center gap-2 w-fit"><i class="fas fa-check-circle"></i> HADIR</span>`
                                    : `<span class="bg-slate-100 text-slate-400 px-3 py-1 rounded-full font-black text-[9px] uppercase tracking-wider flex items-center gap-2 w-fit">BELUM HADIR</span>`
                                }
                            </td>
                            <td class="p-4 font-mono font-bold text-slate-500">${isPresent ? attendData.timestamp : '-'}</td>
                        </tr>`;
                    }).join('')}
                    ${filtered.length === 0 ? '<tr><td colspan="4" class="p-10 text-center text-slate-300 font-black uppercase tracking-widest">Data tidak ditemukan</td></tr>' : ''}
                </tbody>
            </table>`;
        };

        window.handleReportSearch = (val) => {
            state.reportSearchQuery = val.toLowerCase().trim();
            renderReportTable();
        };

        // --- ADMIN PANEL ---
        function renderAdminPanel() {
            const area = document.getElementById('content-area');
            area.innerHTML = `
            <div class="space-y-8 animate-[modalUp_0.5s]">
                <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-slate-100">
                    <div class="flex flex-wrap justify-between items-center gap-5 mb-10">
                        <h3 class="text-xl font-black text-slate-800 flex items-center gap-3 tracking-tight uppercase royal-font"><i class="fas fa-crown text-emerald-600"></i> Admin Panel</h3>
                        <div class="flex flex-wrap gap-3">
                            <button onclick="window.exportToCSV()" class="bg-emerald-50 px-5 py-3 rounded-2xl text-emerald-700 text-[10px] font-black hover:bg-emerald-100 transition-all flex items-center gap-2 uppercase tracking-widest shadow-sm">
                                <i class="fas fa-users"></i> EKSPOR PENDAFTAR
                            </button>
                            <button onclick="window.exportAttendanceToCSV()" class="bg-blue-50 px-5 py-3 rounded-2xl text-blue-700 text-[10px] font-black hover:bg-blue-100 transition-all flex items-center gap-2 uppercase tracking-widest shadow-sm border border-blue-100">
                                <i class="fas fa-clipboard-user"></i> EKSPOR ABSENSI
                            </button>
                            <button onclick="window.exportGiftsToCSV()" class="bg-amber-50 px-5 py-3 rounded-2xl text-amber-700 text-[10px] font-black hover:bg-amber-100 transition-all flex items-center gap-2 uppercase tracking-widest shadow-sm border border-amber-100">
                                <i class="fas fa-gift"></i> EKSPOR BERKAT
                            </button>
                            <button onclick="window.promptResetAll()" class="bg-red-50 px-5 py-3 rounded-2xl text-red-700 text-[10px] font-black hover:bg-red-100 transition-all flex items-center gap-2 uppercase tracking-widest shadow-sm border border-red-100">
                                <i class="fas fa-trash-can"></i> RESET SEMUA
                            </button>
                        </div>
                    </div>

                    <!-- Filter & Search -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-10">
                        <input type="text" onkeyup="window.handleAdminSearch(this.value)" placeholder="CARI PESERTA..." class="form-input w-full rounded-2xl p-4 text-sm font-black uppercase">
                        <select onchange="window.updateTableFilter(this.value)" class="form-input rounded-2xl px-5 py-4 text-sm font-black bg-slate-50 border-slate-200">
                            <option value="Semua">TAMPILKAN SEMUA</option>
                            <option value="Orangtua">ORANGTUA</option>
                            <option value="Pemuda">PEMUDA</option>
                            <option value="Sekolah Minggu">SEKOLAH MINGGU</option>
                            <option value="Tamu">TAMU</option>
                        </select>
                    </div>

                    <!-- Staff Management section -->
                    <div class="border-t border-slate-100 pt-10">
                        <div class="flex items-center gap-3 mb-8">
                            <div class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center text-xs shadow-sm">
                                <i class="fas fa-user-shield"></i>
                            </div>
                            <h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Manajemen Petugas Lapangan</h4>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-8">
                            <div class="md:col-span-5">
                                <input id="newStaffName" type="text" placeholder="NAMA LENGKAP PETUGAS" class="form-input w-full rounded-2xl p-4 text-[11px] font-black uppercase">
                            </div>
                            <div class="md:col-span-3">
                                <input id="newStaffPin" type="password" maxlength="6" placeholder="PIN (MIN 4 DIGIT)" class="form-input w-full rounded-2xl p-4 text-[11px] font-black text-center">
                            </div>
                            <div class="md:col-span-4">
                                <button onclick="window.addStaffMember()" class="w-full h-full bg-emerald-600 text-white rounded-2xl font-black text-[11px] uppercase tracking-widest btn-hover shadow-lg py-4 md:py-0">
                                    <i class="fas fa-plus mr-2"></i> TAMBAH AKSES
                                </button>
                            </div>
                        </div>
                        <div id="staffListContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-100">
                    <div id="adminTableContainer" class="overflow-x-auto custom-scrollbar"></div>
                </div>
            </div>`;
            renderDataTable();
            renderStaffList();
        }

        window.renderDataTable = () => {
            const container = document.getElementById('adminTableContainer');
            if(!container) return;
            let filtered = state.participants;
            if(state.filterStatus !== "Semua") filtered = filtered.filter(p => p.status === state.filterStatus);
            if(state.adminSearchQuery) filtered = filtered.filter(p => p.name.toLowerCase().includes(state.adminSearchQuery));
            
            container.innerHTML = `
            <table class="w-full text-left text-[11px]">
                <thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest border-b border-slate-100">
                    <tr><th class="p-6">Informasi</th><th class="p-6">Kategori</th><th class="p-6 text-center">Aksi</th></tr>
                </thead>
                <tbody class="divide-y divide-slate-50">
                    ${filtered.map(p => `
                        <tr>
                            <td class="p-6">
                                <div class="font-black text-slate-800 text-sm uppercase">${p.name}</div>
                                <div class="text-[9px] font-mono text-emerald-500 mt-1 font-bold">${p.qrCode}</div>
                            </td>
                            <td class="p-6"><span class="bg-slate-100 px-3 py-1 rounded-full font-black text-slate-500">${p.status}</span></td>
                            <td class="p-6 text-center">
                                <button onclick="window.adminDeleteUser('${p.firebaseId}')" class="text-red-400 hover:text-red-600 w-10 h-10 flex items-center justify-center bg-red-50 rounded-xl mx-auto"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`).join('')}
                </tbody>
            </table>`;
        };

        window.renderStaffList = () => {
            const container = document.getElementById('staffListContainer');
            if(!container) return;
            container.innerHTML = state.staff.map(s => `
                <div class="bg-slate-50 p-5 rounded-[1.5rem] border border-slate-100 flex justify-between items-center animate-[modalUp_0.3s] shadow-sm">
                    <div>
                        <div class="font-black text-slate-800 text-[11px] uppercase tracking-wide">${s.name}</div>
                        <div class="text-[9px] text-emerald-600 font-black uppercase mt-1 bg-emerald-50 px-2 py-0.5 rounded-full inline-block border border-emerald-100">PIN: ${s.pin}</div>
                    </div>
                    <button onclick="window.removeStaffMember('${s.firebaseId}')" class="text-red-400 hover:text-red-600 w-10 h-10 flex items-center justify-center bg-white rounded-xl shadow-inner border border-slate-100 transition-colors">
                        <i class="fas fa-trash-can text-xs"></i>
                    </button>
                </div>
            `).join('') || '<div class="col-span-full text-center py-10 text-slate-300 font-black text-[10px] uppercase border-2 border-dashed border-slate-100 rounded-[1.5rem]">Belum ada petugas lapangan</div>';
        };

        window.addStaffMember = () => {
            const name = document.getElementById('newStaffName').value.trim().toUpperCase();
            const pin = document.getElementById('newStaffPin').value.trim();
            if(!name || pin.length < 4) return alert("Harap isi Nama dan PIN (Min. 4 Digit)");
            
            if(state.staff.some(s => s.pin === pin) || pin === state.adminPass) {
                return alert("PIN sudah digunakan. Gunakan PIN lain.");
            }
            
            push(ref(db, 'staff'), { name, pin }).then(() => {
                document.getElementById('newStaffName').value = '';
                document.getElementById('newStaffPin').value = '';
                alert("Petugas berhasil ditambahkan!");
            });
        };

        window.removeStaffMember = (id) => {
            if(confirm("Hapus akses petugas ini?")) {
                remove(ref(db, 'staff/' + id)).then(() => alert("Akses petugas dihapus."));
            }
        };

        // --- TICKETS & SCANNER ---
        window.showTicket = async (user) => {
            state.activeUser = user;
            document.getElementById('ticName').innerText = user.name;
            document.getElementById('ticCode').innerText = user.qrCode;
            document.getElementById('ticMeta').innerText = `${user.marga} • ${user.status}`;
            const qrImg = document.getElementById('ticQR');
            const qrLoader = document.getElementById('qrLoading');
            qrImg.classList.add('hidden');
            qrLoader.classList.remove('hidden');
            document.getElementById('ticketModal').classList.remove('hidden');
            try {
                const url = await QRCode.toDataURL(user.qrCode, { errorCorrectionLevel: 'H', margin: 2, width: 800, color: { dark: "#064e3b", light: "#ffffff" } });
                qrImg.src = url;
                qrImg.onload = () => { qrLoader.classList.add('hidden'); qrImg.classList.remove('hidden'); };
            } catch (e) { qrLoader.innerHTML = `<span>ERROR</span>`; }
        };

        window.findTicket = () => {
            const q = document.getElementById('findName').value.toLowerCase().trim();
            if(!q) return alert("Masukkan nama!");
            const matches = state.participants.filter(x => x.name.toLowerCase().includes(q));
            if(!matches.length) alert("Nama tidak ditemukan!");
            else if(matches.length === 1) window.startAuth(matches[0]);
            else alert("Ditemukan lebih dari satu nama. Gunakan nama lengkap.");
        };

        window.startAuth = (user) => {
            state.tempUser = user;
            document.getElementById('authUserName').innerText = user.name;
            document.getElementById('ticketPassInput').value = '';
            document.getElementById('authTicketModal').classList.remove('hidden');
        };

        window.verifyTicketPass = () => {
            if(state.tempUser && document.getElementById('ticketPassInput').value === state.tempUser.password) {
                window.showTicket(state.tempUser);
                closeModal('authTicketModal');
            } else alert("PIN Salah!");
        };

        function initScanner() {
            const msgEl = document.getElementById('scanMsg');
            const readerDiv = document.getElementById('reader');
            if (!readerDiv) return;

            state.scanner = new Html5Qrcode("reader");
            
            const config = { 
                fps: 10, 
                qrbox: (viewWidth, viewHeight) => {
                    const minEdge = Math.min(viewWidth, viewHeight);
                    const boxSize = Math.floor(minEdge * 0.7);
                    return { width: boxSize, height: boxSize };
                },
                aspectRatio: 1.0,
                showTorchButtonIfSupported: true
            };

            state.scanner.start(
                { facingMode: "environment" }, 
                config, 
                (text) => {
                    if (state.isProcessingScan) return;
                    state.isProcessingScan = true;
                    const scannedText = text.trim().toUpperCase();
                    const p = state.participants.find(x => x.qrCode && x.qrCode.trim().toUpperCase() === scannedText);
                    
                    if(!p) {
                        msgEl.innerText = "KODE QR TIDAK TERDAFTAR!";
                        msgEl.className = "p-4 rounded-2xl mb-6 bg-red-600 text-white font-black block shadow-xl";
                        setTimeout(() => { state.isProcessingScan = false; msgEl.classList.add('hidden'); }, 3000);
                        return;
                    }

                    const path = state.tab === 'scan' ? 'attendance' : 'gifts';
                    const listToCheck = state.tab === 'scan' ? state.attendance : state.gifts;
                    const alreadyExists = listToCheck.find(item => item.qrCode === p.qrCode);

                    if (alreadyExists) {
                        const duplicateMsg = state.tab === 'scan' ? `${p.name} SUDAH HADIR!` : `${p.name} SUDAH TERIMA BERKAT!`;
                        msgEl.innerText = duplicateMsg;
                        msgEl.className = "p-4 rounded-2xl mb-6 bg-amber-500 text-white font-black block shadow-xl animate-pulse";
                        setTimeout(() => { state.isProcessingScan = false; msgEl.classList.add('hidden'); }, 3000);
                        return;
                    }

                    push(ref(db, path), { name: p.name, qrCode: p.qrCode, timestamp: new Date().toLocaleString() }).then(() => {
                        const successMsg = state.tab === 'scan' ? `Selamat Datang, ${p.name}!` : `Berkat Berhasil Diberikan ke ${p.name}!`;
                        msgEl.innerText = successMsg;
                        msgEl.className = "p-4 rounded-2xl mb-6 bg-emerald-600 text-white font-black block shadow-xl animate-bounce";
                        setTimeout(() => { state.isProcessingScan = false; msgEl.classList.add('hidden'); }, 3000);
                    });
                },
                (errorMessage) => {}
            ).catch(err => {
                console.error("Camera access error:", err);
                msgEl.innerText = "Kamera Gagal Diakses.";
                msgEl.className = "p-4 rounded-2xl mb-6 bg-red-600 text-white font-black block shadow-xl";
                msgEl.classList.remove('hidden');
                state.isProcessingScan = false;
            });
        }

        // --- MISC UTILITIES ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.handleAdminSearch = (val) => { state.adminSearchQuery = val.toLowerCase(); renderDataTable(); };
        window.updateTableFilter = (val) => { state.filterStatus = val; renderDataTable(); };
        window.adminDeleteUser = (id) => { if(confirm("Hapus pendaftar ini?")) remove(ref(db, 'participants/' + id)); };
        
        window.downloadTicketImage = () => {
            html2canvas(document.getElementById('vipTicketCard'), { scale: 3, backgroundColor: '#0f172a' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Tiket_Bonataon_${state.activeUser.name.replace(/\s+/g, '_')}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        window.promptResetAll = () => {
            document.getElementById('resetConfirmText').value = '';
            document.getElementById('confirmResetDataModal').classList.remove('hidden');
        };

        window.executeResetData = () => {
            if (document.getElementById('resetConfirmText').value.trim().toUpperCase() !== 'RESET') return alert("Ketik 'RESET'!");
            Promise.all([set(ref(db, 'participants'), null), set(ref(db, 'attendance'), null), set(ref(db, 'gifts'), null)]).then(() => {
                alert("Data dibersihkan!"); closeModal('confirmResetDataModal');
            });
        };

        window.exportToCSV = () => {
            if (state.participants.length === 0) return alert("Belum ada data pendaftar!");
            const rows = state.participants.map(p => [`"${p.name}"`, `"${p.status}"`, `"${p.marga}"`, `"${p.qrCode}"`]);
            let csv = "\ufeffNama,Kategori,Marga,Kode\n" + rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url; link.download = "Pendaftar_Bonataon2026.csv"; link.click();
        };

        window.exportAttendanceToCSV = () => {
            if (state.attendance.length === 0) return alert("Belum ada data absensi!");
            const rows = state.attendance.map(a => [`"${a.name}"`, `"${a.qrCode}"`, `"${a.timestamp}"`]);
            let csv = "\ufeffNama,Kode QR,Waktu Hadir\n" + rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url; link.download = "Absensi_Bonataon2026.csv"; link.click();
        };

        window.exportGiftsToCSV = () => {
            if (state.gifts.length === 0) return alert("Belum ada data pembagian berkat!");
            const rows = state.gifts.map(g => [`"${g.name}"`, `"${g.qrCode}"`, `"${g.timestamp}"`]);
            let csv = "\ufeffNama,Kode QR,Waktu Terima Berkat\n" + rows.map(e => e.join(",")).join("\n");
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url; link.download = "Berkat_Bonataon2026.csv"; link.click();
        };

        window.openManualInput = (type) => {
            const q = prompt("Masukkan Nama atau Kode QR:");
            if (!q) return;
            const matches = state.participants.filter(x => (x.name && x.name.toLowerCase().includes(q.toLowerCase())) || (x.qrCode && x.qrCode.toLowerCase().includes(q.toLowerCase())));
            if (!matches.length) return alert("Data tidak ditemukan!");
            
            const listToCheck = type === 'scan' ? state.attendance : state.gifts;
            if(listToCheck.find(i => i.qrCode === matches[0].qrCode)) {
                return alert(type === 'scan' ? "Sudah Hadir!" : "Berkat Sudah Diterima!");
            }

            push(ref(db, type === 'scan' ? 'attendance' : 'gifts'), { name: matches[0].name, qrCode: matches[0].qrCode, timestamp: new Date().toLocaleString() }).then(() => alert(type === 'scan' ? `Selamat Datang, ${matches[0].name}!` : `Input Sukses: ${matches[0].name}`));
        };

        function renderParticipantList() {
            const list = document.getElementById('participantList'); if(!list) return;
            list.innerHTML = `<h5 class="text-[10px] font-black text-slate-400 uppercase mb-4 tracking-widest pl-4">Pendaftar Terkini</h5>` + state.participants.slice(-3).reverse().map(p => `<div class="bg-white p-5 rounded-[1.5rem] flex justify-between items-center shadow-lg border border-slate-100 mb-3 animate-[modalUp_0.4s]"><div class="font-black text-sm text-slate-800 uppercase">${p.name}</div><div class="text-[9px] font-black bg-emerald-50 text-emerald-700 px-4 py-1.5 rounded-full uppercase border border-emerald-100">${p.status}</div></div>`).join('');
        }

        refreshUIVisibility();
        setTab('register');
    </script>
</body>
</html>
