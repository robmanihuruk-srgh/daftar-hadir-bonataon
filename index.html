<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon 2026 - Official</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
      
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #059669;
            --emerald-50: #ecfdf5;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }
          
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .serif-font { font-family: 'Playfair Display', serif; }
        .royal-font { font-family: 'Cinzel', serif; }
          
        /* Glassmorphism Card */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
          
        /* Header Gradient */
        .header-bg {
            background: linear-gradient(135deg, var(--emerald-900) 0%, var(--emerald-600) 100%);
            position: relative;
            overflow: hidden;
        }
        .header-bg::after {
            content: "";
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M0 0h20L0 20z'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }

        /* Interactive Elements */
        .nav-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-btn.active {
            background-color: var(--emerald-50);
            color: var(--emerald-900);
            border-color: var(--emerald-600);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .logo-frame {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        
        .chart-wrapper { position: relative; height: 250px; width: 100%; }
        
        .form-input {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2);
            outline: none;
        }

        .ornament { position: absolute; z-index: 0; opacity: 0.6; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); pointer-events: none; }
        
        /* Animasi Modal */
        @keyframes modalUp { from { opacity: 0; transform: translateY(40px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        /* --- NEW: VIP TICKET STYLES --- */
        .vip-ticket {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        .vip-border {
            position: absolute; inset: 6px;
            border: 2px solid transparent;
            background: linear-gradient(135deg, #1e293b, #0f172a) padding-box,
                        var(--gold-gradient) border-box;
            border-radius: 12px;
            pointer-events: none;
        }
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .ticket-perforation {
            position: relative;
            background: #ffffff;
            margin-top: 20px;
            border-radius: 12px;
        }
        .ticket-perforation::before, .ticket-perforation::after {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #0f172a; /* Match modal bg */
            border-radius: 50%;
        }
        .ticket-perforation::before { left: -12px; box-shadow: inset -2px 0 3px rgba(0,0,0,0.2); }
        .ticket-perforation::after { right: -12px; box-shadow: inset 2px 0 3px rgba(0,0,0,0.2); }
        .pattern-overlay {
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23b38728' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            position: absolute; inset: 0; pointer-events: none;
        }
    </style>
</head>
<body class="antialiased">

    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="ornament top-10 left-10 opacity-10"><i class="fas fa-leaf text-emerald-400 text-6xl transform -rotate-12"></i></div>
        <div class="ornament bottom-20 right-10 opacity-10"><i class="fas fa-church text-emerald-300 text-8xl"></i></div>
    </div>

    <div id="app" class="relative z-10 max-w-md mx-auto md:max-w-4xl min-h-screen md:my-8 md:rounded-[2rem] overflow-hidden flex flex-col glass-panel transition-all duration-500">
          
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center">
            <div class="logo-frame w-32 h-32 p-3 mb-6 animate-bounce">
                <img src="logo tugu manihuruk.png" alt="Logo Tugu" class="w-full h-full object-contain" 
                     onerror="this.parentElement.innerHTML='<div class=\'text-center leading-none text-xs font-bold text-emerald-800\'>BONATAON<br>2026</div>'">
            </div>
            <h2 class="text-2xl font-bold text-emerald-900 mb-2 serif-font tracking-wide">BONATAON 2026</h2>
            <div class="flex items-center gap-2 text-emerald-600 text-sm font-semibold">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat Sistem...
            </div>
        </div>

        <header class="header-bg p-6 pb-20 shadow-xl relative z-20">
            <div class="flex justify-between items-center relative z-10">
                <div class="flex items-center gap-4">
                    <div class="logo-frame w-14 h-14 p-1 border-2 border-white/20">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-white serif-font tracking-wide drop-shadow-md">BONATAON<br>2026</h1>
                    </div>
                </div>
                
                <div id="liveClock" class="text-right"></div>
            </div>
              
            <div class="flex gap-3 mt-6 overflow-x-auto pb-2 custom-scrollbar">
                <div class="flex-1 min-w-[100px] bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10 text-center">
                    <div class="text-2xl font-bold text-white" id="statRegistered">0</div>
                    <div class="text-[10px] font-bold text-emerald-200 uppercase tracking-wider mt-1">Jemaat</div>
                </div>
                <div class="flex-1 min-w-[100px] bg-emerald-500/30 backdrop-blur-sm rounded-xl p-3 border border-emerald-400/50 text-center">
                    <div class="text-2xl font-bold text-emerald-50" id="statPresent">0</div>
                    <div class="text-[10px] font-bold text-emerald-200 uppercase tracking-wider mt-1">Hadir</div>
                </div>
                <div class="flex-1 min-w-[100px] bg-amber-500/20 backdrop-blur-sm rounded-xl p-3 border border-amber-400/30 text-center">
                    <div class="text-2xl font-bold text-amber-200" id="statGifts">0</div>
                    <div class="text-[10px] font-bold text-amber-100 uppercase tracking-wider mt-1">Berkat</div>
                </div>
            </div>
        </header>

        <nav class="flex px-4 -mt-12 relative z-30 gap-2 overflow-x-auto pb-4 custom-scrollbar">
            <button onclick="setTab('register')" id="tab-register" class="nav-btn flex-1 min-w-[75px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-user-plus text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Registrasi</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-btn flex-1 min-w-[75px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-search-location text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Undangan</span>
            </button>
            <button onclick="setTab('scan')" id="tab-scan" class="nav-btn flex-1 min-w-[75px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-qrcode text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Scan</span>
            </button>
            <button onclick="setTab('gift')" id="tab-gift" class="nav-btn flex-1 min-w-[75px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-gift text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Berkat</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-btn flex-1 min-w-[75px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-chart-pie text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Data</span>
            </button>
            <button onclick="window.adminLogin()" id="tab-admin" class="nav-btn flex-1 min-w-[75px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-user-lock text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Admin</span>
            </button>
        </nav>

        <main class="flex-1 p-6 overflow-y-auto bg-slate-50 pb-24 relative">
            <div id="content-area"></div>
        </main>
          
        <footer class="py-4 px-6 border-t border-slate-200 text-center bg-white/90 backdrop-blur-sm absolute bottom-0 w-full z-20">
            <div class="flex justify-between items-center text-xs">
                <div class="font-bold text-slate-400">&copy; 2026 Bonataon 2026</div>
                <div class="font-bold text-emerald-700 flex items-center gap-1">
                    Sukacita Bersama <i class="fas fa-heart text-amber-500"></i>
                </div>
            </div>
        </footer>
    </div>

    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeModal('adminModal')"></div>
        <div class="card max-w-xs w-full mx-4 relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-700 text-xl"><i class="fas fa-lock"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Akses Panitia</h3>
            </div>
            <div class="space-y-4">
                <input type="password" id="adminPassword" placeholder="Masukkan PIN" class="form-input w-full rounded-xl p-3 text-center text-lg tracking-widest font-bold">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal('adminModal')" class="btn-secondary rounded-xl py-3 text-sm border border-slate-200 bg-slate-50">Batal</button>
                    <button onclick="window.verifyAdmin()" class="btn-primary rounded-xl py-3 text-sm shadow-lg shadow-emerald-200 bg-emerald-600 text-white font-bold">Masuk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="changePassModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeModal('changePassModal')"></div>
        <div class="card max-w-xs w-full mx-4 relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">Ganti Password Admin</h3>
            <div class="space-y-3">
                <input type="password" id="newAdminPass" placeholder="Password Baru" class="form-input w-full rounded-xl p-3 text-center text-lg">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal('changePassModal')" class="btn-secondary rounded-xl py-2 text-sm border border-slate-200">Batal</button>
                    <button onclick="saveNewPassword()" class="btn-primary rounded-xl py-2 text-sm bg-emerald-600 text-white">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <div id="authTicketModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('authTicketModal')"></div>
        <div class="card max-w-xs w-full mx-4 relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-3 text-amber-600 text-xl"><i class="fas fa-shield-alt"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Verifikasi Keamanan</h3>
                <p class="text-xs text-slate-500 mt-1">Masukkan Password/PIN yang Anda buat saat registrasi untuk membuka undangan.</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="ticketPassInput" placeholder="******" class="form-input w-full rounded-xl p-3 text-center text-2xl tracking-widest font-bold">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal('authTicketModal')" class="rounded-xl py-3 text-sm border border-slate-200 hover:bg-slate-50">Batal</button>
                    <button onclick="window.verifyTicketPass()" class="rounded-xl py-3 text-sm shadow-lg shadow-amber-200 bg-amber-500 text-white font-bold hover:bg-amber-600">Buka</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editParticipantModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('editParticipantModal')"></div>
        <div class="card max-w-xs w-full mx-4 relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <div class="text-center mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-blue-600 text-xl"><i class="fas fa-edit"></i></div>
                <h3 class="text-lg font-bold text-slate-800">Ubah Data Nama</h3>
                <p class="text-xs text-slate-500 mt-1">Masukkan password peserta untuk mengubah nama.</p>
            </div>
            <div class="space-y-4">
                <div id="editStep1">
                    <input type="password" id="editPassInput" placeholder="Password Peserta" class="form-input w-full rounded-xl p-3 text-center text-lg tracking-widest font-bold mb-3">
                    <button onclick="window.processEditAuth()" class="w-full rounded-xl py-3 bg-blue-600 text-white font-bold hover:bg-blue-700">Verifikasi</button>
                </div>
                <div id="editStep2" class="hidden">
                    <input type="text" id="editNameInput" placeholder="Nama Baru" class="form-input w-full rounded-xl p-3 text-center text-lg font-bold mb-3">
                    <button onclick="window.saveEditData()" class="w-full rounded-xl py-3 bg-emerald-600 text-white font-bold hover:bg-emerald-700">Simpan Perubahan</button>
                </div>
                <button onclick="closeModal('editParticipantModal')" class="w-full rounded-xl py-2 text-sm text-slate-400 hover:text-slate-600">Batal</button>
            </div>
        </div>
    </div>
    
    <div id="ticketModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-md" onclick="closeModal('ticketModal')"></div>
        <div class="relative w-full max-w-sm mx-6 animate-[modalUp_0.4s_ease-out]">
            <div class="vip-ticket rounded-3xl p-6 shadow-2xl shadow-amber-900/40">
                <div class="pattern-overlay opacity-20"></div>
                <div class="vip-border"></div>
                <div class="relative z-10 text-center">
                    <div class="flex justify-center mb-4">
                        <img src="logo tugu manihuruk.png" class="w-16 h-16 object-contain drop-shadow-[0_0_10px_rgba(255,255,255,0.3)]">
                    </div>
                    <h4 class="text-emerald-400 text-[10px] font-bold tracking-[0.3em] uppercase mb-1">Official Invitation</h4>
                    <h2 class="royal-font text-3xl font-bold gold-text mb-1">BONATAON</h2>
                    <h3 class="royal-font text-xl text-slate-300 tracking-widest mb-6">2026</h3>
                    <div class="mb-2">
                        <p class="text-slate-400 text-[10px] uppercase tracking-widest mb-1">Nama Tamu</p>
                        <h1 id="ticName" class="text-2xl font-serif text-white leading-tight font-bold">Nama Peserta</h1>
                    </div>
                    <div class="flex justify-center gap-3 mb-6 mt-3">
                        <div class="px-3 py-1 border border-emerald-500/50 bg-emerald-900/30 rounded-full text-emerald-400 text-[10px] font-bold uppercase tracking-wide" id="ticStatusDisp">STATUS</div>
                        <div class="px-3 py-1 border border-amber-500/50 bg-amber-900/30 rounded-full text-amber-400 text-[10px] font-bold uppercase tracking-wide" id="ticMargaDisp">MARGA</div>
                    </div>
                    <div class="ticket-perforation bg-white p-5 shadow-inner">
                        <img id="ticQR" src="" class="w-48 h-48 object-contain mix-blend-multiply mx-auto" alt="QR Code">
                        <div class="text-center mt-3">
                            <div class="text-[10px] text-slate-400 uppercase tracking-widest">Entry Code</div>
                            <div class="text-lg font-mono font-black text-slate-800 tracking-widest" id="ticCode">CODE</div>
                        </div>
                    </div>
                    <div class="mt-6">
                        <a id="btnDownloadTicket" href="#" download class="block w-full py-3 rounded-xl bg-gradient-to-r from-emerald-600 to-emerald-800 text-white font-bold text-sm shadow-lg hover:shadow-emerald-500/20 transition-all border border-emerald-500/50">
                            <i class="fas fa-download mr-2"></i> Simpan Tiket
                        </a>
                        <button onclick="closeModal('ticketModal')" class="mt-3 text-slate-500 text-xs hover:text-slate-300">Tutup</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="manualCheckinModal" class="fixed inset-0 z-[8000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('manualCheckinModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3 flex items-center gap-2"><i class="fas fa-check-double text-emerald-500"></i> Absensi Manual</h3>
            <div class="relative mb-4">
                <input type="text" id="manualSearch" placeholder="Cari nama jemaat..." class="form-input w-full rounded-xl pl-10 p-2">
                <i class="fas fa-search absolute left-4 top-3 text-slate-400"></i>
            </div>
            <div id="manualCheckinList" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('manualCheckinModal')" class="w-full rounded-xl py-2 bg-slate-100 border border-slate-200">Tutup</button>
                <button onclick="processManualCheckin()" class="w-full rounded-xl py-2 bg-emerald-600 text-white font-bold" disabled id="manualCheckinBtn">Konfirmasi</button>
            </div>
        </div>
    </div>

    <div id="manualGiftModal" class="fixed inset-0 z-[8000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeModal('manualGiftModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 p-6 bg-white rounded-2xl animate-[modalUp_0.3s_ease-out]">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3 flex items-center gap-2"><i class="fas fa-gift text-amber-500"></i> Serah Terima Berkat</h3>
            <div class="relative mb-4">
                <input type="text" id="manualGiftSearch" placeholder="Cari nama jemaat..." class="form-input w-full rounded-xl pl-10 p-2">
                <i class="fas fa-search absolute left-4 top-3 text-slate-400"></i>
            </div>
            <div id="manualGiftList" class="max-h-60 overflow-y-auto custom-scrollbar space-y-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100"></div>
            <div class="flex gap-3">
                <button onclick="closeModal('manualGiftModal')" class="w-full rounded-xl py-2 bg-slate-100 border border-slate-200">Tutup</button>
                <button onclick="processManualGift()" class="w-full rounded-xl py-2 bg-gradient-to-r from-amber-500 to-orange-600 text-white font-bold" disabled id="manualGiftBtn">Serahkan</button>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".csv" class="hidden" onchange="handleImport(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- STATE ---
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            tab: 'register',
            scanner: null,
            isAdmin: false,
            adminPass: "ADMIN123",
            selectedManualCheckin: null,
            selectedManualGift: null,
            tempAuthUser: null,
            tempEditId: null,
            tempEditParticipant: null
        };

        // --- PASSWORD SYNC LOGIC ---
        onValue(ref(db, 'config/adminPassword'), (s) => {
            if(s.exists()) {
                state.adminPass = s.val();
            } else {
                set(ref(db, 'config/adminPassword'), "ADMIN123");
                state.adminPass = "ADMIN123";
            }
        });

        let charts = {}; 
        let audioCtx = null;

        // --- CLOCK FUNCTION ---
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }).replace('.', ':');
            const dateString = now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'short', year: 'numeric' });
            
            const el = document.getElementById('liveClock');
            if(el) {
                el.innerHTML = `
                    <div class="flex flex-col items-end text-white/90">
                        <div class="text-[10px] md:text-xs font-medium opacity-80 uppercase tracking-widest">${dateString}</div>
                        <div class="text-lg md:text-2xl font-bold font-mono tracking-widest flex items-center gap-2 text-emerald-50">
                            ${timeString} <i class="fas fa-clock text-amber-400 text-sm md:text-lg animate-pulse"></i>
                        </div>
                    </div>
                `;
            }
        }
        setInterval(updateClock, 1000);
        updateClock();

        function beep(type = 'success') {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type === 'success' ? 'sine' : 'square';
            osc.frequency.setValueAtTime(type === 'success' ? 880 : 200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        const getQR = (txt) => `https://api.qrserver.com/v1/create-qr-code/?size=600x600&margin=20&ecc=H&color=000000&bgcolor=ffffff&format=png&data=${encodeURIComponent(txt)}`;
        const fmtDate = () => new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });

        // --- LISTENERS ---
        onValue(ref(db, 'participants'), s => { state.participants = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'gifts'), s => { state.gifts = s.val() ? Object.values(s.val()) : []; updateDashboard(); });

        function updateDashboard() {
            document.getElementById('statRegistered').innerText = state.participants.length;
            document.getElementById('statPresent').innerText = state.attendance.length;
            document.getElementById('statGifts').innerText = state.gifts.length;
            
            if (state.tab === 'data') {
                renderCharts();
                renderDataTable(); 
            }
            if (state.tab === 'register') renderParticipantList();
            
            if (state.tab === 'scan' || state.tab === 'gift') renderRecentScans();

            document.getElementById('loading').style.display = 'none';
        }

        // --- NAVIGATION ---
        window.setTab = (t) => {
            if ((state.tab === 'scan') && t !== 'scan') window.stopScanner();
            state.tab = t;
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.id === `tab-${t}`) btn.classList.add('active'); else btn.classList.remove('active');
            });

            const root = document.getElementById('content-area');
            
            if (t === 'register') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5 pointer-events-none"><i class="fas fa-pen-fancy text-6xl"></i></div>
                        <div class="flex items-center gap-3 mb-4 relative z-10"><div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600"><i class="fas fa-user-plus"></i></div><h3 class="font-bold text-slate-800">Registrasi Keluarga</h3></div>
                        <div class="space-y-4 relative z-10">
                            <div><label class="text-xs font-bold text-slate-400 uppercase">Nama Lengkap</label><input id="inName" type="text" class="form-input w-full rounded-xl mt-1 p-2" placeholder="Masukkan nama..."></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-400 uppercase">Status</label><select id="inStatus" class="form-input w-full rounded-xl mt-1 p-2"><option value="" disabled selected>Pilih...</option><option value="Orangtua">Orangtua</option><option value="Pemuda">Pemuda</option><option value="Sekolah Minggu">Sekolah Minggu</option><option value="Tamu Undangan">Tamu Undangan</option><option value="Pengurus Tupuan">Pengurus Tupuan</option></select></div>
                                <div><label class="text-xs font-bold text-slate-400 uppercase">Marga</label><select id="inMarga" class="form-input w-full rounded-xl mt-1 p-2"><option value="" disabled selected>Pilih...</option><option value="Marga Manihuruk">Manihuruk</option><option value="Boru">Boru</option><option value="Bere / Panagolan">Bere/Panagolan</option></select></div>
                            </div>
                            
                            <div class="bg-amber-50 p-3 rounded-xl border border-amber-100">
                                <label class="text-xs font-bold text-amber-600 uppercase"><i class="fas fa-lock mr-1"></i> Buat Password / PIN</label>
                                <input id="inPass" type="text" class="form-input w-full rounded-xl mt-1 p-2 border-amber-200 text-center font-bold tracking-widest" placeholder="Contoh: 1234 (Wajib diingat!)">
                                <p class="text-[10px] text-amber-600/70 mt-1 italic leading-tight">*Digunakan untuk membuka undangan nanti. Jangan sampai lupa.</p>
                            </div>

                            <button onclick="processRegister()" class="btn-primary w-full rounded-xl py-3 mt-2 shadow-lg shadow-emerald-200 bg-emerald-600 text-white font-bold hover:bg-emerald-700 transition-colors"><i class="fas fa-save mr-2"></i> Simpan Data</button>
                        </div>
                    </div>
                    <div id="participantList"></div>`;
                renderParticipantList();
            } 
            else if (t === 'find') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100 text-center relative">
                        <div class="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-500 text-2xl shadow-inner"><i class="fas fa-search"></i></div>
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Cari Undangan</h3>
                        <p class="text-slate-400 text-sm mb-6">Cari tiket berdasarkan nama dan marga.</p>
                        <div class="space-y-3 text-left">
                            <input id="findName" type="text" placeholder="Nama Lengkap..." class="form-input w-full rounded-xl text-center p-3">
                            <select id="findMarga" class="form-input w-full rounded-xl text-center p-3">
                                <option value="" disabled selected>Pilih Marga</option>
                                <option value="Marga Manihuruk">Manihuruk</option>
                                <option value="Boru">Boru</option>
                                <option value="Bere / Panagolan">Bere/Panagolan</option>
                            </select>
                            <button onclick="findTicket()" class="w-full rounded-xl py-3 shadow-lg shadow-emerald-200 bg-emerald-600 text-white font-bold hover:bg-emerald-700">Cari Tiket Saya</button>
                        </div>
                    </div>`;
            }
            else if (t === 'scan') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                        <h3 class="font-bold text-center text-slate-800 mb-4">Scan QR Code Kehadiran</h3>
                        <div id="scanMsg" class="hidden p-3 rounded-lg text-center font-bold mb-3 text-sm"></div>
                        <div class="rounded-xl overflow-hidden bg-black border-4 border-emerald-500 relative shadow-inner"><div id="reader"></div></div>
                        <div id="recentScans" class="mt-4 border-t border-slate-100 pt-3"></div>
                        ${state.isAdmin ? `<button onclick="openManualCheckin()" class="w-full mt-4 py-3 bg-slate-100 text-emerald-700 rounded-xl text-sm font-bold hover:bg-slate-200 transition-colors border border-slate-200 flex items-center justify-center gap-2"><i class="fas fa-keyboard"></i> Input Manual (Admin)</button>` : ''}
                    </div>`;
                setTimeout(initScanner, 300);
                renderRecentScans();
            }
            else if (t === 'gift') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                        <h3 class="font-bold text-center text-slate-800 mb-4">Scan Pengambilan Berkat</h3>
                        <div id="scanMsg" class="hidden p-3 rounded-lg text-center font-bold mb-3 text-sm"></div>
                        <div class="rounded-xl overflow-hidden bg-black border-4 border-amber-500 relative shadow-inner"><div id="reader"></div></div>
                        <div id="recentScans" class="mt-4 border-t border-slate-100 pt-3"></div>
                        ${state.isAdmin ? `<button onclick="openManualGift()" class="w-full mt-4 py-3 bg-slate-100 text-amber-700 rounded-xl text-sm font-bold hover:bg-slate-200 transition-colors border border-slate-200 flex items-center justify-center gap-2"><i class="fas fa-gift"></i> Input Manual (Admin)</button>` : ''}
                    </div>`;
                setTimeout(initScanner, 300);
                renderRecentScans();
            }
            else if (t === 'data') {
                root.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center gap-2"><i class="fas fa-chart-bar text-emerald-600"></i> Ringkasan Acara</h4><div class="chart-wrapper"><canvas id="chartOverview"></canvas></div></div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center gap-2"><i class="fas fa-users text-emerald-600"></i> Kehadiran per Marga</h4><div class="chart-wrapper"><canvas id="chartMarga"></canvas></div></div>
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100"><h4 class="font-bold text-slate-700 mb-4 border-b pb-2 flex items-center gap-2"><i class="fas fa-user-tag text-emerald-600"></i> Kehadiran per Status</h4><div class="chart-wrapper"><canvas id="chartStatus"></canvas></div></div>
                        
                        <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100">
                            <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                                <h4 class="font-bold text-slate-700">Laporan Realtime</h4>
                                <div class="flex gap-2 text-xs">
                                    <button onclick="toggleTable('attendance')" class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded-lg hover:bg-emerald-200" id="btnTblAttend">Hadir</button>
                                    <button onclick="toggleTable('gifts')" class="px-2 py-1 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200" id="btnTblGift">Berkat</button>
                                    <button onclick="toggleTable('registered')" class="px-2 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200" id="btnTblRegistered">Semua Keluarga</button>
                                </div>
                            </div>
                            <div id="dataTableContainer" class="max-h-60 overflow-y-auto custom-scrollbar border rounded-lg p-2 bg-slate-50"></div>
                            
                            <h4 class="font-bold text-slate-700 mt-6 mb-4 text-center border-t pt-4">Export Data (Excel/CSV)</h4>
                            <div class="flex gap-2 justify-center flex-wrap">
                                <button onclick="exportData('p')" class="px-4 py-2 bg-slate-600 text-white rounded-lg text-xs font-bold shadow hover:bg-slate-700">Master Data</button>
                                <button onclick="exportData('a')" class="px-4 py-2 bg-emerald-600 text-white rounded-lg text-xs font-bold shadow hover:bg-emerald-700">Laporan Hadir</button>
                                <button onclick="exportData('g')" class="px-4 py-2 bg-amber-600 text-white rounded-lg text-xs font-bold shadow hover:bg-amber-700">Laporan Hadiah</button>
                            </div>
                            
                            ${state.isAdmin ? `
                            <div class="mt-6 pt-4 border-t border-slate-100 text-center">
                                <button onclick="openChangePass()" class="text-xs text-emerald-600 font-bold hover:underline mb-3 block">Ganti Password Admin</button>
                                <button onclick="resetData()" class="text-xs text-red-400 hover:text-red-600 font-bold border border-red-100 hover:bg-red-50 px-4 py-2 rounded-full transition-colors"><i class="fas fa-trash-alt mr-1"></i> Reset Sistem (Bahaya)</button>
                            </div>` : ''}
                        </div>
                    </div>`;
                setTimeout(() => {
                    renderCharts();
                    toggleTable('registered'); // MODIFIKASI: Default show registered list
                }, 150); 
            }
        };

        // --- REGISTER LOGIC ---
        window.processRegister = () => {
            const name = document.getElementById('inName').value.trim();
            const status = document.getElementById('inStatus').value;
            const marga = document.getElementById('inMarga').value;
            const userPass = document.getElementById('inPass').value.trim(); 

            if(!name || !status || !marga || !userPass) { alert("Mohon lengkapi semua data termasuk Password!"); return; }
            
            const id = Date.now().toString(); 
            const qrCode = `MN-${id.slice(-6)}`;
            
            // Push ke Database
            const newRef = push(ref(db, 'participants')); // Use Firebase generated key for better consistency
            const key = newRef.key;

            set(newRef, { 
                id: key, // Store the key inside the object too
                name, status, marga, qrCode, 
                password: userPass, 
                registeredAt: fmtDate(), 
                timestamp: Date.now() 
            }).then(() => { 
                showTicket(name, status, marga, qrCode); 
                document.getElementById('inName').value = '';
                document.getElementById('inPass').value = ''; 
            });
        };

        function renderParticipantList() {
            const list = document.getElementById('participantList'); if(!list) return;
            const items = state.participants.slice().reverse().map(p => `<div class="bg-white p-3 rounded-xl border border-slate-100 mb-2 flex justify-between items-center shadow-sm"><div><div class="font-bold text-slate-700">${p.name}</div><div class="text-[10px] text-slate-400 uppercase font-bold">${p.marga} â€¢ ${p.status}</div></div><i class="fas fa-shield-alt text-emerald-200 text-xl"></i></div>`).join('');
            list.innerHTML = items || '<div class="text-center text-slate-400 text-sm py-8 italic">Belum ada keluarga yang terdaftar</div>';
        }

        // --- FIND TICKET LOGIC ---
        window.findTicket = () => {
            const name = document.getElementById('findName').value.trim().toLowerCase();
            const marga = document.getElementById('findMarga').value;
            const found = state.participants.find(p => p.name.toLowerCase().includes(name) && p.marga === marga);
            
            if(found) {
                state.tempAuthUser = found;
                document.getElementById('ticketPassInput').value = '';
                document.getElementById('authTicketModal').classList.remove('hidden');
            } else { 
                alert("Data tidak ditemukan.");
            }
        };

        window.verifyTicketPass = () => {
            const input = document.getElementById('ticketPassInput').value;
            if (state.tempAuthUser && input === state.tempAuthUser.password) {
                closeModal('authTicketModal');
                showTicket(state.tempAuthUser.name, state.tempAuthUser.status, state.tempAuthUser.marga, state.tempAuthUser.qrCode);
                state.tempAuthUser = null; // reset
            } else {
                alert("Password Salah!");
            }
        };

        window.showTicket = (name, status, marga, code) => {
            document.getElementById('ticName').innerText = name; 
            document.getElementById('ticStatusDisp').innerText = status; 
            document.getElementById('ticMargaDisp').innerText = marga; 
            document.getElementById('ticCode').innerText = code; 
            document.getElementById('ticQR').src = getQR(code); 
            document.getElementById('ticketModal').classList.remove('hidden');
        };

        // --- EDIT PARTICIPANT LOGIC (NEW) ---
        window.initEdit = (id) => {
            const p = state.participants.find(x => x.id === id);
            if(p) {
                state.tempEditId = id;
                state.tempEditParticipant = p;
                document.getElementById('editPassInput').value = '';
                document.getElementById('editNameInput').value = p.name;
                
                // Show Step 1, Hide Step 2
                document.getElementById('editStep1').classList.remove('hidden');
                document.getElementById('editStep2').classList.add('hidden');
                
                document.getElementById('editParticipantModal').classList.remove('hidden');
            }
        };

        window.processEditAuth = () => {
            const input = document.getElementById('editPassInput').value;
            if(state.tempEditParticipant && input === state.tempEditParticipant.password) {
                // Password Correct, Show Name Input
                document.getElementById('editStep1').classList.add('hidden');
                document.getElementById('editStep2').classList.remove('hidden');
            } else {
                alert("Password Salah!");
            }
        };

        window.saveEditData = () => {
            const newName = document.getElementById('editNameInput').value.trim();
            if(newName && state.tempEditId) {
                update(ref(db, 'participants/' + state.tempEditId), {
                    name: newName
                }).then(() => {
                    alert("Nama Berhasil Diubah!");
                    closeModal('editParticipantModal');
                    state.tempEditId = null;
                    state.tempEditParticipant = null;
                });
            } else {
                alert("Nama tidak boleh kosong.");
            }
        };

        // --- DELETE PARTICIPANT LOGIC (ADMIN ONLY) ---
        window.deleteParticipant = (id, name) => {
            if(confirm(`Yakin ingin menghapus data: ${name}? Data tidak bisa dikembalikan.`)) {
                remove(ref(db, 'participants/' + id)).then(() => {
                    alert("Data berhasil dihapus.");
                });
            }
        };

        // --- SCANNER LOGIC ---
        window.initScanner = () => {
            if(state.scanner) return;
            const config = { fps: 10, qrbox: 250, aspectRatio: 1.0 };
            state.scanner = new Html5QrcodeScanner("reader", config, false);
            state.scanner.render((decodedText) => {
                if(state.scanner) state.scanner.pause();
                const p = state.participants.find(x => x.qrCode === decodedText);
                const msgEl = document.getElementById('scanMsg');
                if(p) {
                    if (state.tab === 'gift') {
                        if(state.gifts.find(g => g.participantId === p.id)) { beep('fail'); msgEl.innerText = `Sudah Ambil: ${p.name}`; msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-amber-100 text-amber-700"; }
                        else { push(ref(db, 'gifts'), { id: Date.now().toString(), participantId: p.id, name: p.name, status: p.status, marga: p.marga, timestamp: fmtDate() }); beep('success'); msgEl.innerText = `Berkat Diserahkan: ${p.name}`; msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-emerald-100 text-emerald-700"; }
                    } else {
                        if(state.attendance.find(a => a.participantId === p.id)) { beep('fail'); msgEl.innerText = `Sudah Hadir: ${p.name}`; msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-amber-100 text-amber-700"; }
                        else { push(ref(db, 'attendance'), { id: Date.now().toString(), participantId: p.id, name: p.name, status: p.status, marga: p.marga, timestamp: fmtDate() }); beep('success'); msgEl.innerText = `Horas! Selamat Datang: ${p.name}`; msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-emerald-100 text-emerald-700"; }
                    }
                } else { beep('fail'); msgEl.innerText = "QR Code Tidak Dikenali"; msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-red-100 text-red-700"; }
                msgEl.classList.remove('hidden'); setTimeout(() => { if(state.scanner) state.scanner.resume(); msgEl.classList.add('hidden'); }, 2500);
            });
        };
        window.stopScanner = () => { if(state.scanner) { state.scanner.clear().then(() => state.scanner = null); }};

        // --- RECENT SCANS WIDGET ---
        function renderRecentScans() {
            const container = document.getElementById('recentScans');
            if (!container) return;
            
            const data = state.tab === 'gift' ? state.gifts : state.attendance;
            const recent = data.slice(-5).reverse(); 
            
            if (recent.length === 0) {
                container.innerHTML = `<p class="text-center text-xs text-slate-400 italic">Belum ada riwayat</p>`;
                return;
            }
            
            container.innerHTML = `<p class="text-xs font-bold text-slate-500 mb-2">Riwayat Terakhir:</p>` + 
                recent.map(r => `
                    <div class="flex justify-between items-center py-1 border-b border-slate-50 last:border-0">
                        <span class="text-xs font-bold text-slate-700">${r.name}</span>
                        <span class="text-[10px] text-slate-400">${r.timestamp.split(' ')[1] || ''}</span>
                    </div>
                `).join('');
        }

        // --- LIVE DATA TABLE ---
        let currentTableMode = 'registered'; // DEFAULT MODE IS REGISTERED
        
        window.toggleTable = (mode) => {
            currentTableMode = mode;
            renderDataTable();
        };

        function renderDataTable() {
            const container = document.getElementById('dataTableContainer');
            if(!container) return;
            
            const btnAttend = document.getElementById('btnTblAttend');
            const btnGift = document.getElementById('btnTblGift');
            const btnRegistered = document.getElementById('btnTblRegistered'); 
            
            // Reset styles
            [btnAttend, btnGift, btnRegistered].forEach(b => {
                if(b) b.classList.remove('ring-2', 'ring-emerald-300', 'ring-amber-300', 'ring-blue-300');
            });

            let data = [];
            
            if(currentTableMode === 'gifts') {
                data = state.gifts;
                if(btnGift) btnGift.classList.add('ring-2', 'ring-amber-300');
            } else if (currentTableMode === 'registered') {
                data = state.participants;
                if(btnRegistered) btnRegistered.classList.add('ring-2', 'ring-blue-300');
            } else {
                data = state.attendance;
                if(btnAttend) btnAttend.classList.add('ring-2', 'ring-emerald-300');
            }

            if(data.length === 0) {
                container.innerHTML = `<div class="text-center py-8 text-slate-400 italic text-sm">Belum ada data</div>`;
                return;
            }

            // Sorting: Registered by Name A-Z, others by Time Desc
            const displayData = currentTableMode === 'registered' 
                ? data.slice().sort((a,b) => a.name.localeCompare(b.name)) 
                : data.slice().reverse();

            container.innerHTML = `
                <table class="w-full text-xs text-left">
                    <thead class="text-slate-500 font-bold border-b">
                        <tr>
                            <th class="py-2">Nama</th>
                            <th class="py-2">Info</th>
                            <th class="py-2 text-right">
                                ${currentTableMode === 'registered' ? 'Aksi' : 'Waktu'}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        ${displayData.map(d => {
                            // Logic for Actions Column
                            let actionCol = '';
                            if(currentTableMode === 'registered') {
                                // Edit button for everyone
                                let btns = `<button onclick="initEdit('${d.id}')" class="text-blue-500 hover:text-blue-700 mx-1 p-1"><i class="fas fa-edit"></i></button>`;
                                // Delete button ONLY for Admin
                                if(state.isAdmin) {
                                    btns += `<button onclick="deleteParticipant('${d.id}', '${d.name}')" class="text-red-500 hover:text-red-700 mx-1 p-1"><i class="fas fa-trash"></i></button>`;
                                }
                                actionCol = `<div class="flex justify-end">${btns}</div>`;
                            } else {
                                // Time for other tabs
                                actionCol = `<span class="font-mono text-slate-400">${d.timestamp ? d.timestamp.split(' ')[1] : '-'}</span>`;
                            }

                            return `
                            <tr class="border-b border-slate-100 last:border-0 hover:bg-white transition-colors">
                                <td class="py-2 font-bold text-slate-700">${d.name}</td>
                                <td class="py-2 text-slate-500">${d.marga}<br>${d.status}</td>
                                <td class="py-2 text-right">${actionCol}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        // --- MANUAL HANDLERS ---
        window.openManualCheckin = () => { document.getElementById('manualCheckinModal').classList.remove('hidden'); renderManualList('checkin'); };
        window.openManualGift = () => { document.getElementById('manualGiftModal').classList.remove('hidden'); renderManualList('gift'); };
        
        function renderManualList(type) {
            const listEl = document.getElementById(type === 'checkin' ? 'manualCheckinList' : 'manualGiftList');
            const searchEl = document.getElementById(type === 'checkin' ? 'manualSearch' : 'manualGiftSearch');
            const term = searchEl.value.toLowerCase();
            
            const filtered = state.participants.filter(p => {
                const isDone = type === 'checkin' ? state.attendance.find(a => a.participantId === p.id) : state.gifts.find(g => g.participantId === p.id);
                return !isDone && p.name.toLowerCase().includes(term);
            });

            listEl.innerHTML = filtered.length === 0 ? `<div class="text-center py-4 text-slate-400 text-sm">Data tidak ditemukan / sudah selesai</div>` : 
                filtered.map(p => `
                    <div class="p-3 border-b border-slate-100 hover:bg-emerald-50 cursor-pointer flex justify-between items-center transition-colors" onclick="selectManual('${type}', ${JSON.stringify(p).replace(/"/g, '&quot;')})">
                        <div><div class="font-bold text-slate-700">${p.name}</div><div class="text-xs text-slate-400">${p.marga}</div></div>
                        <i class="fas fa-chevron-right text-slate-300"></i>
                    </div>
                `).join('');
                
            searchEl.oninput = () => renderManualList(type);
        }

        window.selectManual = (type, p) => {
            if(type === 'checkin') { state.selectedManualCheckin = p; document.getElementById('manualCheckinBtn').disabled = false; document.getElementById('manualCheckinBtn').innerText = `Konfirmasi: ${p.name}`; }
            else { state.selectedManualGift = p; document.getElementById('manualGiftBtn').disabled = false; document.getElementById('manualGiftBtn').innerText = `Serahkan: ${p.name}`; }
        };

        window.processManualCheckin = () => { if(state.selectedManualCheckin) { window.doCheckInManual(state.selectedManualCheckin); closeModal('manualCheckinModal'); } };
        window.processManualGift = () => { if(state.selectedManualGift) { window.doGiftManual(state.selectedManualGift); closeModal('manualGiftModal'); } };

        window.doCheckInManual = (p) => { push(ref(db, 'attendance'), { id: Date.now().toString(), participantId: p.id, name: p.name, status: p.status, marga: p.marga, timestamp: fmtDate() }).then(() => alert(`Berhasil Check-in: ${p.name}`)); };
        window.doGiftManual = (p) => { push(ref(db, 'gifts'), { id: Date.now().toString(), participantId: p.id, name: p.name, status: p.status, marga: p.marga, timestamp: fmtDate() }).then(() => alert(`Berkat diserahkan ke: ${p.name}`)); };

        // --- CHARTS ---
        window.renderCharts = () => {
            const ctxOverview = document.getElementById('chartOverview');
            const ctxMarga = document.getElementById('chartMarga');
            const ctxStatus = document.getElementById('chartStatus');
            if (!ctxOverview || !ctxMarga || !ctxStatus) return;

            ['overview', 'marga', 'status'].forEach(k => { if (charts[k]) charts[k].destroy(); });

            const margaCount = { 'Marga Manihuruk': 0, 'Boru': 0, 'Bere / Panagolan': 0 };
            const statusCount = { 'Orangtua': 0, 'Pemuda': 0, 'Sekolah Minggu': 0, 'Tamu Undangan': 0, 'Pengurus Tupuan': 0 };

            state.attendance.forEach(att => {
                if (margaCount[att.marga] !== undefined) margaCount[att.marga]++;
                if (statusCount[att.status] !== undefined) statusCount[att.status]++;
            });

            charts['overview'] = new Chart(ctxOverview, { type: 'bar', data: { labels: ['Terdaftar', 'Hadir', 'Kado'], datasets: [{ label: 'Jiwa', data: [state.participants.length, state.attendance.length, state.gifts.length], backgroundColor: ['#94a3b8', '#059669', '#f59e0b'], borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
            charts['marga'] = new Chart(ctxMarga, { type: 'pie', data: { labels: Object.keys(margaCount), datasets: [{ data: Object.values(margaCount), backgroundColor: ['#064e3b', '#10b981', '#f59e0b'], borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });
            charts['status'] = new Chart(ctxStatus, { type: 'bar', data: { labels: Object.keys(statusCount), datasets: [{ label: 'Hadir', data: Object.values(statusCount), backgroundColor: '#059669', borderRadius: 6 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } } });
        };

        // --- GLOBAL & ADMIN ---
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.adminLogin = () => {
            if (state.isAdmin) {
                if(confirm("Apakah Anda ingin keluar dari Mode Admin?")) {
                    state.isAdmin = false;
                    alert("Anda telah keluar dari mode Admin.");
                    updateDashboard(); 
                }
            } else {
                document.getElementById('adminPassword').value = ""; 
                document.getElementById('adminModal').classList.remove('hidden');
            }
        };
        
        window.verifyAdmin = () => {
            if(document.getElementById('adminPassword').value === state.adminPass) {
                state.isAdmin = true; 
                alert("Login Admin Berhasil"); 
                document.getElementById('adminPassword').value = "";
                closeModal('adminModal'); 
                updateDashboard();
            } else { alert("PIN Salah"); }
        };

        window.openChangePass = () => document.getElementById('changePassModal').classList.remove('hidden');
        window.saveNewPassword = () => {
            const newPass = document.getElementById('newAdminPass').value;
            if(newPass && newPass.length >= 4) {
                set(ref(db, 'config/adminPassword'), newPass);
                alert("Password Admin Berhasil Diubah!");
                closeModal('changePassModal');
            } else {
                alert("Password minimal 4 karakter");
            }
        };

        // EXPORT DATA
        window.exportData = (type) => {
            let data = [];
            let filename = '';

            if (type === 'p') { data = state.participants; filename = 'Master_Jemaat'; }
            else if (type === 'a') { data = state.attendance; filename = 'Laporan_Kehadiran'; }
            else if (type === 'g') { data = state.gifts; filename = 'Laporan_Hadiah'; }
            
            let csv = "Nama,Status,Marga,Waktu\n" + data.map(r => `"${r.name}","${r.status}","${r.marga}","${r.timestamp || r.registeredAt}"`).join("\n");
            const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob(["\uFEFF"+csv], { type: 'text/csv;charset=utf-8;' })); link.download = `Bonataon_${filename}.csv`; link.click();
        };
        
        window.resetData = () => { if(prompt("Ketik password admin untuk menghapus database:") === state.adminPass) { set(ref(db, 'participants'), null); set(ref(db, 'attendance'), null); set(ref(db, 'gifts'), null); alert("Sistem berhasil direset total."); } };

        setTimeout(() => { setTab('register'); }, 1500);
    </script>
</body>
</html>
