<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon 2026 - Tugu Raja Manihuruk</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
     
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #059669;
            --emerald-50: #ecfdf5;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
        }
         
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .serif-font { font-family: 'Playfair Display', serif; }
         
        /* Glassmorphism Card */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
         
        /* Header Gradient with Texture */
        .header-bg {
            background: linear-gradient(135deg, var(--emerald-900) 0%, var(--emerald-600) 100%);
            position: relative;
        }
        .header-bg::after {
            content: "";
            position: absolute; inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M0 0h20L0 20z'/%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.3;
        }

        /* Interactive Elements */
        .nav-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .nav-btn.active {
            background-color: var(--emerald-50);
            color: var(--emerald-900);
            border-color: var(--emerald-600);
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        /* Utilities */
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }
        .logo-frame {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* Chart Container Fix */
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        /* Input Styles */
        .form-input {
            background-color: #f8fafc;
            border: 1px solid #cbd5e1;
            transition: all 0.3s;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.2);
            outline: none;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="relative z-10 max-w-md mx-auto md:max-w-4xl min-h-screen md:my-8 md:rounded-[2rem] overflow-hidden flex flex-col glass-panel transition-all duration-500">
         
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center">
            <div class="logo-frame w-28 h-28 p-2 mb-6 animate-bounce">
                <img src="logo tugu manihuruk.png" alt="Logo Tugu" class="w-full h-full object-contain" 
                     onerror="this.parentElement.innerHTML='<i class=\'fas fa-mountain text-4xl text-emerald-800\'></i>'">
            </div>
            <h2 class="text-2xl font-bold text-emerald-900 mb-2 serif-font tracking-wide">BONATAON 2026</h2>
            <div class="flex items-center gap-2 text-emerald-600 text-sm font-semibold">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat Data...
            </div>
        </div>

        <header class="header-bg p-6 pb-20 shadow-xl relative z-20">
            <div class="flex justify-between items-start relative z-10">
                <div class="flex items-center gap-4">
                    <div class="logo-frame w-16 h-16 p-1 border-2 border-white/20">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-white serif-font tracking-wide drop-shadow-md">TUGU RAJA<br>MANIHURUK</h1>
                        <p class="text-emerald-100 text-xs font-medium uppercase tracking-widest mt-1 opacity-90">
                            <i class="fas fa-calendar-check mr-1 text-amber-400"></i> Bonataon 2026
                        </p>
                    </div>
                </div>
            </div>
             
            <div class="flex gap-3 mt-8 overflow-x-auto pb-2 custom-scrollbar">
                <div class="flex-1 min-w-[100px] bg-white/10 backdrop-blur-sm rounded-xl p-3 border border-white/10 text-center">
                    <div class="text-2xl font-bold text-white" id="statRegistered">0</div>
                    <div class="text-[10px] font-bold text-emerald-200 uppercase tracking-wider mt-1">Jemaat</div>
                </div>
                <div class="flex-1 min-w-[100px] bg-emerald-500/30 backdrop-blur-sm rounded-xl p-3 border border-emerald-400/50 text-center">
                    <div class="text-2xl font-bold text-emerald-50" id="statPresent">0</div>
                    <div class="text-[10px] font-bold text-emerald-200 uppercase tracking-wider mt-1">Hadir</div>
                </div>
                <div class="flex-1 min-w-[100px] bg-amber-500/20 backdrop-blur-sm rounded-xl p-3 border border-amber-400/30 text-center">
                    <div class="text-2xl font-bold text-amber-200" id="statGifts">0</div>
                    <div class="text-[10px] font-bold text-amber-100 uppercase tracking-wider mt-1">Kado</div>
                </div>
            </div>
        </header>

        <nav class="flex px-4 -mt-12 relative z-30 gap-2 overflow-x-auto pb-4 custom-scrollbar">
            <button onclick="setTab('register')" id="tab-register" class="nav-btn flex-1 min-w-[70px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-user-plus text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Daftar</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-btn flex-1 min-w-[70px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-search text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Cari</span>
            </button>
            <button onclick="setTab('scan')" id="tab-scan" class="nav-btn flex-1 min-w-[70px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-qrcode text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Scan</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-btn flex-1 min-w-[70px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-chart-pie text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Grafik</span>
            </button>
            <button onclick="window.adminLogin()" id="tab-admin" class="nav-btn flex-1 min-w-[70px] bg-white rounded-xl p-3 flex flex-col items-center gap-1 shadow-md border border-slate-100">
                <i class="fas fa-user-shield text-lg text-slate-400"></i>
                <span class="text-[10px] font-bold uppercase">Admin</span>
            </button>
        </nav>

        <main class="flex-1 p-6 overflow-y-auto bg-slate-50 pb-24 relative">
            <div id="content-area"></div>
        </main>
         
        <footer class="py-4 px-6 border-t border-slate-200 text-center bg-white/90 backdrop-blur-sm absolute bottom-0 w-full z-20">
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Powered by</div>
            <div class="text-xs font-bold text-emerald-800">Panitia Bonataon Manihuruk 2026</div>
        </footer>
    </div>

    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" onclick="closeModal('adminModal')"></div>
        <div class="card max-w-xs w-full mx-4 relative z-10 p-6 animate-[modalUp_0.3s_ease-out]">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3 text-emerald-700 text-xl">
                    <i class="fas fa-lock"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800">Akses Panitia</h3>
            </div>
            <div class="space-y-4">
                <input type="password" id="adminPassword" placeholder="Masukkan PIN" class="form-input w-full rounded-xl p-3 text-center text-lg tracking-widest font-bold">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="closeModal('adminModal')" class="btn-secondary rounded-xl py-3 text-sm">Batal</button>
                    <button onclick="window.verifyAdmin()" class="btn-primary rounded-xl py-3 text-sm shadow-lg shadow-emerald-200">Masuk</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ticketModal" class="fixed inset-0 z-[9999] flex items-center justify-center hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="closeModal('ticketModal')"></div>
        <div class="card max-w-sm w-full mx-4 relative z-10 p-0 overflow-hidden shadow-2xl animate-[modalUp_0.4s_ease-out]">
            <div class="bg-gradient-to-r from-emerald-700 to-emerald-500 p-6 text-center text-white relative">
                <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                <img src="logo tugu manihuruk.png" class="w-12 h-12 mx-auto mb-2 object-contain bg-white/20 rounded-lg p-1 backdrop-blur-sm">
                <h3 class="text-xl font-bold serif-font relative z-10">Undangan Resmi</h3>
                <p class="text-emerald-100 text-xs relative z-10 uppercase tracking-widest">Bonataon 2026</p>
                <button onclick="closeModal('ticketModal')" class="absolute top-4 right-4 text-white/70 hover:text-white"><i class="fas fa-times-circle text-xl"></i></button>
            </div>
            <div class="p-6 text-center bg-white relative">
                <div class="absolute -top-3 left-0 w-full h-4 bg-white" style="mask-image: radial-gradient(circle, transparent 6px, black 7px); mask-size: 20px 20px; mask-repeat: repeat-x; mask-position: bottom;"></div>
                
                <h2 id="ticName" class="text-2xl font-black text-slate-800 leading-tight mb-3 mt-4">Nama Peserta</h2>
                
                <div class="flex justify-center gap-2 mb-6">
                    <span class="px-3 py-1 bg-emerald-50 text-emerald-700 text-[10px] font-bold uppercase rounded-full border border-emerald-100 tracking-wide" id="ticStatusDisp">STATUS</span>
                    <span class="px-3 py-1 bg-amber-50 text-amber-700 text-[10px] font-bold uppercase rounded-full border border-amber-100 tracking-wide" id="ticMargaDisp">MARGA</span>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border-2 border-dashed border-slate-200 inline-block mb-4">
                    <img id="ticQR" src="" class="w-40 h-40 object-contain mix-blend-multiply mx-auto" alt="QR Code">
                    <div class="text-xs font-mono text-slate-400 mt-2 font-bold tracking-widest" id="ticCode">CODE</div>
                </div>

                <div class="space-y-2">
                    <a id="btnDownloadTicket" href="#" download class="btn-primary w-full flex items-center justify-center gap-2 rounded-xl py-3 text-sm">
                        <i class="fas fa-download"></i> Simpan Gambar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" accept=".csv" class="hidden" onchange="handleImport(this)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const ADMIN_PASS = "ADMIN123";

        // --- STATE ---
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            tab: 'register',
            scanner: null,
            isAdmin: false
        };

        // --- AUDIO ---
        let audioCtx = null;
        function beep(type = 'success') {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type === 'success' ? 'sine' : 'square';
            osc.frequency.setValueAtTime(type === 'success' ? 880 : 200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.15);
        }

        // --- HELPERS ---
        const getQR = (txt) => `https://api.qrserver.com/v1/create-qr-code/?size=600x600&margin=20&ecc=H&color=064e3b&bgcolor=ffffff&format=png&data=${encodeURIComponent(txt)}`;
        const fmtDate = () => new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' });

        // --- FIREBASE LISTENERS ---
        onValue(ref(db, 'participants'), s => {
            state.participants = s.val() ? Object.values(s.val()) : [];
            updateDashboard();
        });
        onValue(ref(db, 'attendance'), s => {
            state.attendance = s.val() ? Object.values(s.val()) : [];
            updateDashboard();
        });
        onValue(ref(db, 'gifts'), s => {
            state.gifts = s.val() ? Object.values(s.val()) : [];
            updateDashboard();
        });

        function updateDashboard() {
            // Update Top Stats
            document.getElementById('statRegistered').innerText = state.participants.length;
            document.getElementById('statPresent').innerText = state.attendance.length;
            document.getElementById('statGifts').innerText = state.gifts.length;
            
            // If on data tab, refresh charts
            if (state.tab === 'data') renderCharts();
            // If on register tab, refresh list
            if (state.tab === 'register') renderParticipantList();
            
            document.getElementById('loading').style.display = 'none';
        }

        // --- NAVIGATION & RENDERING ---
        window.setTab = (t) => {
            if ((state.tab === 'scan') && t !== 'scan') window.stopScanner();
            
            state.tab = t;
            
            // Update Active Button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.id === `tab-${t}`) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const root = document.getElementById('content-area');
            
            // Render Content based on Tab
            if (t === 'register') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-100 mb-6">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600"><i class="fas fa-user-plus"></i></div>
                            <h3 class="font-bold text-slate-800">Registrasi Keluarga</h3>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-slate-400 uppercase">Nama Lengkap</label>
                                <input id="inName" type="text" class="form-input w-full rounded-xl mt-1" placeholder="Masukkan nama...">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase">Status</label>
                                    <select id="inStatus" class="form-input w-full rounded-xl mt-1">
                                        <option value="" disabled selected>Pilih...</option>
                                        <option value="Orangtua">Orangtua</option>
                                        <option value="Pemuda">Pemuda</option>
                                        <option value="Sekolah Minggu">Sekolah Minggu</option>
                                        <option value="Tamu Undangan">Tamu Undangan</option>
                                        <option value="Pengurus Tupuan">Pengurus Tupuan</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-400 uppercase">Marga</label>
                                    <select id="inMarga" class="form-input w-full rounded-xl mt-1">
                                        <option value="" disabled selected>Pilih...</option>
                                        <option value="Marga Manihuruk">Manihuruk</option>
                                        <option value="Boru">Boru</option>
                                        <option value="Bere / Panagolan">Bere/Panagolan</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="processRegister()" class="btn-primary w-full rounded-xl py-3 mt-2 shadow-lg shadow-emerald-200">
                                <i class="fas fa-save mr-2"></i> Simpan Data
                            </button>
                        </div>
                    </div>
                    <div id="participantList"></div>
                `;
                renderParticipantList();
            } 
            else if (t === 'find') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-100 text-center">
                        <div class="w-16 h-16 bg-amber-50 rounded-full flex items-center justify-center mx-auto mb-4 text-amber-500 text-2xl"><i class="fas fa-search"></i></div>
                        <h3 class="font-bold text-lg text-slate-800 mb-2">Cari Undangan</h3>
                        <p class="text-slate-400 text-sm mb-6">Cari tiket berdasarkan nama dan marga.</p>
                        <div class="space-y-3 text-left">
                            <input id="findName" type="text" placeholder="Nama Lengkap..." class="form-input w-full rounded-xl text-center">
                            <select id="findMarga" class="form-input w-full rounded-xl text-center">
                                <option value="" disabled selected>Pilih Marga</option>
                                <option value="Marga Manihuruk">Manihuruk</option>
                                <option value="Boru">Boru</option>
                                <option value="Bere / Panagolan">Bere/Panagolan</option>
                            </select>
                            <button onclick="findTicket()" class="btn-primary w-full rounded-xl py-3 shadow-lg shadow-emerald-200">Cari Tiket</button>
                        </div>
                    </div>
                `;
            }
            else if (t === 'scan') {
                root.innerHTML = `
                    <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                        <h3 class="font-bold text-center text-slate-800 mb-4">Scan QR Code Kehadiran</h3>
                        <div id="scanMsg" class="hidden p-3 rounded-lg text-center font-bold mb-3 text-sm"></div>
                        <div class="rounded-xl overflow-hidden bg-black border-4 border-emerald-500 relative">
                            <div id="reader"></div>
                        </div>
                    </div>
                `;
                setTimeout(initScanner, 300);
            }
            else if (t === 'data') {
                // RENDER CONTAINER GRAFIK
                root.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                            <h4 class="font-bold text-slate-700 mb-4 border-b pb-2">Ringkasan Acara</h4>
                            <div class="chart-wrapper">
                                <canvas id="chartOverview"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                            <h4 class="font-bold text-slate-700 mb-4 border-b pb-2">Kehadiran Berdasarkan Marga</h4>
                            <div class="chart-wrapper">
                                <canvas id="chartMarga"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100">
                            <h4 class="font-bold text-slate-700 mb-4 border-b pb-2">Kehadiran Berdasarkan Status</h4>
                            <div class="chart-wrapper">
                                <canvas id="chartStatus"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                // PENTING: Render grafik setelah HTML disuntikkan ke DOM
                setTimeout(renderCharts, 100); 
            }
        };

        // --- REGISTER LOGIC ---
        window.processRegister = () => {
            const name = document.getElementById('inName').value.trim();
            const status = document.getElementById('inStatus').value;
            const marga = document.getElementById('inMarga').value;

            if(!name || !status || !marga) {
                alert("Mohon lengkapi semua data!");
                return;
            }

            const id = Date.now().toString();
            const qrCode = `BONA-${id.slice(-6)}`;

            push(ref(db, 'participants'), {
                id, name, status, marga, qrCode,
                registeredAt: fmtDate(), timestamp: Date.now()
            }).then(() => {
                showTicket(name, status, marga, qrCode);
                document.getElementById('inName').value = '';
            });
        };

        function renderParticipantList() {
            const list = document.getElementById('participantList');
            if(!list) return;
            
            const items = state.participants.slice().reverse().map(p => `
                <div class="bg-white p-3 rounded-xl border border-slate-100 mb-2 flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-bold text-slate-700">${p.name}</div>
                        <div class="text-[10px] text-slate-400 uppercase font-bold">${p.marga} â€¢ ${p.status}</div>
                    </div>
                    <i class="fas fa-qrcode text-emerald-200 text-xl"></i>
                </div>
            `).join('');
            
            list.innerHTML = items || '<div class="text-center text-slate-400 text-sm py-4">Belum ada data</div>';
        }

        // --- TICKET LOGIC ---
        window.findTicket = () => {
            const name = document.getElementById('findName').value.trim().toLowerCase();
            const marga = document.getElementById('findMarga').value;
            
            const found = state.participants.find(p => p.name.toLowerCase().includes(name) && p.marga === marga);
            
            if(found) showTicket(found.name, found.status, found.marga, found.qrCode);
            else alert("Data tidak ditemukan.");
        };

        window.showTicket = (name, status, marga, code) => {
            document.getElementById('ticName').innerText = name;
            document.getElementById('ticStatusDisp').innerText = status;
            document.getElementById('ticMargaDisp').innerText = marga;
            document.getElementById('ticCode').innerText = code;
            document.getElementById('ticQR').src = getQR(code);
            
            const modal = document.getElementById('ticketModal');
            modal.classList.remove('hidden');
        };

        // --- SCANNER LOGIC ---
        window.initScanner = () => {
            if(state.scanner) return;
            const config = { fps: 10, qrbox: 250, aspectRatio: 1.0 };
            state.scanner = new Html5QrcodeScanner("reader", config, false);
            
            state.scanner.render((decodedText) => {
                if(state.scanner) state.scanner.pause();
                
                const p = state.participants.find(x => x.qrCode === decodedText);
                const msgEl = document.getElementById('scanMsg');
                
                if(p) {
                    // Check Duplicate
                    const exists = state.attendance.find(a => a.participantId === p.id);
                    if(exists) {
                        beep('fail');
                        msgEl.innerText = `Sudah Hadir: ${p.name}`;
                        msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-amber-100 text-amber-700";
                    } else {
                        // Record Attendance
                        push(ref(db, 'attendance'), {
                            id: Date.now().toString(),
                            participantId: p.id,
                            name: p.name,
                            status: p.status, // Penting untuk grafik
                            marga: p.marga,   // Penting untuk grafik
                            timestamp: fmtDate()
                        });
                        beep('success');
                        msgEl.innerText = `Selamat Datang: ${p.name}`;
                        msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-emerald-100 text-emerald-700";
                    }
                } else {
                    beep('fail');
                    msgEl.innerText = "QR Code Tidak Dikenali";
                    msgEl.className = "block p-3 rounded-lg text-center font-bold mb-3 text-sm bg-red-100 text-red-700";
                }
                
                msgEl.classList.remove('hidden');
                setTimeout(() => {
                    if(state.scanner) state.scanner.resume();
                    msgEl.classList.add('hidden');
                }, 2500);
            });
        };

        window.stopScanner = () => {
            if(state.scanner) {
                state.scanner.clear().then(() => state.scanner = null);
            }
        };

        // --- CHART LOGIC (THE FIX) ---
        let charts = {}; // Store chart instances

        window.renderCharts = () => {
            // Pastikan elemen canvas ada
            const ctxOverview = document.getElementById('chartOverview');
            const ctxMarga = document.getElementById('chartMarga');
            const ctxStatus = document.getElementById('chartStatus');

            if (!ctxOverview || !ctxMarga || !ctxStatus) return;

            // Destroy old charts
            ['overview', 'marga', 'status'].forEach(k => {
                if (charts[k]) charts[k].destroy();
            });

            // 1. DATA PREPARATION (Hitung dari data Attendance yang masuk)
            // Kita ingin grafik berdasarkan "Yang Hadir"
            
            // Hitung Marga yang Hadir
            const margaCount = { 'Marga Manihuruk': 0, 'Boru': 0, 'Bere / Panagolan': 0 };
            // Hitung Status yang Hadir
            const statusCount = { 'Orangtua': 0, 'Pemuda': 0, 'Sekolah Minggu': 0, 'Tamu Undangan': 0, 'Pengurus Tupuan': 0 };

            state.attendance.forEach(att => {
                // Normalisasi string agar cocok dengan key object
                if (margaCount[att.marga] !== undefined) margaCount[att.marga]++;
                if (statusCount[att.status] !== undefined) statusCount[att.status]++;
            });

            // CHART 1: Overview (Bar Chart)
            charts['overview'] = new Chart(ctxOverview, {
                type: 'bar',
                data: {
                    labels: ['Terdaftar', 'Hadir', 'Ambil Kado'],
                    datasets: [{
                        label: 'Total',
                        data: [state.participants.length, state.attendance.length, state.gifts.length],
                        backgroundColor: ['#94a3b8', '#059669', '#f59e0b'],
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display: true, color: '#f1f5f9' } }, x: { grid: { display: false } } }
                }
            });

            // CHART 2: Marga (Pie Chart)
            charts['marga'] = new Chart(ctxMarga, {
                type: 'pie', // Pie chart lebih cocok untuk distribusi marga
                data: {
                    labels: Object.keys(margaCount),
                    datasets: [{
                        data: Object.values(margaCount),
                        backgroundColor: ['#064e3b', '#10b981', '#f59e0b'], // Dark Green, Light Green, Amber
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { font: { size: 11, family: "'Plus Jakarta Sans'" } } } 
                    }
                }
            });

            // CHART 3: Status (Bar Chart Horizontal)
            charts['status'] = new Chart(ctxStatus, {
                type: 'bar',
                data: {
                    labels: Object.keys(statusCount),
                    datasets: [{
                        label: 'Jemaat Hadir',
                        data: Object.values(statusCount),
                        backgroundColor: '#059669',
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        };

        // --- GLOBAL HELPERS ---
        window.closeModal = (id) => {
            document.getElementById(id).classList.add('hidden');
        };
        
        window.adminLogin = () => {
            document.getElementById('adminModal').classList.remove('hidden');
        };

        window.verifyAdmin = () => {
            if(document.getElementById('adminPassword').value === ADMIN_PASS) {
                state.isAdmin = true;
                alert("Login Admin Berhasil");
                closeModal('adminModal');
            } else {
                alert("PIN Salah");
            }
        };

        // Start App
        setTimeout(() => {
            setTab('register');
        }, 1500);

    </script>
</body>
</html>
