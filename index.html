        // --- ADMIN PANEL ---
        const renderAdmin = () => {
            const area = document.getElementById('content-area');
            if(!area) return;

            // Helper function to generate table rows
            const generateRows = () => {
                return state.participants
                    .filter(p => p.name.toLowerCase().includes(state.adminSearch.toLowerCase()) && (state.filterStatus==='Semua' || p.status===state.filterStatus))
                    .map(p => `<tr><td class="p-6"><div class="font-black text-slate-800 text-sm uppercase">${p.name}</div><div class="text-[9px] font-mono text-emerald-500 mt-1 font-bold">${p.qrCode}</div></td><td class="p-6"><span class="bg-slate-100 px-3 py-1 rounded-full font-black text-slate-500">${p.status}</span></td><td class="p-6 text-center flex justify-center gap-2">
                            <button onclick="window.adminEditPart('${p.firebaseId}')" class="text-blue-500 hover:text-blue-600 w-9 h-9 flex items-center justify-center bg-blue-50 rounded-xl shadow-sm border border-blue-100" title="Edit Data"><i class="fas fa-pen text-xs"></i></button>
                            <button onclick="window.adminResetPIN('${p.firebaseId}', '${p.name}')" class="text-amber-500 hover:text-amber-600 w-9 h-9 flex items-center justify-center bg-amber-50 rounded-xl shadow-sm border border-amber-100" title="Reset PIN"><i class="fas fa-key text-xs"></i></button>
                            <button onclick="window.adminDeletePart('${p.firebaseId}')" class="text-red-400 hover:text-red-600 w-9 h-9 flex items-center justify-center bg-red-50 rounded-xl shadow-sm border border-red-100" title="Hapus"><i class="fas fa-trash text-xs"></i></button>
                        </td></tr>`)
                    .join('');
            };

            // Capture focus state before re-rendering (untuk menangani update realtime dari firebase)
            const existingSearch = document.getElementById('admSearch');
            let cursorPosition = null;
            let isSearchFocused = false;
            
            if (existingSearch && document.activeElement === existingSearch) {
                isSearchFocused = true;
                cursorPosition = existingSearch.selectionStart;
            }

            area.innerHTML = `
                <div class="space-y-8 animate-[modalUp_0.5s]">
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl border border-slate-100">
                        <div class="flex flex-wrap justify-between items-center gap-5 mb-10">
                            <h3 class="text-xl font-black text-slate-800 flex items-center gap-3 tracking-tight uppercase royal-font"><i class="fas fa-crown text-emerald-600"></i> Admin Panel</h3>
                            <div class="flex flex-wrap gap-3">
                                <button id="btnExpAll" class="bg-amber-100 px-5 py-3 rounded-2xl text-amber-900 text-[10px] font-black uppercase tracking-widest shadow-md flex items-center gap-2 border border-amber-200">
                                    <i class="fas fa-file-export"></i> EKSPOR SEMUA DATA
                                </button>
                                <button id="btnExpPart" class="bg-emerald-50 px-5 py-3 rounded-2xl text-emerald-700 text-[10px] font-black uppercase tracking-widest shadow-sm">PENDAFTAR</button>
                                <button id="btnExpAtt" class="bg-emerald-50 px-5 py-3 rounded-2xl text-emerald-700 text-[10px] font-black uppercase tracking-widest shadow-sm">ABSENSI</button>
                                <button id="btnExpGift" class="bg-emerald-50 px-5 py-3 rounded-2xl text-emerald-700 text-[10px] font-black uppercase tracking-widest shadow-sm">BERKAT</button>
                                <button id="btnResetAll" class="bg-red-50 px-5 py-3 rounded-2xl text-red-700 text-[10px] font-black uppercase tracking-widest shadow-sm">RESET SISTEM</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-10"><div class="relative"><input type="text" id="admSearch" value="${state.adminSearch}" placeholder="CARI PESERTA..." class="form-input w-full rounded-2xl py-4 px-12 text-xs font-black uppercase"><i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-300"></i></div><select id="admFilter" class="form-input rounded-2xl px-5 py-4 text-xs font-black bg-slate-50 border-slate-200"><option value="Semua">SEMUA KATEGORI</option><option value="Orangtua" ${state.filterStatus==='Orangtua'?'selected':''}>ORANGTUA</option><option value="Pemuda" ${state.filterStatus==='Pemuda'?'selected':''}>PEMUDA</option><option value="Sekolah Minggu" ${state.filterStatus==='Sekolah Minggu'?'selected':''}>SEKOLAH MINGGU</option><option value="Tamu" ${state.filterStatus==='Tamu'?'selected':''}>TAMU</option></select></div>
                        <div class="overflow-x-auto rounded-3xl border border-slate-100 mb-12"><table class="w-full text-left text-[11px]"><thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest border-b border-slate-100"><tr><th class="p-6">Informasi</th><th class="p-6">Kategori</th><th class="p-6 text-center">Aksi</th></tr></thead><tbody id="admTableBody" class="divide-y divide-slate-50">${generateRows()}</tbody></table></div>
                        <div class="border-t border-slate-100 pt-12"><div class="flex items-center gap-3 mb-8"><div class="w-10 h-10 bg-slate-900 text-white rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-users-gear"></i></div><h4 class="text-xs font-black text-slate-800 uppercase tracking-widest">Manajemen Staff</h4></div><div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-8"><div class="md:col-span-5"><input id="stfName" type="text" placeholder="NAMA LENGKAP" class="form-input w-full rounded-2xl p-4 text-[11px] font-black uppercase shadow-inner"></div><div class="md:col-span-3"><input id="stfPin" type="password" maxlength="6" placeholder="PIN (6 DIG)" class="form-input w-full rounded-2xl p-4 text-[11px] font-black text-center shadow-inner"></div><div class="md:col-span-4"><button id="btnAddStaff" class="w-full h-full bg-slate-900 text-white rounded-2xl font-black text-[11px] uppercase tracking-widest hover:bg-black transition-all shadow-xl py-4 md:py-0">TAMBAH</button></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${state.staff.map(s => `<div class="bg-slate-50 p-5 rounded-[1.5rem] border border-slate-100 flex justify-between items-center shadow-sm"><div><div class="font-black text-slate-800 text-[11px] uppercase tracking-wide">${s.name}</div><div class="text-[9px] text-emerald-600 font-black uppercase mt-1 bg-emerald-50 px-2 py-0.5 rounded-full inline-block border border-emerald-100">PIN: ${s.pin}</div></div><button onclick="window.adminRemoveStaff('${s.firebaseId}')" class="text-red-400 hover:text-red-600 w-10 h-10 flex items-center justify-center bg-white rounded-xl shadow-inner border border-slate-100"><i class="fas fa-trash-can text-xs"></i></button></div>`).join('') || '<div class="col-span-full text-center py-10 text-slate-300 font-black text-[10px] uppercase">Belum Ada Petugas</div>'}</div></div>
                    </div>
                </div>
            `;
            
            // Restore Focus & Cursor
            if (isSearchFocused) {
                 const newSearch = document.getElementById('admSearch');
                 if(newSearch) {
                     newSearch.focus();
                     newSearch.setSelectionRange(cursorPosition, cursorPosition);
                 }
            }

            const searchIn = document.getElementById('admSearch');
            const filterIn = document.getElementById('admFilter');
            const staffAdd = document.getElementById('btnAddStaff');
            const expAllBtn = document.getElementById('btnExpAll');
            const expBtn = document.getElementById('btnExpPart');
            const expAttBtn = document.getElementById('btnExpAtt');
            const expGiftBtn = document.getElementById('btnExpGift');
            const resetBtn = document.getElementById('btnResetAll');
            
            if(searchIn) searchIn.onkeyup = (e) => { 
                state.adminSearch = e.target.value; 
                // UPDATE HANYA TBODY, JANGAN RENDER ULANG SEMUA
                const tbody = document.getElementById('admTableBody');
                if(tbody) tbody.innerHTML = generateRows();
            };
            
            if(filterIn) filterIn.onchange = (e) => { 
                state.filterStatus = e.target.value; 
                const tbody = document.getElementById('admTableBody');
                if(tbody) tbody.innerHTML = generateRows();
            };
            
            if(staffAdd) staffAdd.onclick = handleAddStaff;
            
            if(expAllBtn) expAllBtn.onclick = () => {
                if(!state.participants.length && !state.attendance.length && !state.gifts.length) {
                    return alert("Tidak ada data untuk diekspor.");
                }
                exportToCSV(state.participants, "01_Data_Pendaftar_Lengkap");
                setTimeout(() => exportToCSV(state.attendance, "02_Data_Absensi_Hadir"), 500);
                setTimeout(() => exportToCSV(state.gifts, "03_Data_Penerima_Berkat"), 1000);
                showToast("Ekspor Massal", "Ketiga file sedang diunduh secara berurutan.");
            };

            if(expBtn) expBtn.onclick = () => exportToCSV(state.participants, "Pendaftar");
            if(expAttBtn) expAttBtn.onclick = () => exportToCSV(state.attendance, "Absensi_Kehadiran");
            if(expGiftBtn) expGiftBtn.onclick = () => exportToCSV(state.gifts, "Berkat_Diterima");
            
            if(resetBtn) resetBtn.onclick = () => { if (confirm("Ketik 'RESET' untuk menghapus data?")) { const v = prompt("Ketik RESET:"); if (v === 'RESET') { Promise.all([set(ref(db, 'participants'), null), set(ref(db, 'attendance'), null), set(ref(db, 'gifts'), null)]).then(() => alert("Bersih!")); } } };
        };
