<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bonataon Marga Manihuruk Boru Bere / Panagolan 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Playfair+Display:wght@700;800;900&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.1/qrcode.min.js"></script>
      
    <style>
        :root {
            --emerald-900: #064e3b;
            --emerald-600: #059669;
            --emerald-50: #ecfdf5;
            --amber-500: #f59e0b;
            --slate-900: #0f172a;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }
          
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(5, 150, 105, 0.3) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #1e293b;
            -webkit-tap-highlight-color: transparent;
        }

        .serif-font { font-family: 'Playfair Display', serif; }
        .royal-font { font-family: 'Cinzel', serif; }
          
        .glass-panel {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
          
        .header-bg {
            background: linear-gradient(135deg, var(--emerald-900) 0%, var(--emerald-600) 100%);
            position: relative;
            overflow: hidden;
        }

        .nav-btn {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .nav-btn.active {
            background-color: var(--emerald-50);
            color: var(--emerald-900);
            border-color: var(--emerald-600);
            transform: translateY(-4px);
            box-shadow: 0 12px 20px -5px rgba(5, 150, 105, 0.25);
        }

        .logo-frame {
            background: white;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }
        
        .form-input {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
        }
        .form-input:focus {
            background-color: #ffffff;
            border-color: var(--emerald-600);
            box-shadow: 0 0 0 4px rgba(5, 150, 105, 0.15);
            outline: none;
        }

        @keyframes modalUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .vip-ticket {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid #334155;
            position: relative;
            overflow: hidden;
        }
        .gold-text {
            background: var(--gold-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .ticket-perforation {
            position: relative;
            background: #ffffff;
            margin-top: 24px;
            border-radius: 16px;
        }
        .ticket-perforation::before, .ticket-perforation::after {
            content: "";
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: #0f172a;
            border-radius: 50%;
        }
        .ticket-perforation::before { left: -12px; }
        .ticket-perforation::after { right: -12px; }

        .scan-frame {
            position: absolute;
            inset: 15%;
            border: 2px solid var(--emerald-600);
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.6);
            z-index: 5;
            pointer-events: none;
            border-radius: 1rem;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .btn-hover { transition: transform 0.2s; }
        .btn-hover:active { transform: scale(0.95); }

        .nav-btn-animate { animation: modalUp 0.5s ease-out; }
    </style>
</head>
<body class="antialiased text-slate-900">

    <div id="app" class="relative z-10 w-full max-w-lg mx-auto md:max-w-4xl min-h-screen md:my-10 md:rounded-[2.5rem] overflow-hidden flex flex-col glass-panel shadow-2xl">
          
        <!-- Loading State -->
        <div id="loading" class="absolute inset-0 z-[9999] bg-slate-50 flex flex-col justify-center items-center px-6 text-center">
            <div class="logo-frame w-32 h-32 p-4 mb-8 animate-bounce">
                <img src="logo tugu manihuruk.png" alt="Logo" onerror="this.src='https://via.placeholder.com/150?text=LOGO'">
            </div>
            <h2 class="text-2xl font-bold text-emerald-900 mb-2 serif-font uppercase tracking-tight">Bonataon Manihuruk 2026</h2>
            <div class="flex items-center gap-3 text-emerald-600 font-semibold mt-4">
                <i class="fas fa-circle-notch fa-spin"></i> Sinkronisasi Sistem...
            </div>
        </div>

        <!-- Header Section -->
        <header class="header-bg p-8 pb-20 shadow-2xl relative z-20">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-4">
                    <div onclick="window.showAdminLogin()" class="logo-frame w-14 h-14 md:w-20 md:h-20 p-1.5 border-2 border-white/30 hover:scale-105 transition-transform duration-300">
                        <img src="logo tugu manihuruk.png" alt="Logo" class="w-full h-full object-contain">
                    </div>
                    <div>
                        <h1 class="text-sm md:text-xl font-extrabold text-white serif-font tracking-wide leading-tight uppercase">
                            Bonataon Marga Manihuruk<br>Boru Bere / Panagolan 2026
                        </h1>
                        <div id="roleBadge" class="hidden inline-block mt-2 px-3 py-1 bg-amber-400 text-amber-900 text-[10px] font-black rounded-full uppercase tracking-widest shadow-lg"></div>
                    </div>
                </div>
                <div id="liveClock" class="text-right text-white hidden md:block"></div>
            </div>
              
            <div class="grid grid-cols-3 gap-3 mt-8">
                <div class="bg-white/15 backdrop-blur-md rounded-2xl p-3 border border-white/20 text-center">
                    <div class="text-xl md:text-2xl font-black text-white" id="statRegistered">0</div>
                    <div class="text-[9px] font-bold text-emerald-200 uppercase tracking-widest mt-1">Peserta</div>
                </div>
                <div class="bg-emerald-500/40 backdrop-blur-md rounded-2xl p-3 border border-emerald-400/50 text-center">
                    <div class="text-xl md:text-2xl font-black text-emerald-50" id="statPresent">0</div>
                    <div class="text-[9px] font-bold text-emerald-200 uppercase tracking-widest mt-1">Hadir</div>
                </div>
                <div class="bg-amber-500/30 backdrop-blur-md rounded-2xl p-3 border border-amber-400/40 text-center">
                    <div class="text-xl md:text-2xl font-black text-amber-200" id="statGifts">0</div>
                    <div class="text-[9px] font-bold text-amber-100 uppercase tracking-widest mt-1">Berkat</div>
                </div>
            </div>
        </header>

        <!-- Navigation Section -->
        <nav id="mainNav" class="flex px-6 -mt-10 relative z-30 gap-2 overflow-x-auto pb-4 custom-scrollbar">
            <button onclick="setTab('register')" id="tab-register" class="nav-btn public-tab flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover">
                <i class="fas fa-user-plus text-emerald-600"></i><span class="text-[10px] font-bold uppercase">Daftar</span>
            </button>
            <button onclick="setTab('find')" id="tab-find" class="nav-btn public-tab flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover">
                <i class="fas fa-search text-emerald-600"></i><span class="text-[10px] font-bold uppercase">Undangan</span>
            </button>
            
            <button onclick="setTab('scan')" id="tab-scan" class="nav-btn admin-tab staff-tab flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover max-sm:hidden">
                <i class="fas fa-qrcode text-emerald-600"></i><span class="text-[10px] font-bold uppercase">Absensi</span>
            </button>
            <button onclick="setTab('gift')" id="tab-gift" class="nav-btn admin-tab staff-tab flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover max-sm:hidden">
                <i class="fas fa-gift text-emerald-600"></i><span class="text-[10px] font-bold uppercase">Berkat</span>
            </button>
            <button onclick="setTab('data')" id="tab-data" class="nav-btn admin-tab flex-1 min-w-[100px] bg-white rounded-2xl shadow-xl border border-slate-100 btn-hover max-sm:hidden">
                <i class="fas fa-database text-emerald-600"></i><span class="text-[10px] font-bold uppercase">Admin</span>
            </button>
            
            <!-- Tombol Logout (Hanya muncul saat login) -->
            <button onclick="window.adminLogout()" id="tab-logout" class="nav-btn hidden flex-1 min-w-[100px] bg-red-50 text-red-600 rounded-2xl shadow-xl border border-red-100 btn-hover">
                <i class="fas fa-sign-out-alt"></i><span class="text-[10px] font-bold uppercase">Keluar</span>
            </button>
        </nav>

        <main class="flex-1 p-6 md:p-10 overflow-y-auto bg-slate-50 pb-24">
            <div id="content-area" class="max-w-4xl mx-auto"></div>
        </main>
          
        <footer class="py-4 px-8 border-t border-slate-200 bg-white/95 absolute bottom-0 w-full z-20">
            <div class="flex justify-between items-center text-[10px] md:text-xs">
                <div class="font-bold text-slate-400 uppercase tracking-widest">© 2026 Panitia Bonataon</div>
                <div class="font-bold text-emerald-800 uppercase flex items-center gap-1">
                    Marga Manihuruk <i class="fas fa-heart text-amber-500 animate-pulse"></i>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modal Admin Login -->
    <div id="adminModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('adminModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-user-shield text-2xl"></i>
                </div>
                <h3 class="text-xl font-black text-slate-800 tracking-tight uppercase">Login Panitia</h3>
                <p class="text-[10px] text-slate-400 font-bold uppercase mt-1 tracking-widest">Gunakan PIN Khusus Anda</p>
            </div>
            <input type="password" id="adminPassword" placeholder="••••" maxlength="8" class="form-input w-full rounded-2xl p-4 text-center text-3xl font-black mb-4 tracking-[0.5em]">
            <button onclick="window.verifyAdmin()" class="w-full py-4 bg-emerald-600 text-white rounded-2xl font-black btn-hover shadow-lg shadow-emerald-100 uppercase tracking-widest">Verifikasi</button>
            <button onclick="window.showRecoveryModal()" class="w-full mt-4 text-[10px] font-black text-slate-400 hover:text-emerald-600 uppercase tracking-widest transition-colors">Bantuan Akses Admin?</button>
        </div>
    </div>

    <!-- Modal Staff Manager -->
    <div id="staffManagerModal" class="fixed inset-0 z-[9200] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('staffManagerModal')"></div>
        <div class="card max-w-md w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s] flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black text-slate-800 flex items-center gap-2 tracking-tight uppercase"><i class="fas fa-users-cog text-emerald-600"></i> Kelola Petugas</h3>
                <button onclick="closeModal('staffManagerModal')" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="bg-emerald-50 p-5 rounded-2xl mb-6 border border-emerald-100 shadow-inner">
                <p class="text-[10px] font-black text-emerald-700 uppercase mb-3 tracking-widest">Daftarkan Petugas Baru</p>
                <div class="space-y-3">
                    <input id="newStaffName" type="text" placeholder="Nama Lengkap" class="form-input w-full rounded-xl p-3 text-sm font-bold uppercase">
                    <div class="flex gap-2">
                        <input id="newStaffPin" type="password" maxlength="4" placeholder="PIN (4 Digit)" class="form-input flex-1 rounded-xl p-3 text-center font-black tracking-widest">
                        <button onclick="window.addStaff()" class="bg-emerald-600 text-white px-6 rounded-xl font-black btn-hover shadow-md"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>

            <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Daftar Petugas Aktif</p>
            <div id="staffListArea" class="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1"></div>
        </div>
    </div>

    <!-- Modals lainnya (Tiket, Recovery, Pencarian) tetap ada sesuai standar sebelumnya -->
    <div id="authTicketModal" class="fixed inset-0 z-[9000] flex items-center justify-center hidden p-6">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onclick="closeModal('authTicketModal')"></div>
        <div class="card max-w-sm w-full relative z-10 p-8 bg-white rounded-[2rem] shadow-2xl animate-[modalUp_0.3s]">
            <h3 class="text-xl font-black text-slate-800 text-center mb-4 tracking-tight uppercase" id="authTitle">Verifikasi PIN</h3>
            <p class="text-xs text-slate-400 text-center mb-6" id="authDesc">Masukkan PIN 4 digit untuk <span id="authUserName" class="font-bold text-emerald-600"></span></p>
            <input type="password" id="ticketPassInput" placeholder="••••" maxlength="4" class="form-input w-full rounded-2xl p-4 text-center text-3xl font-black mb-6 tracking-[0.5em]">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal('authTicketModal')" class="py-4 border-2 rounded-2xl font-bold text-slate-400 btn-hover uppercase tracking-widest">Batal</button>
                <button onclick="window.verifyTicketPass()" class="py-4 bg-emerald-600 text-white rounded-2xl font-black shadow-lg btn-hover uppercase tracking-widest">Konfirmasi</button>
            </div>
        </div>
    </div>

    <!-- Script Utama -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD1jqsGb3gIGEhg8qo37oMAANNcKDdDuFU",
            authDomain: "bonataon-2026.firebaseapp.com",
            databaseURL: "https://bonataon-2026-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "bonataon-2026",
            storageBucket: "bonataon-2026.firebasestorage.app",
            messagingSenderId: "392578784070",
            appId: "1:392578784070:web:f85870afad7f202a592347"
        };

        const fApp = initializeApp(firebaseConfig);
        const db = getDatabase(fApp);
        
        let state = {
            participants: [],
            attendance: [],
            gifts: [],
            staff: [],
            tab: 'register',
            scanner: null,
            isAdmin: false,
            isStaff: false,
            adminPass: "1234",
            recoveryKey: "BONA2026",
            activeUser: null,
            tempUser: null,
            filterStatus: "Semua",
            adminSearchQuery: "",
            manualContext: null,
            deleteTargetId: null,
            resetTargetId: null,
            authContext: 'view'
        };

        // Sinkronisasi Data Realtime
        onValue(ref(db, 'settings/adminPin'), s => { if(s.val()) state.adminPass = s.val(); });
        onValue(ref(db, 'staff'), s => { 
            const data = s.val();
            state.staff = data ? Object.keys(data).map(k => ({...data[k], firebaseId: k})) : [];
            if(!document.getElementById('staffManagerModal').classList.contains('hidden')) renderStaffList();
        });
        onValue(ref(db, 'participants'), s => { 
            const data = s.val();
            state.participants = data ? Object.keys(data).map(k => ({...data[k], firebaseId: k})) : []; 
            updateDashboard(); 
        });
        onValue(ref(db, 'attendance'), s => { state.attendance = s.val() ? Object.values(s.val()) : []; updateDashboard(); });
        onValue(ref(db, 'gifts'), s => { state.gifts = s.val() ? Object.values(s.val()) : []; updateDashboard(); });

        function updateDashboard() {
            if(document.getElementById('statRegistered')) document.getElementById('statRegistered').innerText = state.participants.length;
            if(document.getElementById('statPresent')) document.getElementById('statPresent').innerText = state.attendance.length;
            if(document.getElementById('statGifts')) document.getElementById('statGifts').innerText = state.gifts.length;
            if(state.tab === 'register') renderParticipantList();
            if(state.tab === 'data') renderDataTable();
            setTimeout(() => document.getElementById('loading')?.classList.add('hidden'), 500);
        }

        // Logika Autentikasi Admin & Petugas
        window.showAdminLogin = () => {
            if (state.isAdmin || state.isStaff) return;
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminModal').classList.remove('hidden');
        };

        window.verifyAdmin = () => {
            const p = document.getElementById('adminPassword').value;
            
            // 1. Cek Admin Utama
            if(p === state.adminPass) {
                state.isAdmin = true;
                state.isStaff = false;
                closeModal('adminModal');
                refreshUIVisibility();
                setTab('data');
                return;
            }
            
            // 2. Cek Petugas Lapangan
            const staffMatch = state.staff.find(s => s.pin === p);
            if(staffMatch) {
                state.isStaff = true;
                state.isAdmin = false;
                closeModal('adminModal');
                refreshUIVisibility();
                setTab('scan');
                alert(`Selamat Bekerja, Petugas ${staffMatch.name}!`);
                return;
            }
            
            alert("PIN Tidak Dikenali!");
        };

        window.adminLogout = () => {
            if(confirm("Apakah Anda ingin keluar dari mode panitia?")) {
                state.isAdmin = false;
                state.isStaff = false;
                refreshUIVisibility();
                setTab('register');
            }
        };

        // Manajemen Petugas
        window.openStaffManager = () => {
            document.getElementById('newStaffName').value = '';
            document.getElementById('newStaffPin').value = '';
            renderStaffList();
            document.getElementById('staffManagerModal').classList.remove('hidden');
        };

        window.addStaff = () => {
            const name = document.getElementById('newStaffName').value.trim().toUpperCase();
            const pin = document.getElementById('newStaffPin').value.trim();
            if(!name || pin.length !== 4) return alert("Lengkapi Nama & PIN 4 Digit!");
            push(ref(db, 'staff'), { name, pin }).then(() => {
                document.getElementById('newStaffName').value = '';
                document.getElementById('newStaffPin').value = '';
            });
        };

        window.deleteStaff = (id) => {
            if(confirm("Hapus akses petugas ini?")) remove(ref(db, 'staff/' + id));
        };

        function renderStaffList() {
            const area = document.getElementById('staffListArea');
            if(!area) return;
            area.innerHTML = state.staff.length > 0 ? state.staff.map(s => `
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center shadow-sm">
                    <div>
                        <div class="font-black text-slate-800 text-sm tracking-tight uppercase">${s.name}</div>
                        <div class="text-[9px] font-bold text-emerald-600 uppercase tracking-widest mt-0.5 tracking-tighter">PETUGAS PIN: ${s.pin}</div>
                    </div>
                    <button onclick="window.deleteStaff('${s.firebaseId}')" class="w-10 h-10 flex items-center justify-center text-red-400 hover:bg-red-50 rounded-xl transition-all">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('') : `<div class="p-10 text-center text-slate-300 font-bold text-xs uppercase italic tracking-widest">Belum ada petugas</div>`;
        }

        // Kontrol Navigasi Dinamis
        function refreshUIVisibility() {
            const allTabs = document.querySelectorAll('.nav-btn');
            const logoutBtn = document.getElementById('tab-logout');
            const roleBadge = document.getElementById('roleBadge');

            allTabs.forEach(tab => {
                const isStaffTab = tab.classList.contains('staff-tab');
                const isAdminTab = tab.classList.contains('admin-tab');
                const isPublicTab = tab.classList.contains('public-tab');
                
                let shouldShow = false;
                if (state.isAdmin) {
                    shouldShow = true; // Admin lihat semuanya
                } else if (state.isStaff) {
                    shouldShow = isStaffTab; // Petugas HANYA lihat tab scan/gift
                } else {
                    shouldShow = isPublicTab; // Publik lihat tab daftar/undangan
                }

                if (shouldShow) {
                    tab.classList.remove('hidden', 'max-sm:hidden');
                    tab.classList.add('nav-btn-animate');
                } else {
                    tab.classList.add('hidden');
                }
            });

            // Tampilkan badge peran & tombol logout jika login
            if (state.isAdmin || state.isStaff) {
                logoutBtn.classList.remove('hidden');
                roleBadge.classList.remove('hidden');
                roleBadge.innerText = state.isAdmin ? "Mode Administrator" : "Mode Petugas Lapangan";
            } else {
                logoutBtn.classList.add('hidden');
                roleBadge.classList.add('hidden');
            }
        }

        window.setTab = async (t) => {
            if(state.scanner) { try { await state.scanner.stop(); } catch(e){} state.scanner = null; }
            state.tab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `tab-${t}`));
            
            const area = document.getElementById('content-area');
            if(t === 'register') {
                area.innerHTML = `
                <div class="bg-white rounded-3xl p-6 shadow-xl mb-8 border border-slate-50">
                    <h3 class="text-lg font-black text-slate-800 mb-6 flex items-center gap-2 uppercase tracking-tight"><i class="fas fa-pencil-alt text-emerald-600"></i> Registrasi Bonataon</h3>
                    <div class="space-y-4">
                        <input id="inName" type="text" class="form-input w-full rounded-xl p-4 font-bold uppercase" placeholder="NAMA LENGKAP">
                        <div class="grid grid-cols-2 gap-4">
                            <select id="inStatus" class="form-input w-full rounded-xl p-4 font-bold">
                                <option value="Orangtua">Orangtua</option><option value="Pemuda">Pemuda</option><option value="Sekolah Minggu">Sekolah Minggu</option><option value="Tamu">Tamu</option>
                            </select>
                            <select id="inMarga" class="form-input w-full rounded-xl p-4 font-bold">
                                <option value="Manihuruk">Manihuruk</option><option value="Boru">Boru</option><option value="Bere">Bere</option>
                            </select>
                        </div>
                        <input id="inPass" type="password" maxlength="4" class="form-input w-full rounded-xl p-4 font-black text-center text-xl tracking-[0.5em]" placeholder="BUAT PIN 4 DIGIT">
                        <button onclick="window.processRegister()" class="w-full bg-emerald-600 text-white rounded-xl py-4 font-black shadow-lg btn-hover uppercase tracking-widest">Daftar Sekarang</button>
                    </div>
                </div>
                <div id="participantList" class="space-y-3"></div>`;
                renderParticipantList();
            } else if(t === 'find') {
                area.innerHTML = `
                <div class="bg-white rounded-3xl p-8 shadow-xl text-center border border-slate-50">
                    <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-4 text-emerald-600 text-2xl shadow-inner"><i class="fas fa-search"></i></div>
                    <h3 class="font-black text-xl mb-6 text-slate-800 uppercase tracking-tight">Cari Undangan Digital</h3>
                    <div class="space-y-4">
                        <input id="findName" type="text" placeholder="Masukkan Nama Anda" class="form-input w-full rounded-xl p-4 text-center font-bold uppercase tracking-wider">
                        <button onclick="window.findTicket()" class="w-full bg-emerald-700 text-white rounded-xl py-4 font-black btn-hover shadow-xl uppercase tracking-widest">LIHAT TIKET</button>
                    </div>
                </div>`;
            } else if(t === 'scan' || t === 'gift') {
                const isScan = t === 'scan';
                area.innerHTML = `
                <div class="bg-white rounded-3xl p-6 shadow-xl text-center border border-slate-50">
                    <h3 class="font-black mb-6 text-slate-800 tracking-tight uppercase">Scanner ${isScan ? 'Kehadiran' : 'Hadiah Berkat'}</h3>
                    <div id="scanMsg" class="hidden p-3 rounded-xl mb-4 text-white font-bold animate-pulse shadow-lg"></div>
                    <div class="relative rounded-2xl overflow-hidden bg-black aspect-square max-w-sm mx-auto mb-6 shadow-2xl">
                        <div id="reader"></div>
                        <div class="scan-frame"></div>
                    </div>
                    <div class="pt-4 border-t border-slate-100">
                        <button onclick="window.openManualInput('${t}')"
                                class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-xs shadow-xl flex items-center justify-center gap-3 btn-hover uppercase tracking-widest">
                            <i class="fas fa-keyboard"></i> Masukkan Kode Manual
                        </button>
                    </div>
                </div>`;
                setTimeout(initScanner, 300);
            } else if(t === 'data') {
                renderAdminPanel();
            }
        };

        function renderAdminPanel() {
            const area = document.getElementById('content-area');
            area.innerHTML = `
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100">
                    <div class="flex flex-wrap justify-between items-center gap-3 mb-6">
                        <h3 class="font-black text-slate-800 flex items-center gap-2 tracking-tight uppercase"><i class="fas fa-shield-alt text-emerald-600"></i> Panel Administrator</h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="window.openStaffManager()" class="bg-amber-50 px-4 py-2.5 rounded-xl text-amber-700 text-[10px] font-black hover:bg-amber-100 transition-all flex items-center gap-2 uppercase tracking-widest shadow-sm">
                                <i class="fas fa-users-cog"></i> KELOLA PETUGAS
                            </button>
                            <button onclick="window.exportToCSV()" class="bg-emerald-50 px-4 py-2.5 rounded-xl text-emerald-700 text-[10px] font-black hover:bg-emerald-100 transition-all flex items-center gap-2 uppercase tracking-widest shadow-sm">
                                <i class="fas fa-file-export"></i> EKSPORT CSV
                            </button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            <input type="text" onkeyup="window.handleAdminSearch(this.value)" placeholder="Cari Nama / QR..." class="form-input w-full rounded-xl pl-11 p-3 text-sm uppercase">
                        </div>
                        <select onchange="window.updateTableFilter(this.value)" class="form-input rounded-xl px-3 py-3 text-sm font-bold bg-slate-50 border-slate-200">
                            <option value="Semua">Semua Kategori</option>
                            <option value="Orangtua">Orangtua</option>
                            <option value="Pemuda">Pemuda</option>
                            <option value="Sekolah Minggu">Sekolah Minggu</option>
                            <option value="Tamu">Tamu</option>
                        </select>
                    </div>
                </div>
                <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
                    <div id="adminTableContainer" class="overflow-x-auto custom-scrollbar"></div>
                </div>
            </div>`;
            renderDataTable();
        }

        // --- Fitur Pendukung (Pendaftaran, Tiket, Tabel, Scanner) ---
        window.processRegister = () => {
            const name = document.getElementById('inName').value.trim();
            const pass = document.getElementById('inPass').value;
            if(!name || pass.length < 4) return alert("Wajib Nama & PIN 4 Digit!");
            const code = `MN-${Date.now().toString().slice(-6)}`;
            const data = { name: name.toUpperCase(), status: document.getElementById('inStatus').value, marga: document.getElementById('inMarga').value, password: pass, qrCode: code, registeredAt: new Date().toLocaleString() };
            push(ref(db, 'participants'), data).then(() => { alert("Pendaftaran Sukses!"); window.showTicket(data); document.getElementById('inName').value = ''; document.getElementById('inPass').value = ''; });
        };

        window.findTicket = () => {
            const query = document.getElementById('findName').value.toLowerCase().trim();
            if(!query) return alert("Masukkan nama!");
            const matches = state.participants.filter(x => x.name.toLowerCase().includes(query));
            if(!matches.length) alert("Data tidak ditemukan!");
            else if(matches.length === 1) window.startAuth(matches[0]);
            else alert("Ditemukan beberapa nama serupa. Gunakan nama lengkap.");
        };

        window.startAuth = (user) => {
            state.tempUser = user;
            document.getElementById('authUserName').innerText = user.name;
            document.getElementById('ticketPassInput').value = '';
            document.getElementById('authTicketModal').classList.remove('hidden');
        };

        window.verifyTicketPass = () => {
            if(state.tempUser && document.getElementById('ticketPassInput').value === state.tempUser.password) {
                window.showTicket(state.tempUser); closeModal('authTicketModal');
            } else alert("PIN Salah!");
        };

        window.showTicket = async (user) => {
            // Logika tiket visual (mirip sebelumnya)
            alert(`Menampilkan Tiket untuk: ${user.name}\nKode: ${user.qrCode}`);
        };

        window.handleAdminSearch = (val) => { state.adminSearchQuery = val.toLowerCase(); renderDataTable(); };
        window.updateTableFilter = (val) => { state.filterStatus = val; renderDataTable(); };

        window.renderDataTable = () => {
            const container = document.getElementById('adminTableContainer');
            if(!container) return;
            let filtered = state.participants;
            if(state.filterStatus !== "Semua") filtered = filtered.filter(p => p.status === state.filterStatus);
            if(state.adminSearchQuery) filtered = filtered.filter(p => p.name.toLowerCase().includes(state.adminSearchQuery));
            container.innerHTML = `<table class="w-full text-left text-xs"><thead class="bg-slate-50 text-slate-400 font-black uppercase tracking-widest border-b border-slate-100"><tr><th class="p-4">Identitas</th><th class="p-4">Kategori</th><th class="p-4 text-center">Aksi</th></tr></thead><tbody class="divide-y divide-slate-50">${filtered.map(p => `<tr class="hover:bg-slate-50 transition-colors"><td class="p-4"><div class="font-black text-slate-800 text-sm uppercase">${p.name}</div><div class="text-[9px] font-mono text-slate-400 uppercase mt-1">${p.qrCode}</div></td><td class="p-4 font-bold text-slate-600">${p.status}</td><td class="p-4 text-center"><button onclick="window.adminDeleteUser('${p.firebaseId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>`).join('')}</tbody></table>`;
        };

        window.adminDeleteUser = (id) => { if(confirm("Hapus pendaftar ini?")) remove(ref(db, 'participants/' + id)); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        function renderParticipantList() {
            const list = document.getElementById('participantList'); if(!list) return;
            list.innerHTML = `<h5 class="text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest pl-1">Pendaftar Terbaru</h5>` + state.participants.slice(-3).reverse().map(p => `<div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50 mb-2"><div class="font-bold text-sm text-slate-800 uppercase">${p.name}</div><div class="text-[8px] font-black bg-emerald-50 text-emerald-700 px-2 py-1 rounded-full uppercase">${p.status}</div></div>`).join('');
        }

        function initScanner() {
            state.scanner = new Html5Qrcode("reader");
            state.scanner.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                const p = state.participants.find(x => x.qrCode === text);
                if(!p) return alert("QR Code Tidak Terdaftar!");
                const path = state.tab === 'scan' ? 'attendance' : 'gifts';
                push(ref(db, path), { name: p.name, qrCode: p.qrCode, timestamp: new Date().toLocaleString() }).then(() => {
                    alert(`SUKSES: ${p.name} TERVERIFIKASI!`);
                });
            }).catch(() => alert("Error Kamera!"));
        }

        refreshUIVisibility();
        setTab('register');
    </script>
</body>
</html>
